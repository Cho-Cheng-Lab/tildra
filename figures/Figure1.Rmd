---
title: "Figrue 1"
author: "David Wu"
---

Set working directory to project directory
```{r setup}
require(knitr)
opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- 'figures' # analysis file output directory
data_dir <- 'data/derived/tildra' # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(patchwork)
library(rcartocolor)
library(extrafont)
```

```{r}
seuratobj <- read_rds(file.path(data_dir, 'seuratobj_annotated.rds'))
seuratobj
```

### Figure 1A
#### Global
```{r}
h <- 3
w <- 3
dpi <- 600
```

#### UMAP of points only (PNG)
```{r fig.height=4, fig.width=4, dpi=300}
p <- seurat_feature(seuratobj, features = 'cluster', facet_hide = TRUE, legend_position = 'none', label = FALSE) +
  theme(text = element_text(family = 'Arial'))

ggsave(plot = p,
       path = output_dir,
       height = h,
       width = w,
       dpi = dpi,
       filename = 'F1A_points.png') 

p
```
#### UMAP of labels only
```{r}
p <- seurat_feature(seuratobj, features = 'cluster', facet_hide = TRUE, legend_position = 'none', label = TRUE, drop_points = TRUE, label_color = c('black', NA)) +
  theme(text = element_text(family = 'Arial'))

ggsave(plot = p,
       path = output_dir,
       height = h,
       width = w,
       dpi = dpi,
       filename = 'F1A_labels.pdf') 

p
```
```{r}
DimPlot(seuratobj, group.by = 'cluster', label = TRUE)
```

#### F1A legend
```{r fig.height = 4, fig.width=4}
p <- seurat_feature(seuratobj, features = 'label', facet_hide = TRUE, legend_position = 'right', label = FALSE) +
  theme(text = element_text(family = 'Arial'))

ggsave(plot = p,
       path = output_dir,
       height = h,
       width = w,
       dpi = dpi,
       filename = 'F1A_legend.pdf') 

p
```
### Figure 1B, Dot Plot
#### Reynolds et al markers

```{r}
markers_reynolds <- c('KRT14', 'KRT5', 
                      'GATA3', 'KRTDAP',
                      'CRYAB', 'TYRP1',
                      'DKK3', 'PLEKHA4',
                      'LUM', 'APOD',
                      'PHLDA2', 'CCL2',
                      'IL6', 'PDGFRA',
                      'COL1A1', 'CXCL12',
                      'CD82', 'CCL19', 'KCNE4', 'CPE', 'TAGLN', 'MYL9', 'HEY1', 'CCL14', 'PECAM1',
                      'ACKR1', 'SELE', 'SNCG', 'HES1', 'MMRN1', 'XCL1' ,'XCL2', 'KLRC1', 'CCL5', 'GZMA', 
                      'CD8A', 'CD8B', 'IL7R', 'FOXP3', 'TIGIT', 'TPSB2', 'TPSAB1', 'CD79A', 'JCHAIN', 'CD163',
                      'C1QB', 'FCGR2A', 'MS4A6A', 'IL23A', 'CLEC9A', 'CLEC10A', 'CD1C', 'CD207', 'CD1A', 
                      'CD14', 'IL1B', 'CCR7', 'IDO1')

main_markers <- c("CD3D",
                  "CCR7",
                  "SELL",
                  "KLF2","CD69","ITGAE","CXCR6","CD4","TIGIT","FOXP3",
                  "IL2RA","CTLA4","CD8A","CD8B","GZMB","PDCD1","LAG3","KLRB1","PRF1","KLRD1","GNLY",
                  "TNFRSF18","PRDM1","BATF","TRAT1","RORA","GATA3","PTGDR2",
                  "IL7R", "HLA-DRA","HLA-DRB1",
                  "CD83","IDO1","CD207","EPCAM","CD68","C1QB","C1QC","CD163","CLEC10A","CD1C",
                  "THBD","XCR1","SIRPA","F13A1","IGKC","JCHAIN","CD79A","MS4A1","NR4A1","NR4A2","KLF4",
                  "CEBPB","LYZ","MS4A7","SERPINA1","CD14","S100A9","IL23A","TPSB2","TPSAB1","MKI67","TOP2A",
                  "ITGA4","NCR1","IL17A","IL17F","IL23R")
```

```{r}
Idents(seuratobj) <- 'rashx_merge'
```

#### F1B dot plot horizontal
```{r}
p <- DotPlot(seuratobj, 
             features = main_markers[1],
             cluster.idents = TRUE,
             #cols = c('dodgerblue3', 'orangered'), 
             #cols = viridis::viridis(n = 2, option = 'C'),
             dot.min = 0.1,
             dot.scale = 4, 
             scale = FALSE) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, face = 'italic'))

ggsave(plot = p,
       path = output_dir,
       height = 6,
       width = 12,
       dpi = 300,
       filename = 'F1B.pdf') 

p
```
```{r}
p <- DotPlot(seuratobj, 
             features = main_markers, 
             cluster.idents = TRUE,
             #cols = c('dodgerblue3', 'orangered'), 
             cols = viridis::viridis(n = 2, option = 'C'),
             dot.min = 0.1,
             dot.scale = 4, 
             scale = FALSE) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.text.y = element_text(face = 'italic')) +
  coord_flip()

ggsave(plot = p,
       path = output_dir,
       height = 12,
       width = 9,
       dpi = 600,
       filename = 'F1B_vertical.pdf') 

p
```

### Figure 1C
```{r}
seuratobj$condition <- factor(seuratobj$condition, levels = c('HC', 'PV'))
seuratobj$treatment <- factor(seuratobj$treatment, levels = c('None', 'Pre', 'Mid'))
```


```{r}
color_palette5 <- rcartocolor::carto_pal(n = 5, name = 'Bold')
unit_height <- 2.2
unit_width <- 2
```


```{r}
p <- seurat_feature(seuratobj, features = 'condition', facets = 'condition', label = FALSE, color_package = 'custom', color_palette = color_palette5[5:3], legend_position = 'none', axis_title_position = 'none')

ggsave(plot = p,
       path = output_dir,
       height = unit_height,
       width = unit_width * 3,
       dpi = 600,
       filename = 'F1C_condition.png') 

p
```
```{r}
p <- seurat_feature(seuratobj, features = 'treatment', facets = 'treatment', label = FALSE, nrow = 1, color_package = 'custom', color_palette = color_palette5[c(5,1,2)], legend_position = 'none', axis_title_position = 'none')

ggsave(plot = p,
       path = output_dir,
       height = unit_height,
       width = unit_width * 3,
       dpi = 600,
       filename = 'F1C_treatment.png') 

p
```


### Figure 1D
```{r}
meta <- seuratobj@meta.data %>% rownames_to_column()
```
### Cluster size and % 
```{r}
tallies <- meta %>% 
  group_by(merged_label) %>% 
  tally() %>% 
  mutate(total = sum(n),
         f = n/total,
         pct = round(100 * f, 2))
  
tallies
```

### Proportion of cells in each cluster
```{r}
analyze <- meta %>% 
  select(rowname, id, patient, sample, condition, treatment, cluster, merged_label, response_group) %>% 
  mutate(description = factor(paste(condition, treatment) %>% str_remove(' None'),
                              levels = c('PV Pre',
                                         'PV Mid',
                                         'PV',
                                         'AD',
                                         'HC')))

analyze %>% head()
```

```{r}
plot_input <- analyze %>% 
  group_by(description, cluster, merged_label) %>% 
  tally() %>% 
  group_by(merged_label) %>% 
  mutate(total = sum(n),
         fraction = n/total)

plot_input
```

```{r}
p <- plot_input %>% 
  ggplot(aes(x = merged_label,
             y = fraction,
             fill = description)) +
  geom_bar(stat = 'identity',
           position = 'stack') +
  coord_flip() +
  rcartocolor::scale_fill_carto_d(palette = 'Bold') +
  labs(x = '',
       y = 'Proportion') +
  theme_dwu(legend.position = 'top')

ggsave(plot = p,
       filename = 'F1D_bar_percentages.pdf',
       path = output_dir,
       h = 6,
       w = 8)

p
```
### Wide
```{r}
p <- plot_input %>% 
  ggplot(aes(x = merged_label,
             y = fraction * 100,
             fill = description)) +
  geom_bar(stat = 'identity',
           position = 'stack') +
  rcartocolor::scale_fill_carto_d(palette = 'Bold') +
  labs(x = '',
       y = '% of Cluster') +
  theme_dwu(legend.position = 'top') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave(plot = p,
       filename = 'F1D_bar_percentages_wide.pdf',
       path = output_dir,
       h = 4,
       w = 8)

p
```
#### Patient-centric version
```{r}
plot_input <- analyze %>% 
  filter(description %in% c('PV Pre', 'PV Mid')) %>% 
  group_by(sample, patient, description, cluster, merged_label, treatment, response_group) %>% 
  tally() %>% 
  group_by(sample) %>% 
  mutate(total = sum(n),
         fraction = n/total)

plot_input

```
```{r}
patient_info <- plot_input %>% select(sample, patient, description, response_group) %>% unique() %>% arrange(patient, description)
text_color <- ifelse(patient_info$response_group == 'Responder', 'dodgerblue4', 'orangered')
```


```{r}
p <- plot_input %>% 
  ggplot(aes(x = sample,
             y = fraction * 100,
             fill = merged_label)) +
  geom_bar(stat = 'identity',
           position = 'stack') +
  #rcartocolor::scale_fill_carto_d(palette = 'Bold') +
  labs(x = '',
       y = '% of Cells') +
  theme_dwu(legend.position = 'top') +
  coord_flip() +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, color = text_color))
  theme(axis.text.y = element_text(angle = 0, hjust = 1, color = text_color))

ggsave(plot = p,
       filename = 'F1D_bar_patient_centric_f.pdf',
       path = output_dir,
       h = 4,
       w = 8)

p
```
```{r}
p <- plot_input %>% 
  ggplot(aes(x = sample,
             y = n,
             fill = merged_label)) +
  geom_bar(stat = 'identity',
           position = 'stack') +
  #rcartocolor::scale_fill_carto_d(palette = 'Bold') +
  labs(x = '',
       y = '# of Cells') +
  theme_dwu(legend.position = 'top') +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, color = text_color))

ggsave(plot = p,
       filename = 'F1D_bar_patient_centric_n.pdf',
       path = output_dir,
       h = 4,
       w = 8)

p
```

## Session Info
```{r}
sessionInfo()
```



