---
title: "Figrue 2"
author: "David Wu"
---

### Use the here package for robust relative paths
```{r}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- here('figures') # analysis file output directory
data_dir <- here('data/derived/tildra') # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(ggthemes)
library(ggforce)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(rcartocolor)
library(ggrepel)
library(extrafont)
loadfonts()
theme_set(theme_dwu()) # set default theme
source(here('figures/colors.R')) # consistent color palettes

```

### Import
```{r}
seuratobj <- read_rds(here(data_dir, 'seuratobj_annotated.rds'))
seuratobj
```
### Use global or local identities and set as cluster/supercluster in the object
```{r}
which_identity <- 'local'
which_cluster <- paste0(which_identity, '_cluster')
which_supercluster <- paste0(which_identity, '_supercluster')

seuratobj$cluster <- seuratobj[[which_cluster]] # set cluster as main annotation
seuratobj$supercluster <- seuratobj[[which_supercluster]] # set cluster as main annotation
Idents(seuratobj) <- 'cluster'

output_dir <- here(output_dir, which_identity)
dir.create(output_dir)
```



### Analysis
```{r}
metadata <- seuratobj@meta.data %>% rownames_to_column() 
de_combined_cluster <- read_tsv(here('analysis/output/08_de/', which_cluster, 'de_combined.tsv.gz'))
de_combined_supercluster <- read_tsv(here('analysis/output/08_de/', which_supercluster, 'de_combined.tsv.gz'))
```

```{r}
patient_meta <- metadata %>% 
  select(id, patient, treatment, condition, response, group, patient_label) %>% 
  unique() %>% 
  pivot_wider(names_from = treatment,
              values_from = id) %>% 
  arrange(patient_label)

patient_meta
```
```{r}
analyze <- metadata %>% 
  select(rowname, id, sample, patient, condition, treatment, cluster, supercluster, sample_label, group) %>% 
  mutate(description = factor(paste(condition, treatment) %>% str_remove(' None'),
                              levels = c('PV Pre',
                                         'PV Mid',
                                         'PV',
                                         'AD',
                                         'HC'))) %>% 
  left_join(patient_meta %>% select(patient, patient_label))

analyze

```


```{r}
tallies <- analyze %>% 
  group_by(patient, condition, treatment, cluster, supercluster) %>% 
  tally()

tallies %>%
  filter(condition == 'PV',
         treatment != 'None') %>% 
  pivot_wider(names_from = treatment,
              values_from = n)
```


#### Global
```{r}
h <- 3
w <- 3
dpi <- 600

which_comparison <- c('PV vs HC',
                      'Pre vs Mid',
                      'Responder Pre vs Responder Mid',
                      'Non-responder Pre vs Non-responder Mid',
                      'Responder Pre vs Non-responder Pre',
                      'Responder Mid vs Non-responder Mid')

p_adj_cutoff <- 0.05

cluster_levels <- seuratobj$cluster

de_subset <- de_combined_cluster %>% 
  filter(comparison %in% which_comparison) %>% 
  mutate(comparison = factor(comparison, levels = which_comparison),
         sig = ifelse(p_val_adj < p_adj_cutoff, TRUE, FALSE),
         cluster = factor(cluster, levels = levels(seuratobj$cluster)))
```

### Figure 2A
#### How many DE genes?
#### Facet

```{r}
p <- de_subset %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  mutate(comparison = factor(comparison, levels = which_comparison)) %>% 
  group_by(cluster, comparison) %>% 
  tally() %>% 
  ggplot(aes(x = cluster,
             y = n,
             fill = comparison)) +
  geom_col(color = 'black') +
  facet_wrap(~comparison, scales = 'free_y', nrow = 3) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(x = '',
       y = '# of DEGs') +
  scale_fill_carto_d(drop = FALSE) +
  scale_x_discrete(drop = FALSE)

ggsave(plot = p,
       filename = 'F2A_de_tally.pdf',
       path = output_dir, 
       h = 8,
       w = 8)
p
```
```{r}

```

```{r}
p <- de_subset %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  mutate(comparison = factor(comparison, levels = which_comparison)) %>% 
  filter(comparison %in% c('Pre vs Mid',
                           'Responder Mid vs Non-responder Mid')) %>% 
  group_by(cluster, comparison) %>% 
  tally() %>% 
  ggplot(aes(x = cluster,
             y = n,
             fill = comparison)) +
  geom_col(color = 'black') +
  facet_wrap(~comparison, scales = 'free_y', nrow = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_discrete(drop = FALSE) +
  ggthemes::scale_fill_few(drop = FALSE) +
  labs(x = '',
       y = '# of DEGs')  
  

ggsave(plot = p,
       filename = 'F2A_de_tally_subset.pdf',
       path = output_dir, 
       h = 3,
       w = 7)
p
```
#### Up and down DEGs

```{r}
plot_input <- de_subset %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  mutate(comparison = factor(comparison, levels = which_comparison),
         direction = ifelse(avg_log2FC > 0, 'up', 'down')) %>% 
  filter(comparison %in% c('Responder Pre vs Responder Mid',
                           'Non-responder Pre vs Non-responder Mid')) %>% 
  group_by(cluster, comparison, direction) %>% 
  tally() %>% 
  mutate(n = ifelse(direction == 'up', -n, n)) 

max_limit <- max(abs(plot_input$n))
  

p <- plot_input %>% 
  ggplot(aes(y = factor(cluster, levels = rev(levels(cluster))),
             x = n,
             fill = comparison)) +
  geom_col(color = 'black') +
  geom_vline(xintercept = 0) +
  facet_wrap(~comparison, 
             #scales = 'free_x', 
             nrow = 1) +
  scale_x_continuous(limits = c(-max_limit, max_limit),
                     breaks = c(-500, 0, 500),
                     labels = c('500 \n(Higher in Pre)', 0, '500 \n(Higher in Mid)')) + 
  scale_y_discrete(drop = FALSE) +
  ggthemes::scale_fill_few(drop = FALSE) +
  labs(x = '# of DEGs',
       y = '')  

p
```


#### P6 excluded
```{r}
de_filtered <- read_tsv(here('analysis/output/08_de/', which_cluster, 'de_pre_vs_mid_responder_filtered.tsv.gz'))

p <- bind_rows(de_subset %>% 
            filter(comparison %in% c('Responder Pre vs Responder Mid')) %>% 
            mutate(comparison = 'All Patients'),
          de_filtered %>% mutate(comparison = 'Excluding P6')) %>% 
  mutate(cluster = factor(cluster, levels = levels(seuratobj$cluster))) %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  group_by(cluster, comparison) %>% 
  tally() %>% 
  ggplot(aes(x = cluster,
             y = n,
             fill = comparison)) +
  geom_col(color = 'black') +
  facet_wrap(~comparison) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_discrete(drop = FALSE) +
  ggthemes::scale_fill_few(drop = FALSE) +
  labs(x = '',
       y = '# of DEGs')  

p
```


#### DEG per cluster
```{r}
de_filtered %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  group_by(cluster, n_group1, n_group2) %>% 
  tally() %>% 
  ggplot(aes(x = n_group1 + n_group2,
             y = n)) +
  geom_point() +
  geom_text_repel(aes(label = cluster)) +
  labs(x = '# of Cells in DE comparison',
       y = '# of DEGs')
```
```{r}
p <- de_subset %>% 
  filter(comparison %in% c('Responder Pre vs Responder Mid',
                           'Non-responder Pre vs Non-responder Mid')) %>% 
  mutate(display = ifelse(str_detect(comparison, 'Non'), 'Non-responder', 'Responder')) %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  group_by(cluster, display, n_group1, n_group2) %>% 
  tally() %>% 
  ggplot(aes(x = n_group1 + n_group2,
             y = n,
             label = display)) +
  facet_wrap(~cluster, scales = 'free') +
  geom_point() +
  geom_text_repel() +
  labs(x = '# of Cells in DE comparison',
       y = '# of DEGs')

p
```
### Heatmaps
```{r}
heatmap_genes <- de_combined_supercluster %>% 
  filter(comparison %in% c('PV vs HC',
                           'Responder Pre vs Responder Mid')) %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  group_by(gene, comparison) %>% 
  tally() %>% 
  pivot_wider(names_from = comparison,
              values_from = n,
              values_fill = 0) %>% 
  mutate(both = ifelse(`PV vs HC` * `Responder Pre vs Responder Mid` > 1, TRUE, FALSE),
         total = `PV vs HC` + `Responder Pre vs Responder Mid`) %>% 
  filter(total > 20, both) %>% 
  arrange(-total)

heatmap_genes
```
```{r}
heatmap_genes <- de_combined_supercluster %>% 
  filter(comparison %in% c('PV vs HC')) %>% 
  filter(p_val_adj < p_adj_cutoff) %>% 
  group_by(cluster) %>% 
  slice_max(abs(avg_log2FC), n = 20)

heatmap_genes
```

### heatmap of log fold-changes
```{r}
heatmap_genes
```

```{r}
which_cluster <- 'Trm1'
de_choice <- de_combined_cluster %>% 
  filter(cluster == which_cluster,
         comparison %in% c('PV vs HC',
                           'Responder Pre vs Responder Mid'),
         gene %in% heatmap_genes$gene)

pheatmap_input <- de_choice %>% 
  select(comparison, gene, avg_log2FC) %>% 
  pivot_wider(names_from = comparison,
              values_from = avg_log2FC) %>% 
  column_to_rownames('gene') %>% 
  drop_na()
pheatmap_input
```
```{r}
pheatmap(pheatmap_input, 
         cluster_cols = FALSE, 
         scale = 'none', 
         angle_col = 0)
```

```{r}
library(pheatmap)
heatmap_cells <- seuratobj@meta.data %>% filter(condition != 'AD') %>% rownames()
heatmap_data <- pseudobulk(seuratobj,
                           cells = heatmap_cells,
                           genes = heatmap_genes$gene %>% unique(),
                           group_by = c('supercluster', 'condition', 'treatment', 'group'))

# heatmap_matrix <- pseudobulk_matrix(seuratobj, 
#                                     cells = heatmap_cells,
#                                     group_by = c('cluster', 'condition', 'treatment', 'group'))

heatmap_data %>% head()
```

```{r}
which_cluster <- 'Trm'

map(heatmap_genes$cluster %>% unique, function(which_cluster) {
  
  cluster_genes <- heatmap_genes %>% filter(cluster == which_cluster) %>% pull(gene) %>% unique()
  
  heatmap_subset <- heatmap_data %>% 
    filter(supercluster == which_cluster,
           gene %in% cluster_genes) %>% 
    mutate(description = paste(condition, group, treatment)) %>% 
    mutate(description = description %>% str_remove(' NA None') %>% str_remove('PV ')) %>% 
    filter(description %in% c('HC', 'PV', 'Responder Mid')) %>% 
    select(gene, description, cpm) %>% 
    pivot_wider(names_from = description,
                values_from = cpm) %>% 
    mutate(PV = log2(PV / HC),
           Mid = log2(`Responder Mid` / HC)) %>% 
    select(gene, PV, Mid) %>% 
    arrange(-PV) %>% 
    column_to_rownames('gene')
  
  pheatmap_input <- heatmap_subset
  
  pheatmap(pheatmap_input,
           colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, name = "RdBu")))(100),
           breaks = seq(-3, 3, length.out = 101),
           #scale = 'row',
           cluster_cols = FALSE,
           cluster_rows = FALSE,
           angle_col = 0,
           display_numbers = TRUE,
           main = which_cluster)
  
  
  
})



```

```{r}
which_cluster <- 'Trm'

plot_clusters <- c('Trm', 'Tcm', 'eTreg', 'LC', 'Mono')

p <- map(plot_clusters %>% unique, function(which_cluster) {
  
  cluster_genes <- heatmap_genes %>% filter(cluster == which_cluster) %>% pull(gene) %>% unique()
  
  heatmap_subset <- heatmap_data %>% 
    filter(supercluster == which_cluster,
           gene %in% cluster_genes) %>% 
    mutate(description = paste(condition, group, treatment)) %>% 
    mutate(description = description %>% str_remove(' NA None') %>% str_remove('PV ')) %>% 
    filter(description %in% c('HC', 'PV', 'Responder Mid')) %>% 
    select(gene, description, cpm) %>% 
    pivot_wider(names_from = description,
                values_from = cpm) %>% 
    mutate(PV = log2(PV / HC),
           Mid = log2(`Responder Mid` / HC)) %>% 
    select(gene, PV, Mid) %>% 
    pivot_longer(cols = -gene,
                 names_to = 'condition',
                 values_to = 'value') %>% 
    arrange(-value)
  
  heatmap_subset %>% 
    ggplot(aes(x = factor(condition, levels = c('PV', 'Mid')),
               y = reorder(gene, value),
               fill = value)) +
    geom_tile(color = 'black', linewidth = 0.25) +
    scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, name = "RdBu")))(100),
                         limits = c(-4, 4),
                         breaks = seq(-4, 4, length.out = 5),
                         oob = scales::squish,
                         guide = guide_colorbar(frame.colour = 'black', ticks = FALSE, nbin = 50)) +
    labs(x = '',
         y = '',
         title = which_cluster) +
    theme(legend.position = 'top',
          axis.ticks = element_blank(),
          plot.background = element_rect(color = 'white', fill = 'white'),
          panel.border = element_rect(color = NA),
          axis.line = element_blank())
  
  

}) %>% patchwork::wrap_plots(nrow = 1)
```


### Figure 2B
#### Volcano PV vs HC
```{r}
which_cluster <- str_subset(de_subset$cluster, 'Trm') %>% unique() %>% sort() %>% head(1)

de_subset %>% 
  filter(cluster == which_cluster) %>% 
  ggplot(aes(x = avg_log2FC,
             y = -log10(p_val_adj),
             color = sig,
             label = gene)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~comparison, scales = 'free_y') +
  scale_color_manual(values = c('grey50', 'darkorchid4')) +
  geom_text_repel(data = de_subset %>% filter(cluster == which_cluster) %>% group_by(comparison) %>% top_n(10, abs(avg_log2FC)), box.padding = 0.5) +
  labs(x = 'log2 fold-change',
       y = '-log10 adj. p-value')
  
```
### Figure 2C
What is corrected by treatment?

Import gene sets
```{r}
genesets <- read_tsv(here('analysis/output/msigdb/il23_il17_gene_sets.tsv'))
```

```{r}
response_genes <- de_combined_cluster %>% 
  filter(comparison == 'Responder Pre vs Responder Mid') %>% 
  filter(p_val_adj < p_adj_cutoff,
         avg_log2FC > 0) %>% 
  top_n(10, wt = abs(avg_log2FC)) %>% 
  pull(gene) %>% 
  c('IL17A', 'IL17F', 'CXCL13')

response_genes
```
### Extract expression
```{r}
genes_to_extract <- genesets$gene_symbol %>% unique()

metadata_subset <- metadata %>% 
  filter(group == 'Responder' | condition == 'HC',
         cluster == which_cluster) %>% 
  mutate(treatment = ifelse(treatment == 'None', 'Healthy', as.character(treatment)),
         treatment = factor(treatment, levels = c('Pre', 'Mid', 'Healthy')))

barcodes <- metadata_subset$rowname

exprs <- FetchData(seuratobj, 
                   cells = barcodes,
                   vars = genes_to_extract) %>% 
  rownames_to_column() %>% 
  as_tibble()

exprs

```

```{r}
merged_table <- exprs %>% 
  inner_join(metadata_subset %>% select(rowname, patient, id, condition, treatment, response, group, cluster)) %>% 
  pivot_longer(cols = genes_to_extract,
               names_to = 'gene',
               values_to = 'expression')

merged_table
```
```{r}
p <- merged_table %>% 
  ggplot(aes(x = treatment,
             y = expression,
             color = treatment)) +
  geom_boxplot(outlier.shape = NA) +
  #geom_sina(alpha = 0.1, size = 0.5) 
  facet_wrap(~gene, scales = 'free_y') +
  scale_color_carto_d() +
  theme(legend.position = 'top')

p
```

```{r}
summarized_table <- merged_table %>% 
  group_by(treatment, group, cluster, gene) %>% 
  summarize(mean = mean(expression),
            sd = sd(expression))

summarized_table %>% head()
```



```{r}
p <- summarized_table %>% 
   ggplot(aes(x = treatment,
              y = mean,
              fill = treatment)) +
  geom_col(color = 'black') +
  facet_wrap(~gene, scales = 'free_y') +
  scale_fill_carto_d() +
  #theme(legend.position = 'top') +
  labs(x = '',
       y = 'Average Expression in Trm Cells')

p
```
### Biocarta
```{r}
p <- summarized_table %>% 
  filter(cluster == 'Trm1',
         gene %in% (genesets %>% filter(gs_name == 'BIOCARTA_IL17_PATHWAY') %>% pull(gene_symbol))) %>% 
   ggplot(aes(x = treatment,
              y = mean,
              fill = treatment)) +
  geom_col(color = 'black') +
  facet_wrap(~gene, scales = 'free_y') +
  scale_fill_carto_d() +
  #theme(legend.position = 'top') +
  labs(x = '',
       y = 'Average Expression in Trm Cells',
       title = 'Biocarta IL17 Pathway')

p
```
### Wikipathway
```{r}
p <- summarized_table %>% 
  filter(cluster == 'Trm1',
         gene %in% (genesets %>% filter(gs_name == 'WP_IL17_SIGNALING_PATHWAY') %>% pull(gene_symbol))) %>% 
   ggplot(aes(x = treatment,
              y = mean,
              fill = treatment)) +
  geom_col(color = 'black') +
  facet_wrap(~gene, scales = 'free_y') +
  scale_fill_carto_d() +
  #theme(legend.position = 'top') +
  labs(x = '',
       y = 'Average Expression in Trm Cells',
       title = 'Wikipathway IL17 Signaling Pathway')

p
```
### PID
```{r}
p <- summarized_table %>% 
  filter(cluster == 'Trm1',
         gene %in% (genesets %>% filter(gs_name == 'PID_IL23_PATHWAY') %>% pull(gene_symbol))) %>% 
   ggplot(aes(x = treatment,
              y = mean,
              fill = treatment)) +
  geom_col(color = 'black') +
  facet_wrap(~gene, scales = 'free_y') +
  scale_fill_carto_d() +
  #theme(legend.position = 'top') +
  labs(x = '',
       y = 'Average Expression in Trm Cells',
       title = 'Pathway Interaction Database IL23 Pathway')

p
```

```{r}
shared_pathway_genes <- genesets %>% 
  select(gs_name, gene_symbol) %>% 
  unique() %>% 
  group_by(gene_symbol) %>% 
  tally() 
```

```{r}
p <- summarized_table %>% 
  filter(gene %in% (shared_pathway_genes %>% filter(n > 1) %>% pull(gene_symbol))) %>% 
   ggplot(aes(x = treatment,
              y = mean,
              fill = treatment)) +
  geom_col(color = 'black') +
  facet_wrap(~gene, scales = 'free_y') +
  scale_fill_carto_d() +
  #theme(legend.position = 'top') +
  labs(x = '',
       y = 'Average Expression in Trm Cells',
       title = 'Il23/IL17 Robust Gene Set')

p
```

### clusterProfiler
```{r}

```

```{r}
summarized_table %>% 
  filter(treatment != 'Healthy') %>% 
  ggplot(aes(x = reorder(gene, -mean),
             y = mean,
             color = treatment,
             group = gene)) +
  geom_point(size = 3) +
  geom_line(color = 'grey50', arrow = arrow(length = unit(0.2, "cm"), type = 'closed')) +
  theme_dwu(legend.position = 'right') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  #geom_point(size = 2, data = summarized_table %>% filter(treatment == 'Healthy'), inherit.aes = FALSE, aes(x = reorder(gene, -mean), y = mean)) +
  labs(x = '',
       y = 'Average Trm Expression')
```
### Waterfall

```{r}
ray_genes <- c("IL17F", "GNLY", "LRRN3", "MGAT4A", "CHN1", "CTSH", "PTPN13", "GZMB", "ADGRG1", "SOX4", "GABPB1-AS1", "SNX9", "CD7", "CPM", "CTLA4", "ODF2L", "CBLB", "LAYN", "TNFAIP3", "ARHGEF12", "H1FX", "HIST1H1E", "YPEL2", "GBP5", "DAPK2", "RAP1B", "CXCL13", "FYN")

genes_to_extract <- ray_genes

metadata_subset <- analyze %>% 
  filter(group %in% c('Responder', 'Non-responder') | condition == 'HC',
         cluster == which_cluster) %>% 
  mutate(treatment = ifelse(treatment == 'None', 'Healthy', as.character(treatment)),
         treatment = factor(treatment, levels = c('Pre', 'Mid', 'Healthy')))



barcodes <- metadata_subset$rowname
exprs <- FetchData(seuratobj, 
                   cells = barcodes,
                   vars = genes_to_extract) %>% 
  rownames_to_column() %>% 
  as_tibble()

exprs




```

```{r}
merged_table <- exprs %>% 
  inner_join(metadata_subset %>% select(rowname, patient, id, condition, treatment, group, cluster, patient_label)) %>% 
  pivot_longer(cols = genes_to_extract,
               names_to = 'gene',
               values_to = 'expression')

merged_table
```


```{r}
p <- merged_table %>% 
  filter(group == 'Responder' | treatment == 'Healthy') %>% 
  ggplot(aes(x = treatment,
             y = expression,
             fill = treatment)) +
  geom_boxplot(outlier.shape = NA, color = 'black', alpha = 0.8) +
  #geom_sina(alpha = 0.1, size = 0.5) 
  facet_wrap(~gene, scales = 'free_y') +
  #scale_color_carto_d() +
  scale_fill_manual(values = c('orangered', 'dodgerblue4', 'grey80')) +
  theme(legend.position = 'top') +
  labs(x = '',
       y = 'Average Trm Expression')

p
```
```{r}
summarized_table <- merged_table %>% 
  filter(group != 'Non-responder') %>% 
  group_by(treatment, group, cluster, gene) %>% 
  summarize(mean = mean(expression),
            median = median(expression),
            sd = sd(expression))
```

```{r}
plot_input <- merged_table %>% 
  group_by(patient, treatment, group, cluster, gene, patient_label) %>% 
  summarize(mean = mean(expression)) 

p <- plot_input %>% 
  filter(treatment != 'Healthy') %>% 
  ggplot(aes(x = reorder(gene, -mean),
             y = mean,
             color = treatment,
             group = gene)) +
  geom_point(size = 3) +
  geom_line(color = 'grey50', arrow = arrow(length = unit(0.2, "cm"), type = 'closed')) +
  theme_dwu(legend.position = 'right') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_wrap(~patient_label, scales = 'free_y', ncol = 4) +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  geom_point(size = 2,
             data = plot_input %>% filter(treatment == 'Healthy') %>%
               group_by(gene) %>%
               summarize(mean = mean(mean)),
             inherit.aes = FALSE,
             aes(x = reorder(gene, -mean), y = mean),
             shape = 1) +
  labs(x = '',
       y = 'Average Trm Expression')

ggsave(plot = p,
       path = output_dir,
       filename = 'F3_waterfall.pdf',
       h = 6,
       w = 16)

p
```


```{r}
summarized_table %>% 
  filter(treatment != 'Healthy') %>% 
  ggplot(aes(x = reorder(gene, -mean),
             y = mean,
             color = treatment,
             group = gene)) +
  geom_point(size = 3) +
  geom_line(color = 'grey50', arrow = arrow(length = unit(0.2, "cm"), type = 'closed')) +
  theme_dwu(legend.position = 'right') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  geom_point(size = 2, 
             data = summarized_table %>% filter(treatment == 'Healthy'), 
             inherit.aes = FALSE, 
             aes(x = reorder(gene, -mean), y = mean),
             shape = 1
             ) +
  labs(x = '',
       y = 'Average Trm Expression')
```


```{r}
p <- summarized_table %>% 
  ggplot(aes(x = treatment,
              y = mean,
              fill = treatment)) +
  geom_bar(stat = 'identity', color = 'black', alpha = 0.8) + 
  facet_wrap(~gene, scales = 'free_y') +
  scale_color_carto_d() +
  #theme(legend.position = 'top') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4', 'grey80')) +
  labs(x = '',
       y = 'Average Expression in Trm Cells')

p
  
```


### Figure
Top genes from PV vs HC
```{r}
pv_vs_hc <- de_combined_cluster %>% 
  filter(comparison == 'PV vs HC')

pv_vs_hc
```

```{r}
top_pv_vs_hc <- pv_vs_hc %>% 
  filter(avg_log2FC > 0,
         cluster == which_cluster) %>% 
  top_n(10, pct.diff) %>%
  pull(gene)

top_pv_vs_hc
```


#### Which genes normalize?
```{r}
de_normalize <- de_combined_cluster %>% 
  filter(comparison %in% c('PV vs HC', 'Pre vs Mid'),
         cluster == which_cluster) %>% 
  select(comparison, gene, avg_log2FC, pct.1, pct.2, pct.diff, p_val_adj) %>% 
  pivot_wider(names_from = comparison,
              values_from = avg_log2FC:p_val_adj) %>% 
  mutate(avg_log2FC = ifelse(`avg_log2FC_PV vs HC` * `avg_log2FC_Pre vs Mid` > 0, TRUE, FALSE))

de_normalize
```

```{r}
de_normalize %>% 
  filter(avg_log2FC)
```



### Extract expression
```{r}
genes_to_extract <- de_normalize$gene

metadata_subset <- metadata %>% 
  filter(group == 'Responder' | condition == 'HC',
         cluster == which_cluster) %>% 
  mutate(treatment = ifelse(treatment == 'None', 'Healthy', as.character(treatment)),
         treatment = factor(treatment, levels = c('Pre', 'Mid', 'Healthy')))

barcodes <- metadata_subset$rowname
exprs <- FetchData(seuratobj, 
                   cells = barcodes,
                   vars = genes_to_extract) %>% 
  rownames_to_column() %>% 
  as_tibble()

exprs

```

```{r}
merged_table <- exprs %>% 
  inner_join(metadata_subset %>% select(rowname, patient, id, condition, treatment, response, group, cluster)) %>% 
  pivot_longer(cols = genes_to_extract,
               names_to = 'gene',
               values_to = 'expression')

merged_table
```
```{r}
summarized_table <- merged_table %>% 
  group_by(patient, treatment, group, cluster, gene) %>% 
  summarize(median = median(expression),
            mean = mean(expression),
            sd = sd(expression))

summarized_table
```

```{r}
summarized_table %>% 
  filter(gene %in% genes_to_extract[1:20]) %>% 
   ggplot(aes(x = treatment,
              y = mean,
              color = treatment)) +
  geom_bar(stat = 'summary', color = 'black', fill = 'white', fun = 'mean') + 
  geom_sina() +
  facet_wrap(~gene, scales = 'free_y') +
  scale_color_carto_d() +
  #theme(legend.position = 'top') +
  labs(x = '',
       y = 'Average Expression in Trm Cells')
```



## Session Info
```{r}
sessionInfo()
```



