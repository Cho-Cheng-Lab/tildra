---
title: "Figrue 2"
author: "David Wu"
---

### Use the here package for robust relative paths
```{r}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
figures_dir <- here('figures/figure2') # analysis file output directory
data_dir <- here('data/derived/tildra') # data file output directory

dir.create(figures_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(patchwork)
library(ggthemes)
library(ggforce)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(rcartocolor)
library(ggrepel)
library(extrafont)
loadfonts()
theme_set(theme_dwu()) # set default theme
source(here('figures/colors.R')) # consistent color palettes

```

### Functions
```{r}
library(openxlsx)
write_excel_notebook <- function(input_table, 
                                 output_file, 
                                 tabs = 'cluster', 
                                 prefix = 'cluster_') {
  OUT <- createWorkbook()
  
  input_table$tabs <- input_table[[tabs]]
  tabs <- input_table[[tabs]] %>% unique()
  
  
  for(i in tabs){
    tryCatch({
      table_subset <- input_table %>% filter(tabs == i) %>% select(-tabs)
      
      sheet_name <- paste0(prefix, i) %>% str_remove('[\\?/]') %>% str_remove('[\\/]') %>% str_remove('[\\:/]') 
      addWorksheet(OUT, sheet_name)
      writeData(OUT, sheet = sheet_name, x = table_subset)
      
    }, error=function(e){message(paste0("We have an error here in ", i))})
  }
  
  saveWorkbook(OUT, output_file, overwrite = TRUE)
}
```

### Import
```{r}
seuratobj <- read_rds(here(data_dir, 'seuratobj_annotated.rds'))
metadata <- seuratobj@meta.data %>% rownames_to_column()
seuratobj
```
### Use global or local identities and set as cluster/supercluster in the object
```{r}
which_identity <- 'local'
which_cluster <- paste0(which_identity, '_cluster')
which_supercluster <- paste0(which_identity, '_supercluster')
which_ultracluster <- paste0(which_identity, '_ultracluster')
which_annotation <- which_supercluster

seuratobj$cluster <- seuratobj[[which_cluster]] 
seuratobj$supercluster <- seuratobj[[which_supercluster]] 
seuratobj$ultracluster <- seuratobj[[which_ultracluster]] 
Idents(seuratobj) <- 'cluster' # set cluster as main annotation

output_dir <- here(figures_dir, which_identity)
dir.create(output_dir)
```
### Patient metadata
```{r}
metadata_patient <- metadata %>% 
  select(id, sample, patient, treatment, group) %>% 
  filter(treatment != 'None') %>% 
  unique() %>% 
  droplevels()

metadata_patient
```
### DE genes per patient
```{r}
de_patient_vs_hc <- read_tsv(here('analysis/output/08_de', which_annotation, 'de_patient_vs_hc.tsv.gz'))
```



### Analysis


### Cluster size and % 
```{r}
analyze <- metadata %>% 
  select(rowname, id, patient, sample, condition, treatment, cluster, supercluster, ultracluster, group, celltype) 

analyze %>% head()
```
```{r}
cluster_tallies <- analyze %>% 
  group_by(sample, patient, condition, cluster, celltype, treatment, group) %>% 
  tally() %>% 
  group_by(sample) %>% 
  mutate(total = sum(n),
         f = n/total,
         pct = round(100 * f, 2))

supercluster_tallies <- analyze %>% 
  group_by(sample, patient, condition, supercluster, celltype, treatment, group) %>% 
  tally() %>% 
  group_by(sample) %>% 
  mutate(total = sum(n),
         f = n/total,
         pct = round(100 * f, 2))

ultracluster_tallies <- analyze %>% 
  group_by(sample, patient, condition, ultracluster, celltype, treatment, group) %>% 
  tally() %>% 
  group_by(sample) %>% 
  mutate(total = sum(n),
         f = n/total,
         pct = round(100 * f, 2))

cluster_tallies
```
#### DE tally
```{r}
de_sample_tally <- de_patient_vs_hc %>% 
  filter(p_val_adj < 0.01) %>% 
  group_by(sample, cluster) %>% 
  tally()

de_sample_tally
```


#### Major celltypes

```{r}
four_colors <- carto_pal(n = 5, name = 'Bold')
  
conditions <- c('APC', 'Lymphocyte')

```

```{r}
celltype_input <- cluster_tallies %>% 
    filter(treatment %in% c('Pre', 'Mid')) %>% 
    group_by(patient, sample, treatment, total, celltype, group) %>% 
    summarize(n = sum(n)) %>% 
  rowwise() %>% 
  mutate(f = n/total, 
         pct = 100 * f)
  
```

#### Combined
```{r}
treatment_groups <- celltype_input %>% 
  ungroup() %>% 
  select(treatment, group) %>% 
  unique() %>% 
  arrange(group, treatment) %>% 
  mutate(treatment_group = paste(treatment, group, sep = ':'),
         treatment_group = factor(treatment_group, levels = treatment_group))
treatment_groups
```


```{r}
p <- celltype_input %>% 
  filter(celltype %in% c('APC', 'Lymphocyte')) %>% 
  bind_rows(cluster_tallies %>% 
              filter(treatment %in% c('Pre', 'Mid')) %>% 
              filter(str_detect(cluster, 'Trm')) %>% 
              mutate(celltype = cluster)) %>% 
  bind_rows(supercluster_tallies %>% 
              filter(treatment %in% c('Pre', 'Mid')) %>% 
              filter(str_detect(supercluster, 'Trm')) %>% 
              mutate(celltype = 'Trm all')) %>%
  select(sample, treatment, group, celltype, n, pct) %>% 
  pivot_longer(cols = c(n, pct),
               names_to = 'metric',
               values_to = 'value') %>% 
  left_join(treatment_groups) %>% 
ggplot(aes(x = treatment_group,
             y = value,
             fill = group)) +
  geom_boxplot() +
  labs(x = '',
       y = '# of Cells') +
  facet_wrap(~metric + celltype, scales = 'free_y', nrow = 2) +
  scale_fill_manual(values = colors_response2) +
  theme_dwu(legend.position = 'top') +
  scale_x_discrete(labels = c('Pre', 'Mid', 'Pre', 'Mid'))

ggsave(plot = p,
       device = cairo_pdf,
       filename = 'F2E_box_combined.pdf',
       path = output_dir,
       h = 5,
       w = 10)

p
```
#### All clusters, n
```{r}
p <- cluster_tallies %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  select(sample, treatment, group, cluster, n, pct) %>% 
  pivot_longer(cols = c(n, pct),
               names_to = 'metric',
               values_to = 'value') %>% 
  left_join(treatment_groups) %>% 
  filter(metric == 'n') %>% 
ggplot(aes(x = treatment_group,
             y = value,
             fill = group)) +
  geom_boxplot() +
  labs(x = '',
       y = '# of Cells') +
  facet_wrap(~cluster, scales = 'free_y') +
  scale_fill_manual(values = colors_response2) +
  theme_dwu(legend.position = 'top') +
  scale_x_discrete(labels = c('Pre', 'Mid', 'Pre', 'Mid'))

ggsave(plot = p,
       device = cairo_pdf,
       filename = 'F2E_box_all_clusters_n.pdf',
       path = output_dir,
       h = 8,
       w = 8)

p
```
#### All clusters, f
```{r}
p <- cluster_tallies %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  select(sample, treatment, group, cluster, n, pct) %>% 
  pivot_longer(cols = c(n, pct),
               names_to = 'metric',
               values_to = 'value') %>% 
  left_join(treatment_groups) %>% 
  filter(metric == 'pct') %>% 
ggplot(aes(x = treatment_group,
             y = value,
             fill = group)) +
  geom_boxplot() +
  labs(x = '',
       y = '% of Cells') +
  facet_wrap(~cluster, scales = 'free_y') +
  scale_fill_manual(values = colors_response2) +
  theme_dwu(legend.position = 'top') +
  scale_x_discrete(labels = c('Pre', 'Mid', 'Pre', 'Mid'))

ggsave(plot = p,
       device = cairo_pdf,
       filename = 'F2E_box_all_clusters_f.pdf',
       path = output_dir,
       h = 8,
       w = 8)

p
```

#### All superclusters, n
```{r}
p <- supercluster_tallies %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  select(sample, treatment, group, supercluster, n, pct) %>% 
  pivot_longer(cols = c(n, pct),
               names_to = 'metric',
               values_to = 'value') %>% 
  left_join(treatment_groups) %>% 
  filter(metric == 'n') %>% 
ggplot(aes(x = treatment_group,
             y = value,
             fill = group)) +
  geom_boxplot() +
  labs(x = '',
       y = '# of Cells') +
  facet_wrap(~supercluster, scales = 'free_y') +
  scale_fill_manual(values = colors_response2) +
  theme_dwu(legend.position = 'top') +
  scale_x_discrete(labels = c('Pre', 'Mid', 'Pre', 'Mid'))

ggsave(plot = p,
       device = cairo_pdf,
       filename = 'F2E_box_all_superclusters_n.pdf',
       path = output_dir,
       h = 8,
       w = 8)

p
```
#### All clusters, f
```{r}
p <- supercluster_tallies %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  select(sample, treatment, group, supercluster, n, pct) %>% 
  pivot_longer(cols = c(n, pct),
               names_to = 'metric',
               values_to = 'value') %>% 
  left_join(treatment_groups) %>% 
  filter(metric == 'pct') %>% 
ggplot(aes(x = treatment_group,
             y = value,
             fill = group)) +
  geom_boxplot() +
  labs(x = '',
       y = '% of Cells') +
  facet_wrap(~supercluster, scales = 'free_y') +
  scale_fill_manual(values = colors_response2) +
  theme_dwu(legend.position = 'top') +
  scale_x_discrete(labels = c('Pre', 'Mid', 'Pre', 'Mid'))

ggsave(plot = p,
       device = cairo_pdf,
       filename = 'F2E_box_all_superclusters_f.pdf',
       path = output_dir,
       h = 8,
       w = 8)

p
```


### Figure 2F
#### n
```{r}
p <- cluster_tallies %>% 
  filter(str_detect(cluster, 'Trm')) %>% 
  filter(!is.na(group)) %>% 
  select(sample, treatment, group, celltype, n, pct) %>% 
  pivot_longer(cols = c(n, pct),
               names_to = 'metric',
               values_to = 'value') %>% 
  ggplot(aes(x = sample,
             y = value,
             fill = group)) +
  geom_bar(stat = 'identity', color = 'black', alpha = 0.8) +
  labs(x = '',
       y = '') +
  theme_dwu(legend.position = 'top') +
  coord_flip() +
  facet_wrap(~metric, nrow = 1, scales = 'free_x') +
  scale_fill_manual(values = colors_response2) +
  scale_x_discrete(limits = rev)

ggsave(plot = p,
       device = cairo_pdf,
       filename = 'F2F_bar_patient_trm_combined.pdf',
       path = output_dir,
       h = 4,
       w = 4)

p
```
### Loop
```{r}
dir.create(here(output_dir, 'patient_bar_cluster'))

p_cluster <- map(levels(cluster_tallies$cluster), function(i) {
  
  
  p <- cluster_tallies %>% 
    mutate(sample = factor(sample, levels = str_subset(levels(sample), '-'))) %>% 
    filter(cluster == i) %>% 
    filter(!is.na(group)) %>% 
    select(sample, treatment, group, celltype, n, pct) %>% 
    pivot_longer(cols = c(n, pct),
                 names_to = 'metric',
                 values_to = 'value') %>% 
    ggplot(aes(x = sample,
               y = value,
               fill = group)) +
    geom_bar(stat = 'identity', color = 'black', alpha = 0.8) +
    labs(x = '',
         y = '') +
    theme_dwu(legend.position = 'top') +
    coord_flip() +
    facet_wrap(~metric, nrow = 1, scales = 'free_x') +
    scale_fill_manual(values = colors_response2) +
    scale_x_discrete(limits = rev, drop = FALSE) +
    ggtitle(i)
  
  
  ggsave(plot = p,
         device = cairo_pdf,
         filename = paste0('F2F_bar_patient_', str_replace(i, '/','+'),'.pdf'),
         path = here(output_dir, 'patient_bar_cluster'),
         h = 4,
         w = 4)
  
  p
  
}) %>% wrap_plots()

p_cluster
```

```{r}
dir.create(here(output_dir, 'patient_bar_supercluster_de'))

### with DE genes
p_supercluster <- map(levels(supercluster_tallies$supercluster), function(i) {
  
  print2(i)
  
  p <- supercluster_tallies %>% 
    filter(supercluster == i) %>% 
    filter(!is.na(group)) %>% 
    left_join(de_sample_tally %>% select(sample, supercluster = cluster, DEGs = n)) %>% 
    select(sample, treatment, group, Abundance = n, Proportion = pct, DEGs) %>% 
    pivot_longer(cols = c(Abundance, Proportion, DEGs),
                 names_to = 'metric',
                 values_to = 'value') %>% 
    mutate(metric = factor(metric, levels = c('Abundance', 'Proportion', 'DEGs')),
           sample = factor(sample, levels = metadata_patient$sample)) %>% 
    ggplot(aes(x = sample,
               y = value,
               fill = group)) +
    geom_bar(stat = 'identity', color = 'black', alpha = 0.8) +
    labs(x = '',
         y = '') +
    theme_dwu(legend.position = 'top') +
    coord_flip() +
    facet_wrap(~metric, nrow = 1, scales = 'free_x') +
    scale_fill_manual(values = colors_response2) +
    scale_x_discrete(limits = rev, drop = FALSE) +
    ggtitle(i)
  
  
  ggsave(plot = p,
         device = cairo_pdf,
         filename = paste0(str_replace(i, '/','+'),'.pdf'),
         path = here(output_dir, 'patient_bar_supercluster_de'),
         h = 4,
         w = 6)
  
  p
  
}) %>% wrap_plots()

### without DE genes
dir.create(here(output_dir, 'patient_bar_supercluster'))

p_supercluster <- map(levels(supercluster_tallies$supercluster), function(i) {
  
  print2(i)
  
  p <- supercluster_tallies %>% 
    filter(supercluster == i) %>% 
    filter(!is.na(group)) %>% 
    select(sample, treatment, group, Abundance = n, Proportion = pct) %>% 
    pivot_longer(cols = c(Abundance, Proportion),
                 names_to = 'metric',
                 values_to = 'value') %>% 
    mutate(metric = factor(metric, levels = c('Abundance', 'Proportion', 'DEGs')),
           sample = factor(sample, levels = metadata_patient$sample)) %>% 
    ggplot(aes(x = sample,
               y = value,
               fill = group)) +
    geom_bar(stat = 'identity', color = 'black', alpha = 0.8) +
    labs(x = '',
         y = '') +
    theme_dwu(legend.position = 'top') +
    coord_flip() +
    facet_wrap(~metric, nrow = 1, scales = 'free_x') +
    scale_fill_manual(values = colors_response2) +
    scale_x_discrete(limits = rev, drop = FALSE) +
    ggtitle(i)
  
  
  ggsave(plot = p,
         device = cairo_pdf,
         filename = paste0(str_replace(i, '/','+'),'.pdf'),
         path = here(output_dir, 'patient_bar_supercluster'),
         h = 4,
         w = 4)
  
  p
  
}) %>% wrap_plots()




```

```{r}
dir.create(here(output_dir, 'patient_bar_ultracluster'))

p_ultracluster <- map(levels(ultracluster_tallies$ultracluster), function(i) {
  
  print2(i)
  
  p <- ultracluster_tallies %>% 
    mutate(sample = factor(sample, levels = str_subset(levels(sample), '-'))) %>% 
    filter(ultracluster == i) %>% 
    filter(!is.na(group)) %>% 
    select(sample, treatment, group, celltype, n, pct) %>% 
    pivot_longer(cols = c(n, pct),
                 names_to = 'metric',
                 values_to = 'value') %>% 
    ggplot(aes(x = sample,
               y = value,
               fill = group)) +
    geom_bar(stat = 'identity', color = 'black', alpha = 0.8) +
    labs(x = '',
         y = '') +
    theme_dwu(legend.position = 'top') +
    coord_flip() +
    facet_wrap(~metric, nrow = 1, scales = 'free_x') +
    scale_fill_manual(values = colors_response2) +
    scale_x_discrete(limits = rev, drop = FALSE) +
    ggtitle(i)
  
  
  ggsave(plot = p,
         device = cairo_pdf,
         filename = paste0('F2F_bar_patient_', str_replace(i, '/','+'),'.pdf'),
         path = here(output_dir, 'patient_bar_ultracluster'),
         h = 4,
         w = 4)
  
  p
  
}) %>% wrap_plots()
```

### IL17 secreting cells
```{r}
il17 <- pseudobulk(seuratobj,
                   genes = c('IL17A', 'IL17F', 'IL26', 'IFNG'))

il17 %>% arrange(-cpm)
```
```{r}
il17 %>% 
  ggplot(aes(y = reorder(ident, cpm),
             x = cpm )) +
  geom_col() +
  facet_wrap(~gene) + 
  labs(x = 'Counts per Million',
       y = '') 
```

```{r}
il17 <- FetchData(seuratobj, vars = c('IL17A', 'IL17F', 'IL26', 'IFNG', 'id', 'supercluster')) %>% 
  rownames_to_column() %>% left_join(metadata_patient)

il17
```
```{r}
p <- il17 %>% 
  filter(treatment != 'Mid',
         supercluster == 'Trm') %>% 
  ggplot(aes(x = IL17A,
             y = IL17F)) +
  geom_point(alpha = 0.5) 

ggExtra::ggMarginal(p)
```

```{r}
p <- il17 %>% 
  filter(treatment != 'Mid',
         supercluster == 'Trm') %>% 
  ggplot(aes(x = IL26,
             y = IFNG)) +
  geom_point(alpha = 0.5) 

ggExtra::ggMarginal(p)
```


```{r}
il17 %>% 
  filter(treatment != 'None',
         supercluster == 'Trm',
         IL17A + IL17F + IL26 + IFNG > 0) 
```

```{r}
#dir.create(here(output_dir, 'patient_bar_t17'))

totals <- seuratobj@meta.data %>% group_by(sample) %>% tally(name = 'total')
p <- il17 %>% 
  filter(treatment != 'None',
         supercluster == 'Trm',
         IL17A + IL17F + IL26 + IFNG > 0)  %>% 
  left_join(totals) %>% 
  mutate(sample = factor(sample, levels = str_subset(levels(sample), '-'))) %>% 
  group_by(sample, treatment, group, total) %>% 
  tally() %>% 
  mutate(pct = 100 * n/total) %>% 
  select(sample, treatment, group, n, pct) %>%
  pivot_longer(cols = c(n, pct),
               names_to = 'metric',
               values_to = 'value') %>% 
  ggplot(aes(x = sample,
             y = value,
             fill = group)) +
  geom_bar(stat = 'identity', color = 'black', alpha = 0.8) +
  labs(x = '',
       y = '') +
    theme_dwu(legend.position = 'top') +
    coord_flip() +
    facet_wrap(~metric, nrow = 1, scales = 'free_x') +
    scale_fill_manual(values = colors_response2) +
    scale_x_discrete(limits = rev, drop = FALSE) +
    ggtitle('IL17 Secreting Cells')
  
  
  ggsave(plot = p,
         device = cairo_pdf,
         path = here(output_dir, 'patient_bar_supercluster'),
         filename = 'il17.pdf',
         h = 4,
         w = 4)
  
  p
  

```

