---
title: "Subclustering"
author: "David Wu"
---

### Use the here package for robust relative paths
```{r}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- here('analysis/output/05_subcluster') # analysis file output directory
data_dir <- here('data/derived/tildra') # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(SeuratWrappers)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(harmony)
```
### Functions

```{r}
recluster <- function(seuratobj, 
                      assay = 'RNA',
                      dims = 1:20,
                      seed = 42,
                      n.neighbors = 30,
                      n.epochs = 200,
                      min.dist = 0.3,
                      k.param = 20,
                      algorithm = 1,
                      resolution = c(0.1, 1.0, 2.0),
                      default_ident = 'RNA_snn_res.1') {
  
    ### RunUMAP, FindNeighbors, and FindClusters 
  
  seuratobj <- seuratobj %>% 
    RunUMAP(reduction = 'harmony', 
            dims = dims, 
            assay = assay, 
            seed.use = seed,
            n.neighbors = n.neighbors,
            n.epochs = n.epochs,
            min.dist = min.dist) %>% 
    FindNeighbors(reduction = 'harmony', 
                  dims = dims, 
                  assay = assay,
                  k.param = k.param) %>% 
    FindClusters(random.seed = seed,
                 algorithm = algorithm,
                 resolution = resolution)
  
  ### Fix cluster factor levels
  clusterings <- colnames(seuratobj@meta.data) %>% str_subset('_res')
  
  for(i in clusterings) {
    clusters <- seuratobj@meta.data[[i]]
    seuratobj[[i]] <- factor(clusters, levels = levels(clusters) %>% as.numeric() %>% sort())
  }
  
  Idents(seuratobj) <- default_ident
  seuratobj$seurat_clusters <- seuratobj[[default_ident]]
  
  seuratobj
}
```

### Import Seurat
```{r}
seuratobj <- read_rds(file.path(data_dir, 'seuratobj_clustered.rds'))
seuratobj
```

### Visualize
```{r}
p <- seurat_feature(seuratobj, facet_hide = TRUE)

p
```


```{r}
p <- seurat_feature(seuratobj, features = 'seurat_clusters', facets = 'seurat_clusters', label = FALSE)

p
```


### Major cell types
```{r}
p <- seurat_feature(seuratobj, 
               features = c('CD3D', #lymphocytes
                            'MS4A1', # b cells
                            'HLA-DRA', # APC
                            'LYZ', # APC
                            'TPSAB1', # mast cells
                            'COL6A2', # fibroblasts
                            'PECAM1', # endothelial cells
                            'MKI67'), # cycling
               nrow = 2, 
               rasterize_dpi = 600) 

ggsave(plot = p,
       filename = 'broad_markers.png',
       h = 4,
       w = 8,
       dpi = 600,
       path = output_dir)

p
```


```{r}
library(ape)
seuratobj <- BuildClusterTree(seuratobj, reduction = 'harmony', dims = 1:30, assay = 'RNA')
tree <- as.hclust(Tool(seuratobj, slot = 'BuildClusterTree'))
```
```{r}
tree_height <- 100
plot(tree)
abline(h = tree_height, col = 'red')
```
### Merged clusters from phylogenetic tree
```{r}
cuts <- cutree(tree, k = 6)

tree_mapping <- tibble('seurat_clusters' = names(cuts),
                       'broad_clusters' = factor(cuts))

broad_clusters <- seuratobj@meta.data %>% rownames_to_column() %>% select(seurat_clusters) %>% left_join(tree_mapping)

seuratobj$broad_clusters <- broad_clusters$broad_clusters

p <- seurat_feature(seuratobj, feature = 'broad_clusters', facet_hide = TRUE, rasterize_dpi = 600, title = 'Broad Clusters')

ggsave(plot = p,
       filename = 'broad_clusters.png',
       h = 5,
       w = 5,
       dpi = 600,
       path = output_dir)

p
```
#### Calculate markers from broad clusters
```{r}
Idents(seuratobj) <- 'broad_clusters'
broad_markers <- RunPrestoAll(seuratobj, min.pct = 0.25, only.pos = TRUE, min.diff.pct = 0.25, features = VariableGenes(seuratobj)) %>% mutate(pct.diff = pct.1 - pct.2) %>% arrange(-pct.diff) %>% select(cluster, gene, everything()) %>% as_tibble()

broad_markers %>% group_by(cluster) %>% slice_max(pct.diff, n = 5)
```

```{r}
broad_markers %>% group_by(cluster) %>% slice_max(pct.diff, n = 5)
```
```{r}
broad_markers %>% filter(gene %in% 'COL1A1')
```
### Reynolds et al markers

```{r}
markers_reynolds <- c('KRT14', 'KRT5', 
                      'GATA3', 'KRTDAP',
                      'CRYAB', 'TYRP1',
                      'DKK3', 'PLEKHA4',
                      'LUM', 'APOD',
                      'PHLDA2', 'CCL2',
                      'IL6', 'PDGFRA',
                      'COL1A1', 'CXCL12',
                      'CD82', 'CCL19', 'KCNE4', 'CPE', 'TAGLN', 'MYL9', 'HEY1', 'CCL14', 'PECAM1',
                      'ACKR1', 'SELE', 'SNCG', 'HES1', 'MMRN1', 'XCL1' ,'XCL2', 'KLRC1', 'CCL5', 'GZMA', 
                      'CD8A', 'CD8B', 'IL7R', 'FOXP3', 'TIGIT', 'TPSB2', 'TPSAB1', 'CD79A', 'JCHAIN', 'CD163',
                      'C1QB', 'FCGR2A', 'MS4A6A', 'IL23A', 'CLEC9A', 'CLEC10A', 'CD1C', 'CD207', 'CD1A', 
                      'CD14', 'IL1B', 'CCR7', 'IDO1')
```

### Subclusters
Use UMAP as input to clustering for cleanly selecting clusters


#### Major cell types
```{r}
mast_clusters <- broad_markers %>% filter(gene == 'TPSAB1', avg_log2FC > 0) %>% pull(cluster)
stromal_clusters <- broad_markers %>% filter(gene == 'COL1A1', avg_log2FC > 0) %>% pull(cluster)
apc_clusters <- broad_markers %>% filter(gene == 'HLA-DRA', avg_log2FC > 0) %>% pull(cluster)
lymphocyte_clusters <- broad_markers %>% filter(gene == 'CD3D', avg_log2FC > 0) %>% pull(cluster)
cycling_clusters <- broad_markers %>% filter(gene == 'MKI67') %>% slice_max(pct.1) %>% pull(cluster)
```

```{r}
celltypes <- seuratobj@meta.data %>% 
  select(id, broad_clusters) %>% 
  mutate(celltype = case_when(broad_clusters %in% cycling_clusters ~ 'Cycling',
                              broad_clusters %in% stromal_clusters ~ 'Stromal',
                              broad_clusters %in% mast_clusters ~ 'Mast',
                              broad_clusters %in% apc_clusters ~ 'APC',
                              broad_clusters %in% lymphocyte_clusters ~ 'Lymphocyte'))


seuratobj$celltype <- celltypes$celltype
p <- seurat_feature(seuratobj, features = 'celltype', facet_hide = TRUE, legend_position = 'none', rasterize_dpi = 600)

ggsave(plot = p,
       filename = 'broad_celltypes.png',
       h = 5,
       w = 5,
       dpi = 600,
       path = output_dir)
p
```


```{r}
celltype_tally <- celltypes %>% 
  group_by(id, celltype) %>% 
  tally() %>% 
  pivot_wider(names_from = 'celltype',
              values_from = 'n',
              values_fill = 0,
              names_prefix = 'n_')

celltype_tally %>% write_tsv(here(output_dir, 'celltype_tally.tsv'))

celltype_tally
```


### Iterative subsclustering and re-harmonize
```{r}
batch <- c('treatment', 'patient', 'flow', 'mouse', 'chemistry') # global batch variables

apcs <- subset(seuratobj, subset = celltype == 'APC') 
lymphocytes <- subset(seuratobj, subset = celltype == 'Lymphocyte')

p1 <- seurat_feature(apcs, facet_hide = TRUE, title = 'APCs')
p2 <- seurat_feature(lymphocytes, facet_hide = TRUE, title = 'Lymphocytes')
p1 + p2
```

#### Reprocess subclusters
```{r}
apcs <- apcs %>% DietSeurat() %>% FindVariableFeatures(nfeatures = 3000) %>% ScaleData() %>% RunPCA() %>% RunHarmony(batch)
apcs
```

```{r}
ElbowPlot(apcs, ndims = 50, reduction = 'harmony')
```

```{r}
lymphocytes <- lymphocytes %>% DietSeurat() %>% FindVariableFeatures(nfeatures = 3000) %>% ScaleData() %>% RunPCA() %>% RunHarmony(batch)
lymphocytes
```

```{r}
ElbowPlot(lymphocytes, ndims = 50, reduction = 'harmony')
```

### Cluster subgroups separately, then recombine objects for grouped analysis
#### Reclustering parameters
```{r}
dims <- 1:25
```


```{r}
apcs <- apcs %>% recluster(dims = dims)
```
```{r}
p <- seurat_feature(apcs, facet_hide = TRUE, title = 'APC Subcluster', legend_position = 'none')

ggsave(plot = p,
       filename = 'umap_apc.png',
       h = 5,
       w = 5,
       path = output_dir)
p
```

```{r}
apcs@meta.data %>% 
  select(seurat_clusters, id) %>% 
  unique() %>% 
  add_count(seurat_clusters) %>% 
  arrange(n)
```

#### Lymphocytes
```{r}
lymphocytes <- lymphocytes %>% recluster(dims = dims)
```

```{r}
p <- seurat_feature(lymphocytes, facet_hide = TRUE)
p
```
```{r}
lymphocytes@meta.data %>%
  select(seurat_clusters, id) %>%
  unique() %>%
  add_count(seurat_clusters) %>%
  arrange(n)
```

### Identify B cells 
```{r}
seurat_feature(lymphocytes, features = c('JCHAIN', 'MS4A1'))
```
```{r}
VlnPlot(lymphocytes, 'MS4A1')
```

### Recombine and recluster
```{r}
subcluster <- subset(seuratobj, cells = c(colnames(apcs), colnames(lymphocytes))) %>% DietSeurat()

combined_features <- union(apcs@assays$RNA@var.features, lymphocytes@assays$RNA@var.features)
VariableFeatures(subcluster) <- combined_features

subcluster <- subcluster %>% 
  ScaleData() %>% 
  RunPCA() %>% 
  RunHarmony(group.by.vars = batch)

```
```{r}
ElbowPlot(subcluster, ndims = 50, reduction = 'harmony')
```

### RunUMAP, FindNeighbors, and FindClusters 
```{r}
subcluster <- subcluster %>% recluster(dims = 1:20,
                                       resolution = c(0.2, 1, 2),
                                       default_ident = 'RNA_snn_res.2')

subcluster$global <- Idents(subcluster)
```

```{r}
subcluster %>% seurat_feature()
```


### Any clusters with only 1 patient?
```{r}
subcluster@meta.data %>% 
  select(cluster = RNA_snn_res.2, id, patient, sample) %>% 
  unique() %>% 
  add_count(cluster) %>% 
  arrange(n)
```

### Add cluster information from iterative subclustering 
```{r}
apc_clustering <- apcs@meta.data %>% 
  rownames_to_column() %>% 
  select(rowname, seurat_clusters) %>% 
  mutate(subcluster = factor(paste0('A', seurat_clusters), levels = paste0('A', levels(seurat_clusters))))

lymphocyte_clustering <- lymphocytes@meta.data %>% 
  rownames_to_column() %>% 
  select(rowname, seurat_clusters) %>% 
  mutate(subcluster = factor(paste0('L', seurat_clusters), levels = paste0('L', levels(seurat_clusters))))

merged_clustering <- subcluster@meta.data %>% 
  rownames_to_column() %>% 
  select(rowname) %>% left_join(
    bind_rows(lymphocyte_clustering,
              apc_clustering) %>% 
      select(-seurat_clusters)) %>% 
  column_to_rownames()

merged_clustering
```
```{r}
subcluster <- AddMetaData(subcluster, merged_clustering)
subcluster$seurat_clusters <- subcluster$subcluster
Idents(subcluster) <- 'seurat_clusters'

```


```{r}
sample_cluster_tally <- subcluster@meta.data %>% 
  select(cluster = RNA_snn_res.2, id, patient, sample) %>% 
  unique() %>% 
  add_count(cluster) %>% 
  arrange(n)

sample_cluster_tally
```

```{r}
clusters_to_remove <- sample_cluster_tally %>% filter(n < 3) %>% pull(cluster) %>% as.character()
clusters_to_remove
```
```{r}
sample_subcluster_tally <- subcluster@meta.data %>% 
  filter(!(RNA_snn_res.2 %in% clusters_to_remove)) %>% 
  select(cluster = seurat_clusters, id, patient, sample) %>% 
  unique() %>% 
  add_count(cluster) %>% 
  arrange(n)

sample_subcluster_tally
```
```{r}
subclusters_to_remove <- sample_subcluster_tally %>% filter(n < 3) %>% pull(cluster) %>% as.character()
subclusters_to_remove
```


```{r}
cells_to_keep <- subcluster@meta.data %>% 
  filter(!(RNA_snn_res.2 %in% clusters_to_remove),
         !(subcluster %in% subclusters_to_remove)) %>% 
  rownames()
```

```{r}
subcluster
```

```{r}
subcluster <- subset(subcluster, cells = cells_to_keep)
subcluster
```

```{r}
subcluster %>% seurat_feature(feature = 'subcluster', facet_hide = TRUE, title = 'Lymphocyte and APC Clusters', legend_position = 'none')
```

```{r}
p3 <- subcluster %>% seurat_feature(facet_hide = TRUE, title = 'Lymphocyte and APC clusters', legend_position = 'none', color_package = 'carto', color_palette = 'Bold', alpha = 0.2, label_size = 4)

ggsave(plot = p3,
       filename = 'umap_unified_labeled.png',
       h = 5,
       w = 5,
       path = output_dir)

p3
```
```{r}
p4 <- subcluster %>% seurat_feature(facet_hide = TRUE, title = 'Lymphocyte and APC clusters', legend_position = 'none', color_package = 'carto', color_palette = 'Bold', alpha = 0.2, label = FALSE)

ggsave(plot = p4,
       filename = 'umap_unified.png',
       h = 5,
       w = 5,
       path = output_dir)

p4
```

```{r}
p5 <- subcluster %>% seurat_feature(title = 'Lymphocyte and APC clusters', facets = 'seurat_clusters', 
                                    legend_position = 'none', color_package = 'carto', color_palette = 'Bold', alpha = 0.2, label = FALSE)

ggsave(plot = p5,
       filename = 'umap_unified_facet_subclusters.png',
       h = 12,
       w = 12,
       path = output_dir)
```
```{r}
p6 <- subcluster %>% seurat_feature(title = 'Lymphocyte and APC clusters', facets = 'RNA_snn_res.2', 
                                    legend_position = 'none', color_package = 'carto', color_palette = 'Pastel', alpha = 0.2, label = FALSE)

ggsave(plot = p6,
       filename = 'umap_unified_facet_clusters.png',
       h = 12,
       w = 12,
       path = output_dir)
```

## Export
```{r}
subcluster %>% write_rds(here(data_dir, 'seuratobj_subcluster.rds'))
```

## Session Info
```{r}
sessionInfo()
```

```{r}
subcluster %>% seurat_feature(facet_hide = TRUE, title = 'Lymphocyte and APC clusters', legend_position = 'none', color_package = 'carto', color_palette = 'Bold', alpha = 0.2, label_size = 4)
```

