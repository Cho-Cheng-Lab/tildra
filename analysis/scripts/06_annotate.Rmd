---
title: "Annotation"
author: "David Wu"
---

### Use the here package for robust relative paths
```{r}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- 'analysis/output/06_annotate' # analysis file output directory
data_dir <- 'data/derived/tildra' # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(SeuratWrappers)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(googlesheets4)
```

### Functions
```{r}
tabulate_frequency <- function(df,
                               group1 = NULL,
                               group2 = NULL,
                               rename = FALSE) {
  frequency_table <- 
    df %>% 
    mutate_all(as.factor) %>% 
    mutate_all(droplevels) %>% 
    dplyr::select({{group1}}, 
                  {{group2}}) 
  
  if(rename) {
    colnames(frequency_table) <- c('group1', 'group2')
  }
  
  frequency_table %>% table()
  
}

calculate_proportions <- function(frequency_table, 
                                  group1 = 'group1',
                                  group2 = 'group2') {
  
  # totals
  group1_totals <- rowSums(frequency_table) %>% 
    as.data.frame() %>% 
    rownames_to_column()
  colnames(group1_totals) <- c('group1', 'n_group1')
  
  group2_totals <- colSums(frequency_table) %>% 
    as.data.frame() %>% 
    rownames_to_column()
  
  overlap_totals <- frequency_table %>% 
    as.data.frame() %>% 
    dplyr::rename(n_overlap = Freq)
  
  # proportions
  group1_proportion <- prop.table(frequency_table, margin = 1) %>% 
    as.data.frame() %>% 
    mutate(f_group1 = round(Freq, 3)) %>% 
    dplyr::select(-Freq)
  
  group2_proportion <- prop.table(frequency_table, margin = 2) %>% 
    as.data.frame() %>%
    mutate(f_group2 = round(Freq, 3)) %>% 
    dplyr::select(-Freq)
  

  
  colnames(group2_totals) <- c('group2', 'n_group2')
  
  
  proportion_table <- group1_totals %>% 
    inner_join(group2_totals) %>% 
    inner_join(overlap_totals) %>% 
    inner_join(group1_proportion) %>% 
    inner_join(group2_proportion) %>% 
    mutate(max_proportion = ifelse(f_group2 > f_group1, f_group2, f_group1),
           score = round(f_group1 * f_group2, 3)) %>% 
    arrange(-max_proportion)
  
  proportion_table
  
}

proportion_pipeline <- function(df,
                                group1,
                                group2,
                                rename = TRUE) {
  
  
  df %>% 
    tabulate_frequency(group1 = 'seurat_clusters',
                       group2 = 'label',
                       rename = TRUE) %>% 
    calculate_proportions()
  
}

cluster_enrichment <- function(metadata_table,
                               group1 = 'guide_target',
                               group2 = 'seurat_clusters',
                               rename = TRUE,
                               print = FALSE,
                               method = 'fisher',
                               parallel = FALSE) {
  
  frequency_table <- metadata_table %>% 
    dplyr::select(barcode,
                  {{group1}}, 
                  {{group2}})
  
  if(rename) {
    colnames(frequency_table) <- c('barcode', 'target', 'cluster')
  }
  
  targets <- frequency_table$target %>% unique() %>% sort()
  clusters <- frequency_table$cluster %>% as.character() %>% unique() %>% sort()
  all_barcodes <- frequency_table$barcode
  
  enrich <- map(targets, function(i) {
    print2(paste('Running', i, '\n'))
    
    map(clusters, function(j) {
      
      target_subset <- frequency_table %>% filter(target == i) %>% pull(barcode) 
      cluster_subset <- frequency_table %>% filter(cluster == j) %>% pull(barcode)
      overlap_subset <- intersect(target_subset, cluster_subset)
      
      # run enrichment test
      enrichment_res <- enrichment_test(target_subset,
                                        cluster_subset,
                                        background = all_barcodes,
                                        print = print,
                                        method = method)
      
      odds <- enrichment_res$estimate
      pval <- enrichment_res$p.value
      
      output <- tibble('group1_id' = group1,
                       'group2_id' = group2,
                       'group1' = i,
                       'group2' = j,
                       'n_group1' = length(target_subset),
                       'n_group2' = length(cluster_subset),
                       'n_overlap' = length(overlap_subset),
                       'f_group1' = round(n_overlap/n_group1, 3),
                       'f_group2' = round(n_overlap/n_group2, 3),
                       'f_max' = ifelse(f_group2 > f_group1, f_group2, f_group1),
                       'score' = round(f_group1 * f_group2, 3),
                       'odds' = round(enrichment_res$fisher$estimate, 3),
                       'log2odds' = round(log2(odds), 3),
                       'pval' = enrichment_res$fisher$p.value)
      
      output
    }) %>% bind_rows()
  }) %>% bind_rows()
  
  enrich %>% 
    arrange(pval)
}
```

### Import
#### Clustered object
```{r}
seuratobj <- read_rds(file.path(data_dir, 'seuratobj_subcluster.rds'))
metadata <- seuratobj@meta.data %>% rownames_to_column()
seuratobj
```
#### Import rashx clusters
```{r}
rashxobj <- read_rds(here('data/external/rashx.rds'))
rashx_clusters <- read_tsv(here('analysis/output/rashx/cluster_data.tsv.gz'))
rashx_clusters %>% head()
```

### Analysis
#### Combine tables


```{r}
merged_annotations <- metadata %>% 
  select(rowname, seurat_clusters) %>% 
  separate(rowname, sep = '_', into = c('barcode', NA), remove = FALSE) %>% 
  left_join(rashx_clusters) %>% 
  drop_na()

merged_annotations
```




```{r}
cluster_comparison <- cluster_enrichment(merged_annotations,
                                         group1 = 'seurat_clusters',
                                         group2 = 'cluster')

cluster_comparison %>% arrange(-f_max)
```
```{r}
cluster_max <- cluster_comparison %>% 
  group_by(group2) %>% 
  top_n(1, f_group2)

cluster_max %>% 
  arrange(group1)
```
```{r}
cluster_wide <- cluster_comparison %>% 
  mutate(value = case_when(
    is.infinite(log2odds) ~ -13,
    (pval > 0.05) ~ NaN,
    TRUE ~ log2odds)) %>% 
  select(group1, group2, value) %>% 
  pivot_wider(names_from = group1,
              values_from = value)

cluster_wide
```



```{r}
library(pheatmap)

pheatmap_input <- cluster_wide %>% column_to_rownames(1) %>% as.matrix()
pheatmap(mat = pheatmap_input, 
         scale = 'column',
         angle_col = 0)
```

### SingleR
```{r}
library(SingleR)
```

#### Convert to SCE
```{r}
rashx_sce <- as.SingleCellExperiment(rashxobj %>% DietSeurat(), assay = 'RNA')
tildra_sce <- as.SingleCellExperiment(seuratobj %>% DietSeurat(), assay = 'RNA')
```

#### Run SingleR
```{r}
singler_pred <- SingleR(test = tildra_sce, 
                        ref = rashx_sce, 
                        labels = set_names(rashx_sce$Ident2, .), 
                        de.method = 'wilcox')
```



```{r}

```




### Import annotation table
```{r}
annotations <- read_sheet('https://docs.google.com/spreadsheets/d/1pLMOaXkSGq3qSX7bTIw2daWd3ItA5JxqFomQn_km1IU/edit#gid=0') %>% 
  filter(!is.na(cluster)) %>% 
  mutate(cluster = factor(cluster))

annotations$label <- factor(annotations$label, levels = annotations$label)
annotations$merged_label <- factor(annotations$merged_label, levels = unique(annotations$merged_label))
annotations
```
### Ensure factor level ordering
```{r}
levels(annotations$label)
```

#### Get current clusters and integrate with annotations
```{r}
cluster_annotation <- seuratobj@meta.data %>% 
  select(cluster = seurat_clusters) %>% 
  rownames_to_column() %>% 
  left_join(annotations %>% select(cluster, label, merged_label)) %>% 
  column_to_rownames('rowname')
cluster_annotation
```
### Add Metadata
```{r}
seuratobj <- AddMetaData(seuratobj, cluster_annotation)
Idents(seuratobj) <- 'merged_label'
Idents(seuratobj) %>% head()
```

```{r}
p <- seuratobj %>% seurat_feature(features = 'merged_label', facet_hide = TRUE, size = 0.1, alpha = 0.1)

ggsave(plot = p,
       filename = 'umap_annotated.png',
       path = output_dir,
       dpi = 100,
       w = 20, 
       h = 10)
p
```
### Update metadata
```{r}
metadata <- read_tsv('analysis/input/metadata.tsv') %>% 
  filter(is.na(exclude)) %>% 
  mutate(id = paste0('skin', id)) %>% 
  select(id, sample, patient, condition, treatment, response, response_group)
metadata
```


```{r}
new_metadata <- seuratobj@meta.data %>% 
  select(id) %>% 
  rownames_to_column() %>% 
  left_join(metadata) %>% 
  column_to_rownames()

new_metadata
```
```{r}
identical(seuratobj@meta.data$id, new_metadata$id)

#updated_metadata <- c('sample', 'patient', 'treatment', 'response', 'response_group')

seuratobj$sample <- new_metadata$sample
seuratobj$patient <- new_metadata$patient
seuratobj$treatment <- new_metadata$treatment
seuratobj$response <- new_metadata$response
seuratobj$response_group <- new_metadata$response_group

```

```{r}
seuratobj$response_group %>% head()
```

### Export
```{r}
seuratobj@meta.data %>% rownames_to_column() %>% write_rds(file.path(output_dir, 'metadata.rds'), compress = 'gz')
seuratobj %>% write_rds(file.path(data_dir, 'seuratobj_annotated.rds'))
```

## Session Info
```{r}
sessionInfo()
```



