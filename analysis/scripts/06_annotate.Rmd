---
title: "Annotation"
author: "David Wu"
---

### Use the here package for robust relative paths
```{r}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- 'analysis/output/06_annotate' # analysis file output directory
data_dir <- 'data/derived/tildra' # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(SeuratWrappers)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(googlesheets4)
library(ggsankey)
library(aricode)
theme_set(wutilities::theme_dwu())
```

### Functions
```{r}
tabulate_frequency <- function(df,
                               group1 = NULL,
                               group2 = NULL,
                               rename = FALSE) {
  frequency_table <- 
    df %>% 
    mutate_all(as.factor) %>% 
    mutate_all(droplevels) %>% 
    dplyr::select({{group1}}, 
                  {{group2}}) 
  
  if(rename) {
    colnames(frequency_table) <- c('group1', 'group2')
  }
  
  frequency_table %>% table()
  
}

calculate_proportions <- function(frequency_table, 
                                  group1 = 'group1',
                                  group2 = 'group2') {
  
  # totals
  group1_totals <- rowSums(frequency_table) %>% 
    as.data.frame() %>% 
    rownames_to_column()
  colnames(group1_totals) <- c('group1', 'n_group1')
  
  group2_totals <- colSums(frequency_table) %>% 
    as.data.frame() %>% 
    rownames_to_column()
  
  overlap_totals <- frequency_table %>% 
    as.data.frame() %>% 
    dplyr::rename(n_overlap = Freq)
  
  # proportions
  group1_proportion <- prop.table(frequency_table, margin = 1) %>% 
    as.data.frame() %>% 
    mutate(f_group1 = round(Freq, 3)) %>% 
    dplyr::select(-Freq)
  
  group2_proportion <- prop.table(frequency_table, margin = 2) %>% 
    as.data.frame() %>%
    mutate(f_group2 = round(Freq, 3)) %>% 
    dplyr::select(-Freq)
  

  
  colnames(group2_totals) <- c('group2', 'n_group2')
  
  
  proportion_table <- group1_totals %>% 
    inner_join(group2_totals) %>% 
    inner_join(overlap_totals) %>% 
    inner_join(group1_proportion) %>% 
    inner_join(group2_proportion) %>% 
    mutate(max_proportion = ifelse(f_group2 > f_group1, f_group2, f_group1),
           score = round(f_group1 * f_group2, 3)) %>% 
    arrange(-max_proportion)
  
  proportion_table
  
}

proportion_pipeline <- function(df,
                                group1,
                                group2,
                                rename = TRUE) {
  
  
  df %>% 
    tabulate_frequency(group1 = 'seurat_clusters',
                       group2 = 'label',
                       rename = TRUE) %>% 
    calculate_proportions()
  
}

cluster_enrichment <- function(metadata_table,
                               group1 = 'guide_target',
                               group2 = 'seurat_clusters',
                               rename = TRUE,
                               print = FALSE,
                               method = 'fisher',
                               parallel = FALSE) {
  
  frequency_table <- metadata_table %>% 
    dplyr::select(barcode,
                  {{group1}}, 
                  {{group2}})
  
  if(rename) {
    colnames(frequency_table) <- c('barcode', 'target', 'cluster')
  }
  
  targets <- frequency_table$target %>% unique() %>% sort()
  clusters <- frequency_table$cluster %>% as.character() %>% unique() %>% sort()
  all_barcodes <- frequency_table$barcode
  
  enrich <- map(targets, function(i) {
    print2(paste('Running', i, '\n'))
    
    map(clusters, function(j) {
      
      target_subset <- frequency_table %>% filter(target == i) %>% pull(barcode) 
      cluster_subset <- frequency_table %>% filter(cluster == j) %>% pull(barcode)
      overlap_subset <- intersect(target_subset, cluster_subset)
      
      # run enrichment test
      enrichment_res <- enrichment_test(target_subset,
                                        cluster_subset,
                                        background = all_barcodes,
                                        print = print,
                                        method = method)
      
      odds <- enrichment_res$estimate
      pval <- enrichment_res$p.value
      
      output <- tibble('group1_id' = group1,
                       'group2_id' = group2,
                       'group1' = i,
                       'group2' = j,
                       'n_group1' = length(target_subset),
                       'n_group2' = length(cluster_subset),
                       'n_overlap' = length(overlap_subset),
                       'f_group1' = round(n_overlap/n_group1, 3),
                       'f_group2' = round(n_overlap/n_group2, 3),
                       'f_max' = ifelse(f_group2 > f_group1, f_group2, f_group1),
                       'score' = round(f_group1 * f_group2, 3),
                       'odds' = round(enrichment_res$fisher$estimate, 3),
                       'log2odds' = round(log2(odds), 3),
                       'pval' = enrichment_res$fisher$p.value)
      
      output
    }) %>% bind_rows()
  }) %>% bind_rows()
  
  enrich %>% 
    arrange(pval)
}


calculate_agreement <- function(group1,
                                group2) {
  
  tibble('AMI' = aricode::AMI(group1, group2),
         'ARI' = aricode::ARI(group1, group2))
  
}

```


### Sankey
```{r}
plot_sankey1 <- function(df,
                         nodes,
                         names = nodes,
                         top_n = NULL, # only applicable for single category breakdown
                         percentages = TRUE,
                         title = NULL) {
  
  sankey_input <- df %>% select(all_of(nodes))
  
  if(names != nodes) {
    colnames(sankey_input) <- names
  }
  
  if(!is.null(top_n) | percentages) {
    
    sankey_input <- sankey_input %>% 
      add_count(across(all_of(names))) %>% 
      mutate(pct = round(100 * n/nrow(.), 1))
    
  }
  
  if(!is.null(top_n)) {
    top_categories <- sankey_input %>% unique() %>% slice_max(pct, n = top_n)
    sankey_input <- sankey_input %>% filter(pct %in% top_categories$pct)
  }
  
  if(percentages) {
    sankey_input[[names[2]]] <- paste(sankey_input[[names[2]]], sankey_input[['pct']])
  }
  
  sankey_input <- sankey_input %>% make_long(1:2)
  
  ggplot(sankey_input, 
                aes(x = x, 
                    next_x = next_x, 
                    node = node, 
                    next_node = next_node,
                    fill = node,
                    label = node)) +
  geom_sankey(flow.alpha = 0.6,
              node.color = 'black') +
  theme_sankey(base_size = 12) +
    theme(legend.position = 'none',
          text = element_text(family = 'Arial'),
          plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(size = 12, color = 'black')) +
  geom_sankey_label(size = 4, color = "black", fill = "white") + 
  scale_fill_viridis_d() + 
  labs(x = '',
       title = title)
  
}

plot_sankey2 <- function(df,
                         nodes,
                         names = nodes,
                         top_n = 3,
                         title = NULL)
{

  sankey_input <- df %>% select(all_of(nodes))
  
  if(names != nodes) {
    colnames(sankey_input) <- names
  }
  
  if(!is.null(top_n)) {
    
    sankey_input_left <- sankey_input %>% 
      select(all_of(names[-3])) %>% 
      group_by_all() %>% 
      tally() %>% 
      ungroup() %>% 
      mutate(pct = round(100 * n/nrow(sankey_input), 1))
    
    sankey_input_right <- sankey_input %>% 
      select(all_of(names[-1])) %>% 
      group_by_all() %>% 
      tally() %>% 
      ungroup() %>% 
      mutate(pct = round(100 * n/nrow(sankey_input), 1)) 
      
  }
  
  if(!is.null(top_n)) {
    
    top_categories_left <- sankey_input_left %>% unique() %>% arrange(-pct) %>% mutate(row = row_number())
    
    bottom_pct_left <- top_categories_left %>% 
      filter(row > top_n) %>% 
      pull(pct) %>% 
      sum()

    top_categories_right <- sankey_input_right %>% unique() %>% arrange(-pct) %>% mutate(row = row_number())
    
    bottom_pct_right <- top_categories_right %>% 
      filter(row > top_n) %>% 
      pull(pct) %>% 
      sum()
    
    sankey_input <- sankey_input %>% 
      left_join(top_categories_left %>% select(-n)) %>% 
      mutate(pct = ifelse(row > top_n, bottom_pct_left, pct),
             '{names[1]}' := ifelse(row > top_n, 'Other', .[[names[1]]])) %>% 
      mutate('{names[1]}' := paste0(.[[names[1]]], ', ', pct, '%')) %>% 
      select(-row, -pct) %>% 
      left_join(top_categories_right %>% select(-n)) %>% 
      mutate(pct = ifelse(row > top_n, bottom_pct_right, pct),
             '{names[3]}' := ifelse(row > top_n, 'Other', .[[names[3]]])) %>% 
      mutate('{names[3]}' := paste0(.[[names[3]]], ', ', pct, '%')) %>% 
      select(-row, -pct)
      
    
  }
  
  ggplot(sankey_input %>% make_long(1:3), 
                aes(x = x, 
                    next_x = next_x, 
                    node = node, 
                    next_node = next_node,
                    fill = node,
                    label = node)) +
  geom_sankey(flow.alpha = 0.6,
              node.color = 'black') +
    theme_sankey(base_size = 12) +
    theme(legend.position = 'none',
          text = element_text(family = 'Arial'),
          plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(size = 12, color = 'black')) +
    geom_sankey_label(size = 4, color = "black", fill = "white") + 
    scale_fill_viridis_d() + 
    labs(x = '',
         title = title)
}

```

### Import
#### Clustered object
```{r}
seuratobj <- read_rds(file.path(data_dir, 'seuratobj_subcluster.rds'))
seuratobj
```

### Select identity
```{r}
which_annotation <- 'global'
Idents(seuratobj) <- which_annotation

seuratobj$seurat_clusters <- seuratobj[[which_annotation]]

output_dir <- here(output_dir, which_annotation)
```

```{r}
metadata <- seuratobj@meta.data %>% rownames_to_column()
```

### Prior manual annotations
#### Import rashx clusters
```{r}
rashx_clusters <- read_tsv(here('analysis/output/rashx/rashx_clusters.tsv.gz'))
rashx_clusters %>% head()
```
```{r}
seuratobj %>% seurat_feature(features = c('MKI67', 'PCNA', 'TOP2A'))
```

### Analysis
#### Combine tables


```{r}
merged_annotations <- metadata %>% 
  select(rowname, seurat_clusters, id, global) %>% 
  separate(rowname, sep = '_', into = c('barcode', NA), remove = FALSE) %>% 
  left_join(rashx_clusters) %>% 
  drop_na() %>% 
  as_tibble()

merged_annotations
```
### Agreement metrics
```{r}
calculate_agreement(merged_annotations$seurat_clusters, 
                    merged_annotations$cluster)
```
```{r}
calculate_agreement(merged_annotations$seurat_clusters, 
                    merged_annotations$supercluster)
```
```{r}
calculate_agreement(merged_annotations$global, 
                    merged_annotations$seurat_clusters)
```

```{r}
calculate_agreement(merged_annotations$global, 
                    merged_annotations$cluster)
```

```{r}
calculate_agreement(merged_annotations$global, 
                    merged_annotations$supercluster)
```

```{r}
odds_cluster <- odds_table(merged_annotations, 
                           'seurat_clusters',
                           'cluster')

odds_supercluster <- odds_table(merged_annotations,
                                'seurat_clusters',
                                'supercluster') 

odds_global <- odds_table(merged_annotations, 
                          'global',
                          'cluster')

odds_globalsuper <- odds_table(merged_annotations, 
                               'global',
                               'supercluster')


odds_supercluster
```


```{r}
odds_supercluster %>% 
  mutate(combination = paste(group1, group2)) %>% 
  filter(odds > 1,
         pval < 0.05) %>% 
  ggplot(aes(x = odds + 0.001,
             y = f_score,
             label = combination,
             color = group1)) +
  geom_point(alpha = 0.5) + 
  ggrepel::geom_text_repel() + 
  scale_x_log10(limits = c(NA, 1e5)) +
  theme_dwu()
```

```{r}
input_odds <- odds_cluster

top_jaccard <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(jaccard)

top_overlap <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(overlap_coef)

top_f <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(f_group1)

top_f_score<- input_odds %>% 
  group_by(group1) %>% 
  slice_max(f_score)

top_odds <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(odds)

top_comparison <- top_f %>% select(group1, f_group1, f = group2) %>% 
  left_join(top_overlap %>% select(group1, overlap = group2)) %>% 
  left_join(top_jaccard %>% select(group1, jaccard = group2)) %>% 
  left_join(top_f_score %>% select(group1, f_score = group2)) %>% 
  left_join(top_odds %>% select(group1, odds = group2)) %>% 
  mutate(match = ifelse(f == jaccard, 'Yes', 'No')) 

top_comparison %>% add_count(group1) %>% filter(match == 'No', group1 != 'A9')
```
```{r}
odds_supercluster %>% filter(group1 == 'A17') %>% arrange(-f_score) %>% select(-n_total)
```
```{r}
odds_supercluster %>% mutate(jaccard = round(n_overlap/(n_group1 + n_group2 - n_overlap),3)) %>% 
  select(group1, group2, f_group1, f_group2, f_max, f_score, jaccard) %>% 
  arrange(-f_score) 
```


#### Sankey 1 loop
```{r}
map(merged_annotations$seurat_clusters %>% unique() %>% sort(),
    function(i) {
      
      p <- plot_sankey1(merged_annotations %>% filter(seurat_clusters == i),
                        nodes = c('seurat_clusters', 'cluster'),
                        names = c('Current Cluster', 'RashX Cluster'))
      
      ggsave(plot = p,
             filename = paste0(i, '.png'),
             path = here(output_dir, 'sankey1_current'),
             h = 4,
             w = 6)
      
    }) %>% invisible()


map(merged_annotations$cluster %>% unique() %>% sort(),
    function(i) {
      
      p <- plot_sankey1(merged_annotations %>% filter(cluster == i),
                        nodes = c('cluster', 'seurat_clusters'),
                        names = c('RashX Cluster', 'Current Cluster'))
      
      ggsave(plot = p,
             filename = paste0(i, '.png'),
             path = here(output_dir, 'sankey1_rashx'),
             h = 4,
             w = 6)
      
    }) %>% invisible()

map(merged_annotations$supercluster %>% unique() %>% sort(),
    function(i) {
      
      p <- plot_sankey1(merged_annotations %>% filter(cluster == i),
                        nodes = c('supercluster', 'seurat_clusters'),
                        names = c('RashX Supercluster', 'Current Cluster'))
      
      ggsave(plot = p,
             filename = paste0(i, '.png'),
             path = here(output_dir, 'sankey1_supercluster'),
             h = 4,
             w = 6)
      
    }) %>% invisible()



```

#### Sankey 2 loop
```{r}
map(merged_annotations$seurat_clusters %>% unique() %>% sort(),
    function(i) {
      
      p <- plot_sankey2(merged_annotations %>% filter(seurat_clusters == i),
                        nodes = c('supercluster', 'seurat_clusters', 'cluster'),
                        names = c('RashX Supercluster', 'Current Cluster', 'RashX Cluster'))
      
      ggsave(plot = p,
             filename = paste0(i, '.png'),
             path = here(output_dir, 'sankey2'),
             h = 4,
             w = 6)
      
    }) %>% invisible()
```


```{r}
library(pheatmap)

pheatmap_input <- odds_cluster %>% 
  select(group1,
         group2,
         f_group1) %>% 
  pivot_wider(names_from = group1, values_from = f_group1, values_fill = 0)

p <- pheatmap(mat = pheatmap_input %>% column_to_rownames('group2'), 
         angle_col = 0, 
         color = c('white', colorRampPalette(RColorBrewer::brewer.pal(n = 7, name = "Blues"))(100)),
         breaks = seq(0, 1, length.out = 102), display_numbers = TRUE)
```

```{r}
p <- pheatmap_input %>% 
  pivot_longer(cols = -1, names_to = 'group1', values_to = 'value') %>% 
  ggplot(aes(x = group1,
             y = group2,
             fill = value)) +
  geom_tile() +
  scale_fill_continuous(type = 'viridis', na.value = 'green') +
  theme(legend.position = 'right')

p
```


```{r}
library(parallel)

which_cluster <- 0

#map(merged_annotations$seurat_clusters %>% unique() %>% sort(), function(which_cluster) {
mclapply(merged_annotations$seurat_clusters %>% unique() %>% sort(), mc.cores = 40, function(which_cluster) {
  
  cluster_subset <- merged_annotations %>% 
    filter(seurat_clusters == which_cluster) %>% 
    group_by(cluster) %>% 
    add_count() %>%
    ungroup() %>% 
    mutate(pct = round(100 * n / n(), 1),
           cluster = paste0(cluster, ' ', pct, '%'))
  
  top_matches <- cluster_subset %>% select(cluster, n) %>% unique() %>% top_n(5, n)
  
  sankey_input <-  cluster_subset %>% 
    filter(cluster %in% top_matches$cluster) %>% 
  select(Current = seurat_clusters,
         RashX = cluster) %>% 
  make_long(Current, RashX)

p <- ggplot(sankey_input, 
                aes(x = x, 
                    next_x = next_x, 
                    node = node, 
                    next_node = next_node,
                    fill = factor(node),
                    label = node)) +
  geom_sankey(flow.alpha = 0.6,
              node.color = "black") +
  gg_sankey_components +
  geom_sankey_label(size = 4, color = "black", fill = "white") + 
  scale_fill_viridis_d() + 
  labs(x = '',
       title = paste0('Top 5 matches for cluster ', which_cluster))

ggsave(plot = p,
       filename = paste0(which_cluster, '.png'),
       path = here(output_dir, 'new_clusters'),
       h = 4,
       w = 4)
  
}) %>% invisible
```

### Old cluster centric
```{r}

#map(merged_annotations$cluster %>% unique() %>% sort(), function(which_cluster) {
mclapply(merged_annotations$cluster %>% unique() %>% sort(), mc.cores = 40, function(which_cluster) {
  
  cluster_subset <- merged_annotations %>% 
    filter(cluster == which_cluster) %>% 
    group_by(seurat_clusters) %>% 
    add_count() %>%
    ungroup() %>% 
    mutate(pct = round(100 * n / n(), 1),
           seurat_clusters = paste0(seurat_clusters, ', ', pct, '%'))
  
  top_matches <- cluster_subset %>% select(seurat_clusters, n) %>% unique() %>% top_n(5, n) %>% arrange(-n) %>% pull(seurat_clusters)
  
  sankey_input <-  cluster_subset %>% 
    filter(seurat_clusters %in% top_matches) %>% 
    select(Current = seurat_clusters,
           RashX = cluster) %>% 
    make_long(RashX, Current) %>% 
    arrange(node)

p <- ggplot(sankey_input, 
                aes(x = x, 
                    next_x = next_x, 
                    node = node, 
                    next_node = next_node,
                    fill = node,
                    label = node)) +
  geom_sankey(flow.alpha = 0.6,
              node.color = "black") +
  gg_sankey_components +
  geom_sankey_label(size = 4, color = "black", fill = "white") + 
  scale_fill_viridis_d() + 
  labs(x = '',
       title = paste0('Top 5 matches for ', which_cluster))

ggsave(plot = p,
       filename = paste0(str_replace(which_cluster, '/', '-'), '.png'),
       path = here(output_dir, 'old_clusters'),
       h = 4,
       w = 4)


  
}) %>% invisible()
```


### Annotate
```{r}
annotation_subcluster <- odds_supercluster %>% 
  group_by(group1) %>% 
  slice_max(f_group1) %>% 
  select(group1,
         supercluster = group2,
         f_in_supercluster = f_group1) %>% 
  left_join(rashx_clusters %>% select(order, cluster, supercluster) %>% unique()) %>% 
  left_join(odds_cluster %>% select(group1, cluster = group2, f_in_cluster = f_group1)) %>% 
  group_by(group1, supercluster) %>% 
  slice_max(f_in_cluster) %>% 
  ungroup() %>% 
  select(seurat_clusters = group1, cluster, supercluster, f_in_cluster, f_in_supercluster, order)

annotation_global <- odds_globalsuper %>% 
  group_by(group1) %>% 
  slice_max(f_group1) %>% 
  select(group1,
         supercluster = group2,
         f_in_supercluster = f_group1) %>% 
  left_join(rashx_clusters %>% select(order, cluster, supercluster) %>% unique()) %>% 
  left_join(odds_global %>% select(group1, cluster = group2, f_in_cluster = f_group1)) %>% 
  group_by(group1, supercluster) %>% 
  slice_max(f_in_cluster) %>% 
  ungroup() %>% 
  select(global = group1, global_cluster = cluster, global_supercluster = supercluster, f_in_global_cluster = f_in_cluster, f_in_global_supercluster = f_in_cluster, global_order = order)
```

```{r}
annotation_subcluster_levels <- annotation_subcluster %>% 
  select(order, cluster, supercluster) %>% 
  unique() %>% 
  arrange(order)

annotation_global_levels <- annotation_global %>% 
  select(global_order, global_cluster, global_supercluster) %>% 
  unique() %>% 
  arrange(global_order)

annotation_subcluster_levels
```

```{r}
lymphocyte_clusters <- str_subset(rashx_clusters$cluster, 'T|B|P') %>% unique()
innate_clusters <- str_subset(rashx_clusters$cluster, 'NK|ILC') %>% unique()
apc_clusters <- str_subset(rashx_clusters$cluster, 'M|DC|^LC') %>% unique()

new_annotations <- seuratobj@meta.data %>% 
  rownames_to_column() %>% 
  select(rowname, seurat_clusters, global = global) %>% 
  left_join(annotation_subcluster) %>% 
  left_join(annotation_global) %>% 
  mutate(cluster = factor(cluster, levels = annotation_subcluster_levels$cluster),
         supercluster = factor(supercluster, levels = unique(annotation_subcluster_levels$supercluster)),
         global_cluster = factor(global_cluster, levels = annotation_global_levels$global_cluster),
         global_supercluster = factor(global_supercluster, levels = unique(annotation_global_levels$global_supercluster)),
         celltype = case_when(
           cluster %in% lymphocyte_clusters ~ 'Lymphocyte',
           cluster %in% innate_clusters ~ 'Innate',
           cluster %in% apc_clusters ~ 'APC'),
         global_celltype = case_when(
           cluster %in% lymphocyte_clusters ~ 'Lymphocyte',
           cluster %in% innate_clusters ~ 'Innate',
           cluster %in% apc_clusters ~ 'APC')) %>% 
  column_to_rownames()

new_annotations 
```
### Add annotation
#### Also order factor levels
```{r}
seuratobj <- AddMetaData(seuratobj, new_annotations)
seuratobj$annotation <- seuratobj$supercluster

seuratobj
```
### Factor levels
```{r}
sample_order <- seuratobj@meta.data %>% select(patient, sample, sample_order) %>% unique() %>% arrange(sample_order) %>% as_tibble()
sample_order
```

```{r}
seuratobj$condition <- factor(seuratobj$condition, levels = c('HC', 'AD', 'PV'))
seuratobj$treatment <- factor(seuratobj$treatment, levels = c('None', 'Pre', 'Mid'))
seuratobj$group <- factor(seuratobj$group, levels = c('Responder', 'Non-responder'))
seuratobj$patient <- factor(seuratobj$patient, levels = unique(sample_order$patient))
seuratobj$sample <- factor(seuratobj$sample, levels = sample_order$sample)
```

### Add Metadata
```{r}
Idents(seuratobj) <- 'annotation'
Idents(seuratobj) %>% head()
```

### Save plots
#### Subclustering-based
```{r}
p <- seuratobj %>% seurat_feature(features = 'cluster', facet_hide = TRUE, legend_position = 'none', size = 0.1, alpha = 0.1, color_package = 'carto', color_palette = 'Bold')

ggsave(plot = p,
       filename = 'umap_annotated_cluster.png',
       path = output_dir,
       w = 4, 
       h = 4)

p
```


```{r}
p <- seuratobj %>% seurat_feature(features = 'supercluster', facet_hide = TRUE, legend_position = 'none', size = 0.1, alpha = 0.1, color_package = 'carto', color_palette = 'Bold')

ggsave(plot = p,
       filename = 'umap_annotated_supercluster.png',
       path = output_dir,
       w = 4, 
       h = 4)

p

```

#### Global-based
```{r}
p <- seuratobj %>% seurat_feature(features = 'global_cluster', facet_hide = TRUE, legend_position = 'none', size = 0.1, alpha = 0.1, color_package = 'carto', color_palette = 'Bold')

ggsave(plot = p,
       filename = 'umap_annotated_global_cluster.png',
       path = output_dir,
       w = 4, 
       h = 4)

p
```


```{r}
p <- seuratobj %>% seurat_feature(features = 'global_supercluster', facet_hide = TRUE, legend_position = 'none', size = 0.1, alpha = 0.1, color_package = 'carto', color_palette = 'Bold')

ggsave(plot = p,
       filename = 'umap_annotated_global_supercluster.png',
       path = output_dir,
       w = 4, 
       h = 4)

p

```

### Export
```{r}
seuratobj@meta.data %>% rownames_to_column() %>% write_rds(here(output_dir, 'metadata.rds'), compress = 'gz')

seuratobj %>% write_rds(here(data_dir, 'seuratobj_annotated.rds'))
```

## Session Info
```{r}
sessionInfo()
```
