---
title: "Annotation"
author: "David Wu"
---

### Use the here package for robust relative paths
```{r}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- 'analysis/output/06_annotate' # analysis file output directory
data_dir <- 'data/derived/tildra' # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(SeuratWrappers)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(googlesheets4)
library(ggsankey)
library(aricode)
theme_set(wutilities::theme_dwu())
```

### Functions
```{r}
calculate_agreement <- function(group1,
                                group2) {
  
  tibble('AMI' = aricode::AMI(group1, group2),
         'ARI' = aricode::ARI(group1, group2))
  
}

```

### Import
#### Clustered object
```{r}
seuratobj <- read_rds(here(data_dir, 'seuratobj_subcluster.rds'))
metadata <- seuratobj@meta.data %>% rownames_to_column()

seuratobj
```

#### Import annotations from RashX paper
```{r}
rashx <- read_rds(here('data/external/rashx.rds'))
rashx_clusters <- read_tsv(here('analysis/output/rashx/rashx_clusters.tsv.gz'))
rashx_clusters %>% head()
```

## Analysis
### Seurat label transfer
```{r}
transfer_dims <- 1:20

tic()
anchors <- FindTransferAnchors(reference = rashx, 
                               query = seuratobj,
                               dims = transfer_dims, 
                               features = VariableFeatures(seuratobj),
                               reduction = 'pcaproject')

predictions <- TransferData(anchorset = anchors,
                            refdata = rashx$Ident2,
                            dims = transfer_dims)

toc()


```


### Combine all annotations
```{r}
merged_annotations <- metadata %>% 
  select(rowname, id, local, global) %>% 
  left_join(predictions %>% rownames_to_column() %>% select(rowname, transfer = predicted.id))
  separate(rowname, sep = '_', into = c('barcode', NA), remove = FALSE) %>% 
  left_join(rashx_clusters) %>% 
  as_tibble()

merged_annotations
```
### Agreement metrics
```{r}
all_clusterings <- c('local', 'global', 'transfer', 'cluster', 'supercluster')

pairwise_table <- crossing('cluster1' = all_clusterings,
                           'cluster2' = all_clusterings) %>% 
  filter(cluster1 != cluster2) %>% 
  rowwise() %>% 
  mutate(combination = paste(sort(c(cluster1, cluster2)), collapse = ':')) %>% 
  group_by(combination) %>% 
  slice_max(cluster1)
  
pairwise_table
```

```{r}
agreement_metrics <- map(1:nrow(pairwise_table), function(i) {
  row_input <- pairwise_table[i, ]
  
  
  tibble('combination' = row_input$combination,
         calculate_agreement(merged_annotations[[row_input$cluster1]], merged_annotations[[row_input$cluster2]]) %>% 
    mutate(across(everything(), round, 3)))
  
}) %>% bind_rows() %>% 
  arrange(-AMI)

agreement_metrics
```

### Calculate odds and overlap
```{r}
clusters <- c('local', 'global') %>% set_names(.)
annotations <- c('cluster', 'supercluster') %>% set_names(.)

annotation_odds <- map(clusters, function(i) {
  map(annotations, function(j) {
    
    odds_table(merged_annotations, 
               group1 = i,
               group2 = j)
  })
})

annotation_odds$local$supercluster
```


```{r}
annotation_odds$local$supercluster %>% 
  mutate(combination = paste(group1, group2)) %>% 
  filter(odds > 1,
         pval < 0.05) %>% 
  ggplot(aes(x = odds + 0.001,
             y = f_score,
             label = combination,
             color = group1)) +
  geom_point(alpha = 0.5) + 
  ggrepel::geom_text_repel() + 
  scale_x_log10(limits = c(NA, 1e5)) +
  theme_dwu()
```

```{r}
input_odds <- annotation_odds$local$cluster

top_jaccard <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(jaccard)

top_overlap <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(overlap_coef)

top_f <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(f_group1)

top_f_score<- input_odds %>% 
  group_by(group1) %>% 
  slice_max(f_score)

top_odds <- input_odds %>% 
  group_by(group1) %>% 
  slice_max(odds)

top_comparison <- top_f %>% select(group1, f_group1, f = group2) %>% 
  left_join(top_overlap %>% select(group1, overlap = group2)) %>% 
  left_join(top_jaccard %>% select(group1, jaccard = group2)) %>% 
  left_join(top_f_score %>% select(group1, f_score = group2)) %>% 
  left_join(top_odds %>% select(group1, odds = group2)) %>% 
  mutate(match = ifelse(f == jaccard, 'Yes', 'No')) 

top_comparison %>% add_count(group1) %>% filter(match == 'No')
```
```{r}
annotation_odds$local$supercluster %>% mutate(jaccard = round(n_overlap/(n_group1 + n_group2 - n_overlap),3)) %>% 
  select(group1, group2, f_group1, f_group2, f_max, f_score, jaccard) %>% 
  arrange(-f_score) 
```


### Sankey plots
#### Local centric
```{r}
dpi <- 600

map(merged_annotations$local %>% unique() %>% sort(), function(i) {
  
  print2(i)
  
  # Local vs Global
  p <- plot_sankey1(merged_annotations %>% filter(local == i),
                    nodes = c('local', 'global'),
                    names = c('Local Cluster', 'Global Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'local', 'sankey1_local_vs_global'),
         dpi = dpi,
         h = 4,
         w = 6)   
  
  # Local vs RashX
  p <- plot_sankey1(merged_annotations %>% filter(local == i),
                    nodes = c('local', 'cluster'),
                    names = c('Local Cluster', 'RashX Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'local', 'sankey1_local_vs_rashx'),
         dpi = dpi,
         h = 4,
         w = 6)   
  
  # Local vs RashX (supercluster)
  p <- plot_sankey1(merged_annotations %>% filter(local == i),
                    nodes = c('local', 'supercluster'),
                    names = c('Local Cluster', 'RashX Supercluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'local', 'sankey1_local_vs_supercluster'),
         dpi = dpi,
         h = 4,
         w = 6)   
  
  # 2-way: local vs global and rashx
  p <- plot_sankey2(merged_annotations %>% filter(local == i),
                    nodes = c('cluster', 'local', 'global'),
                    names = c('RashX Cluster', 'Local Cluster', 'Global Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'local', 'sankey2_local_vs_rashx_global'),
         dpi = dpi,
         h = 4,
         w = 8)
  
  # 2-way: local vs rashx and rashx supercluster
  p <- plot_sankey2(merged_annotations %>% filter(local == i),
                    nodes = c('cluster', 'local', 'supercluster'),
                    names = c('Rashx Cluster', 'Local Cluster', 'RashX Supercluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'local', 'sankey2_local_vs_rashx_supercluster'),
         dpi = dpi,
         h = 4,
         w = 8)
      
}) %>% invisible()


```

#### Global centric
```{r}
map(merged_annotations$global %>% unique() %>% sort(), function(i) {
  
  print2(i)
  
  # Global vs local
  p <- plot_sankey1(merged_annotations %>% filter(global == i),
                    nodes = c('global', 'local'),
                    names = c('Global Cluster', 'Local Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'global', 'sankey1_global_vs_local'),
         dpi = dpi,
         h = 4,
         w = 6)   
  
  # Global vs RashX
  p <- plot_sankey1(merged_annotations %>% filter(global == i),
                    nodes = c('global', 'cluster'),
                    names = c('Global Cluster', 'RashX Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'global', 'sankey1_global_vs_rashx'),
         dpi = dpi,
         h = 4,
         w = 6)   
  
  # Global vs RashX (supercluster)
  p <- plot_sankey1(merged_annotations %>% filter(global == i),
                    nodes = c('global', 'supercluster'),
                    names = c('Global Cluster', 'RashX Supercluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'global', 'sankey1_global_vs_supercluster'),
         dpi = dpi,
         h = 4,
         w = 6)   
  
  # 2-way: global vs local and rashx
  p <- plot_sankey2(merged_annotations %>% filter(global == i),
                    nodes = c('cluster', 'global', 'local'),
                    names = c('RashX Cluster', 'Global Cluster', 'Local Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'global', 'sankey2_global_vs_rashx_local'),
         dpi = dpi,
         h = 4,
         w = 8)
  
  # 2-way: global vs rashx and rashx supercluster
  p <- plot_sankey2(merged_annotations %>% filter(global == i),
                    nodes = c('cluster', 'global', 'supercluster'),
                    names = c('Rashx Cluster', 'Global Cluster', 'RashX Supercluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'global', 'sankey2_global_vs_rashx_supercluster'),
         dpi = dpi,
         h = 4,
         w = 8)
      
}) %>% invisible()


```

#### RashX centric
```{r}
map(merged_annotations$cluster %>% unique() %>% sort(), function(i) {
  
  print2(i)
  
  # 2-way: rashx vs local and global
  p <- plot_sankey2(merged_annotations %>% filter(global == i),
                    nodes = c('global', 'cluster', 'local'),
                    names = c('Global Cluster', 'RashX Cluster', 'Local Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'rashx', 'sankey2_rashx'),
         dpi = dpi,
         h = 4,
         w = 8)
  
  # 2-way: rashx supercluster vs local and global
    p <- plot_sankey2(merged_annotations %>% filter(global == i),
                    nodes = c('global', 'supercluster', 'local'),
                    names = c('Global Cluster', 'RashX Supercluster', 'Local Cluster'))
  
  ggsave(plot = p,
         filename = paste0(i, '.png'),
         path = here(output_dir, 'rashx', 'sankey2_rashx_supercluster'),
         dpi = dpi,
         h = 4,
         w = 8)
      
}) %>% invisible()
```

```{r}
library(pheatmap)

pheatmap_input <- annotation_odds$local$cluster %>% 
  select(group1,
         group2,
         f_group1) %>% 
  pivot_wider(names_from = group1, values_from = f_group1, values_fill = 0)

p <- pheatmap(mat = pheatmap_input %>% column_to_rownames('group2'), 
         angle_col = 0, 
         color = c('white', colorRampPalette(RColorBrewer::brewer.pal(n = 7, name = "Blues"))(100)),
         breaks = seq(0, 1, length.out = 102), display_numbers = TRUE)
```

### Annotate
#### Factor level ordering
```{r}
rashx_clusters$supercluster %>% unique() %>% sort()
```

```{r}
supercluster_order <- c('Tcm', 
                        'Trm', 
                        'Tmm', 
                        'CTL',
                        'CTLem',
                        'CTLex',
                        'Tet',
                        'Tn',
                        'Treg',
                        'cmTreg',
                        'eTreg',
                        'ILC',
                        'NK',
                        'ILC/NK',
                        'B',
                        'Plasma',
                        'Mac',
                        'Mono',
                        'InfMono',
                        'DC',
                        'migDC',
                        'moDC',
                        'LC',
                        'Mast')

annotation_order <- rashx_clusters %>% select(cluster, supercluster) %>% 
  unique() %>% 
  mutate(supercluster = factor(supercluster, levels = supercluster_order)) %>% 
  arrange(supercluster, cluster) %>% 
  mutate(order = 1:n(),
         supercluster = as.character(supercluster))

annotation_order
```


#### Prepare addition of local and global annotations
```{r}
annotation_local <- annotation_odds$local$supercluster %>% 
  group_by(group1) %>% 
  slice_max(f_group1) %>% 
  select(group1,
         supercluster = group2,
         f_in_supercluster = f_group1) %>% 
  left_join(annotation_order) %>% 
  left_join(annotation_odds$local$cluster %>% select(group1, cluster = group2, f_in_cluster = f_group1)) %>% 
  group_by(group1, supercluster) %>% 
  slice_max(f_in_cluster) %>% 
  ungroup() %>% 
  select(local = group1, 
         local_cluster = cluster, 
         local_supercluster = supercluster, 
         local_order = order,
         f_in_local_cluster = f_in_cluster, 
         f_in_local_supercluster = f_in_supercluster)

annotation_global <- annotation_odds$global$supercluster %>% 
  group_by(group1) %>% 
  slice_max(f_group1) %>% 
  select(group1,
         supercluster = group2,
         f_in_supercluster = f_group1) %>% 
  left_join(annotation_order) %>% 
  left_join(annotation_odds$global$cluster %>% select(group1, cluster = group2, f_in_cluster = f_group1)) %>% 
  group_by(group1, supercluster) %>% 
  slice_max(f_in_cluster) %>% 
  ungroup() %>% 
  select(global = group1, 
         global_cluster = cluster, 
         global_supercluster = supercluster, 
         global_order = order,
         f_in_global_cluster = f_in_cluster, 
         f_in_global_supercluster = f_in_cluster)
```

```{r}
annotation_local_levels <- annotation_local %>% 
  select(local_order, local_cluster, local_supercluster) %>% 
  unique() %>% 
  arrange(local_order)

annotation_global_levels <- annotation_global %>% 
  select(global_order, global_cluster, global_supercluster) %>% 
  unique() %>% 
  arrange(global_order)

annotation_local_levels
```

#### Merged annotation information
```{r}
new_annotations <- seuratobj@meta.data %>% 
  rownames_to_column() %>% 
  select(rowname, local, global) %>% 
  left_join(annotation_local) %>% 
  left_join(annotation_global) %>% 
  mutate(local_cluster = factor(local_cluster, levels = annotation_local_levels$local_cluster),
         local_supercluster = factor(local_supercluster, levels = unique(annotation_local_levels$local_supercluster)),
         global_cluster = factor(global_cluster, levels = annotation_global_levels$global_cluster),
         global_supercluster = factor(global_supercluster, levels = unique(annotation_global_levels$global_supercluster))) %>% 
  column_to_rownames()

new_annotations 
```
### Add annotation
```{r}
seuratobj <- AddMetaData(seuratobj, new_annotations)
seuratobj$annotation <- seuratobj$global_cluster
Idents(seuratobj) <- 'annotation'
Idents(seuratobj) %>% head()
```
#### Ensure correct sample factor levels
```{r}
sample_order <- seuratobj@meta.data %>% 
  select(patient, sample, sample_order) %>% 
  unique() %>% 
  arrange(sample_order)
sample_order
```

```{r}
seuratobj$condition <- factor(seuratobj$condition, levels = c('HC', 'AD', 'PV'))
seuratobj$treatment <- factor(seuratobj$treatment, levels = c('None', 'Pre', 'Mid'))
seuratobj$group <- factor(seuratobj$group, levels = c('Responder', 'Non-responder'))
seuratobj$patient <- factor(seuratobj$patient, levels = unique(sample_order$patient))
seuratobj$sample <- factor(seuratobj$sample, levels = sample_order$sample)
```

### Save plots
#### Local
```{r}
p <- seuratobj %>% 
  seurat_feature(features = 'local_cluster', 
                 facet_hide = TRUE, 
                 legend_position = 'none',
                 size = 0.1, 
                 alpha = 0.1, 
                 color_package = 'carto', 
                 color_palette = 'Bold', 
                 rasterize_dpi = dpi)

ggsave(plot = p,
       filename = 'umap_annotated_local_cluster.png',
       dpi = dpi,
       path = output_dir,
       w = 4, 
       h = 4)

p
```


```{r}
p <- seuratobj %>% 
  seurat_feature(features = 'local_supercluster', 
                 facet_hide = TRUE, 
                 legend_position = 'none', 
                 size = 0.1, alpha = 0.1, 
                 color_package = 'carto', 
                 color_palette = 'Bold', 
                 rasterize_dpi = dpi)

ggsave(plot = p,
       filename = 'umap_annotated_local_supercluster.png',
       path = output_dir,
       dpi = dpi,
       w = 4, 
       h = 4)

p

```
```{r}
test <- seuratobj %>% RunUMAP(reduction = 'harmony', 
                              dims = 1:20, 
                              assay = 'RNA', 
                              seed.use = 1234,
                              n.neighbors = 30,
                              n.epochs = 500,
                              min.dist = 0.3)
```

#### Global
```{r}
p <- seuratobj %>% 
  seurat_feature(features = 'global_cluster', 
                 facet_hide = TRUE, 
                 legend_position = 'none',
                 size = 0.1, 
                 alpha = 0.1, 
                 color_package = 'carto', 
                 color_palette = 'Bold', 
                 rasterize_dpi = dpi)

ggsave(plot = p,
       filename = 'umap_annotated_global_cluster.png',
       dpi = dpi,
       path = output_dir,
       w = 4, 
       h = 4)

p
```
```{r}
p <- seuratobj %>% 
  seurat_feature(features = 'global_cluster', 
                 facets = 'global_cluster', 
                 legend_position = 'none',
                 size = 0.1, 
                 alpha = 0.1, 
                 label = FALSE,
                 color_package = 'carto', 
                 color_palette = 'Bold', 
                 rasterize_dpi = dpi)

ggsave(plot = p,
       filename = 'umap_annotated_global_cluster_facets.png',
       dpi = dpi,
       path = output_dir,
       w = 8, 
       h = 8)
```


```{r}
p <- seuratobj %>% 
  seurat_feature(features = 'global_supercluster', 
                 facet_hide = TRUE, 
                 legend_position = 'none', 
                 size = 0.1, alpha = 0.1, 
                 color_package = 'carto', 
                 color_palette = 'Bold', 
                 rasterize_dpi = dpi)

ggsave(plot = p,
       filename = 'umap_annotated_global_supercluster.png',
       path = output_dir,
       dpi = dpi,
       w = 4, 
       h = 4)

p

```
### Use global or local identities and set as cluster/supercluster in the object
Use this code to select between global or local identities as the default for a given analysis
Here we will set global as the default
```{r}
which_identity <- 'global'
which_cluster <- paste0(which_identity, '_cluster')
which_supercluster <- paste0(which_identity, '_supercluster')

seuratobj$cluster <- seuratobj[[which_cluster]] # set cluster as main annotation
seuratobj$supercluster <- seuratobj[[which_supercluster]] # set cluster as main annotation
Idents(seuratobj) <- 'cluster'
```
### Export
```{r}
seuratobj@meta.data %>% rownames_to_column() %>% write_rds(here(output_dir, 'metadata.rds'), compress = 'gz')

seuratobj %>% write_rds(here(data_dir, 'seuratobj_annotated.rds'))
```

## Session Info
```{r}
sessionInfo()
```
