---
title: "Tildrakizumab vs Secukinumab analysis"
author: "David Wu"
---

Set working directory to project directory
```{r setup}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- here('analysis/output/10_il23_vs_il17') # analysis file output directory
data_dir <- here('data/derived/tildra') # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(ggthemes)
library(ggforce)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(rcartocolor)
library(ggrepel)
library(DESeq2)
theme_set(theme_dwu()) # set default theme
```

### Functions
```{r}
extract_expression <- function(seuratobj,
                               cells = NULL,
                               genes,
                               total = TRUE,
                               normalize = TRUE,
                               log = FALSE,
                               assay = 'RNA',
                               slot = 'counts') {
  
  data_subset <- FetchData(object = seuratobj, 
                           cells = cells,
                           vars = genes,
                           assay = assay,
                           slot = slot) %>% 
    rownames_to_column() %>% 
    pivot_longer(cols = -rowname,
                 names_to = 'gene',
                 values_to = 'counts')
  
  if(total) {
  total_count <- colSums(GetAssayData(seuratobj, 
                                        slot = slot, 
                                        assay = assay))  
  if(!is.null(cells)) {
    total_count <- total_count[cells]
  }
  
  data_subset <- data_subset %>% 
    left_join(data.frame('total' = total_count) %>% rownames_to_column(), by = 'rowname')
  }
  
  if(normalize) {
   data_subset <- data_subset %>% 
      mutate(cpm = 1e6 * counts / total) 
  }
  
  data_subset
  
}

pseudobulk <- function(seuratobj,
                       genes,
                       cells = NULL,
                       group_by = 'ident',
                       pseudocount = 1,
                       rounding = 3,
                       assay = 'RNA',
                       slot = 'count') {
  
  metadata_groups <- FetchData(seuratobj, vars = group_by, cells = cells) %>% rownames_to_column()
  
  expression <- extract_expression(seuratobj,
                                   genes = genes,
                                   cells = cells,
                                   normalize = FALSE,
                                   log = FALSE,
                                   assay = assay,
                                   slot = slot) %>% 
    left_join(metadata_groups, by = 'rowname')
  
  totals <- expression %>% 
    select(rowname, total, all_of(group_by)) %>% 
    unique() %>% 
    group_by(across(all_of(group_by))) %>% 
    summarize(total = sum(total))
  
  merged <- expression %>% 
    group_by(across(all_of(c('gene', group_by)))) %>% 
    summarize(counts = sum(counts)) %>% 
    ungroup() %>% 
    left_join(totals) %>% 
    mutate(cpm = counts/total * 1e6,
           log10cpm = log10(cpm + pseudocount))
  
  merged %>% mutate(across(contains('cpm'), round, rounding))
  
}

pseudobulk_matrix <- function(seuratobj,
                              cells = NULL,
                              group_by = 'ident') {
  
  metadata_groups <- FetchData(seuratobj, vars = group_by, cells = cells) 
  metadata_groups$identifier <- apply( metadata_groups[ , group_by ] , 1 , paste , collapse = ':')
  
  if(is.null(cells)) {
    cells <- colnames(seuratobj)
  }
  
  # Ensure identical cell ordering
  metadata_groups <- metadata_groups[cells, ]
  expression_matrix <- t(seuratobj@assays$RNA@counts[, cells])
  aggregated_matrix <- sapply(by(expression_matrix, metadata_groups$identifier, colSums), identity)
   
  # slower for unknown reason:
  # tic()
  # expression_matrix <- seuratobj@assays$RNA@counts[, cells]
  # aggregated_matrix <- aggregate_matrix(expression_matrix, cols = metadata_groups$identifier)
  # toc()
  
  aggregated_matrix
}

de_function <- function(counts,
                        metadata,
                        design,
                        reference,
                        ens2symbol = NULL) {
  
  deseq <- DESeqDataSetFromMatrix(countData = counts,
                                  colData = metadata, 
                                  design = reformulate(design))
  
  deseq[[last(design)]] <- relevel(deseq[[last(design)]], ref = reference)
  
  tic()
  deseq <- DESeq(deseq)
  toc()
  
  deseq_res <- results(deseq, tidy = TRUE) %>% 
    as_tibble() %>% 
    mutate(across(where(is.numeric), round, 3))
  
  if(!is.null(ens2symbol)) {
    deseq_res <- inner_join(ens2symbol,
                            deseq_res, by = c('gene_id' = 'row'))
  }
  
  deseq_res
  
}

```


## Analysis
### Prepare IL23 dataset 
#### Load data
```{r}
seuratobj <- read_rds(here(data_dir, 'seuratobj_annotated.rds'))
seuratobj
```

#### Use global or local identities and set as cluster/supercluster in the object
```{r}
which_identity <- 'local'
which_cluster <- paste0(which_identity, '_cluster')
which_supercluster <- paste0(which_identity, '_supercluster')

seuratobj$cluster <- seuratobj[[which_cluster]] # set cluster as main annotation
seuratobj$supercluster <- seuratobj[[which_supercluster]] # set cluster as main annotation
Idents(seuratobj) <- 'cluster'

output_dir <- here(output_dir, which_identity)
dir.create(output_dir)
```

#### Metadata

```{r}
metadata_il23 <- seuratobj@meta.data %>% rownames_to_column()
```

#### IL23 genes table from IL23 profile analysis
```{r}
pv50 <- readxl::read_excel(here('analysis/input/PV50.xlsx'))
pv50_genes <- pv50$...1 %>% intersect(rownames(seuratobj))
```
```{r}
il23_genes_table <- read_tsv(here('analysis/output/09_il23_profile', which_identity, 'il23_genes_table.tsv'))
```
#### CD4 vs CD8 status based on ADT and RNA data
```{r}
cd_data <- FetchData(seuratobj, 
                     vars = c('CD4', 'CD8A', 'CD8B', 'ADT.CD4', 'ADT.CD8', 
                              'cluster', 'supercluster', 'celltype', 'treatment')) %>% 
  rownames_to_column() %>% 
  mutate(ADT = case_when(
    ADT.CD4 == 'Positive' & ADT.CD8 == 'Positive' ~ 'Double-positive',
    ADT.CD4 == 'Positive' ~ 'CD4',
    ADT.CD8 == 'Positive' ~ 'CD8',
    TRUE ~ 'Double-negative'
  ))
```

#### CD8
```{r}
p <- cd_data %>% 
  ggplot(aes(x = CD8A,
             y = CD8B,
             color = ADT)) +
  geom_point(alpha = 0.1,
             size = 0.5) +
  facet_wrap(~ADT)

p
```
#### CD4
```{r}
p <- cd_data %>% 
  ggplot(aes(x = CD4,
             y = CD8A,
             color = ADT)) +
  geom_point(alpha = 0.1,
             size = 0.5) +
  facet_wrap(~ADT)

p
```
#### Treg vs other T cells
```{r}
p <- cd_data %>% 
  filter(celltype == 'Lymphocyte',
         str_detect(supercluster, 'T')) %>% 
  ggplot(aes(x = CD8A,
             y = CD8B,
             color = ADT)) +
  geom_point(alpha = 0.1,
             size = 0.5) +
  facet_wrap(~supercluster)

p
```
#### Classify CD4/8 status based on protein then RNA
```{r}
cd_status <- cd_data %>% 
  mutate(CD = case_when(
    ADT == 'Double-positive' ~ 'Unknown',
    ADT == 'CD4' ~ 'CD4',
    ADT == 'CD8' ~ 'CD8',
    CD4 > 0.01 & (CD8A < 0.01 & CD8B < 0.01) ~ 'CD4',
    (CD8A > 0.01 | CD8B > 0.01) & CD4 < 0.01 ~ 'CD8',
    TRUE ~ 'Unknown'
  ))

cd_status %>% filter(treatment != 'None') %>% pull(CD) %>% table()
```

### Assign each cluster to closest match
```{r}
cluster_cd_tally <- cd_status %>% 
  group_by(cluster, CD) %>% 
  tally() %>% 
  pivot_wider(names_from = CD,
              values_from = n) %>% 
  rowwise() %>% 
  mutate(CD = ifelse(CD4 > CD8, 'CD4', 'CD8'))

cluster_cd_tally 
```

```{r}
cd_status <- cd_status %>% 
  select(-CD) %>% 
  left_join(cluster_cd_tally %>% select(cluster, CD))

tildra_cd4 <- cd_status %>% filter(CD == 'CD4', !str_detect(supercluster, 'Treg'), str_detect(cluster, 'T'), treatment %in% c('Pre', 'Mid'))
tildra_cd8 <- cd_status %>% filter(CD == 'CD8', !str_detect(supercluster, 'Treg'), str_detect(cluster, 'T'), treatment %in% c('Pre', 'Mid'))

tildra_barcodes <- c(tildra_cd4$rowname, tildra_cd8$rowname)
```

#### Extract counts matrix
```{r}
add_cd <- seuratobj@meta.data %>% rownames_to_column() %>% left_join(cd_status)
seuratobj$CD <- add_cd$CD
counts_il23 <- pseudobulk_matrix(seuratobj,
                                 cells = tildra_barcodes,
                                 group_by = c('id', 'CD'))
counts_il23[1:5, 1:5]
```


```{r}
metadata_il23_subset <- add_cd %>% 
  select(id, CD, patient, treatment, group) %>% 
  unique() %>% 
  filter(CD != 'Unknown',
         treatment != 'None') %>% 
  mutate(sample = paste(id, CD, sep = ':'),
         CellType = ifelse(CD == 'CD4', 'Teff', 'CD8')) 
  
metadata_il23_subset
```

#### Run DE
```{r}
de_il23 <- map(c('Teff', 'CD8'), function(i) {
  
  sample_subset <- metadata_il23_subset %>% 
    filter(CellType == i,
           group == 'Responder')
  
  de <- de_function(counts = as.matrix(counts_il23)[, sample_subset$sample],
                    metadata = sample_subset,
                    design = c('patient', 'treatment'), 
                    reference = 'Mid') %>% 
    mutate(CellType = i)
  
}) %>% 
  bind_rows() %>% 
  select(CellType, gene = row, baseMean, log2FoldChange, pvalue, padj) 

de_il23
```
```{r}
de_il23 %>% drop_na() %>% filter(padj < 0.05)
```

### Prepare IL23 Trm1 pseudobulk
```{r}
metadata_trm_subset <- add_cd %>% 
  select(id, patient, treatment, group, cluster) %>% 
  unique() %>% 
  filter(cluster == 'Trm1',
         treatment != 'None') %>% 
  mutate(sample = paste(id, cluster, sep = ':')) 
  
metadata_trm_subset
```
```{r}
trm_barcodes <- seuratobj@meta.data %>% filter(cluster == 'Trm1', treatment != 'None') %>% rownames()

counts_trm <- pseudobulk_matrix(seuratobj,
                                cells = trm_barcodes,
                                group_by = c('id', 'cluster'))
```

#### Run DE
```{r}
de_trm <- map(c('Trm1'), function(i) {
  
  sample_subset <- metadata_trm_subset %>% 
    filter(cluster == i,
           group == 'Responder')
  
  de <- de_function(counts = as.matrix(counts_trm)[, sample_subset$sample],
                    metadata = sample_subset,
                    design = c('patient', 'treatment'), 
                    reference = 'Mid') %>% 
    mutate(CellType = i)
  
}) %>% 
  bind_rows() %>% 
  select(CellType, gene = row, baseMean, log2FoldChange, pvalue, padj) 

de_trm
```
```{r}
de_trm %>% filter(padj < 0.05)
```

### Prepare IL17 dataset 
Preprocessed in "secukinumab.Rmd" notebook
#### Load data
```{r}
metadata_il17 <- read_tsv(here('analysis/output/secukinumab/liu_metadata.tsv.gz')) %>% 
  mutate(treatment = 
           case_when(
             Week == 0 ~ 'Pre',
             Week == 12 ~ 'Mid'),
         group = case_when(
           str_detect(PatientOutcome.Week52,'PASI75|PASI100') ~ 'Responder',
           str_detect(PatientOutcome.Week52,'PASI50|limited') ~ 'Non-responder',
         ))

counts_il17 <- read_tsv(here('analysis/output/secukinumab/liu_counts.tsv.gz')) %>% 
  column_to_rownames('gene_id') %>% as.matrix()

ens2symbol <- read_tsv(here('analysis/output/secukinumab/ens2symbol.tsv.gz'))
```
```{r}
metadata_il17
```

```{r}
counts_il17[1:5, 1:5]
```
#### Aggregate matrix by gene name
```{r}
gene_names <- ens2symbol %>% arrange(gene_id, rownames(counts_il17)) %>% pull(gene_name)
counts_il17 <- aggregate_matrix(counts_il17, rows = gene_names)
counts_il17[1:5, 1:5]
```

#### Subjects with PSO at Week 0 and 12
```{r}
metadata_il17_subset <- metadata_il17 %>% 
  filter(QC_Passed,
         treatment %in% c('Pre', 'Mid'),
         Status == 'PSO') %>% 
  select(sample, SubjectId, treatment, CellType, PASI, PASI.Reduction.Week0_Week52, PatientOutcome.Week52, group) %>% 
  group_by(SubjectId) %>% 
  add_count() %>% 
  arrange(SubjectId, treatment, CellType)

metadata_il17_subset
```

#### Run DE
```{r}
de_il17 <- map(c('Teff', 'CD8'), function(i) {
  
  sample_subset <- metadata_il17_subset %>% 
    filter(treatment %in% c('Pre', 'Mid'),
           CellType == i,
           group == 'Responder')
  
  de <- de_function(counts = counts_il17[, sample_subset$sample],
                    metadata = sample_subset,
                    design = c('SubjectId', 'treatment'),
                    reference = 'Mid') %>% 
    mutate(CellType = i)
  
}) %>% 
  bind_rows() %>% 
  select(CellType, gene = row, baseMean, log2FoldChange, pvalue, padj) 

de_il17
```
```{r}
de_il17 %>% filter(padj < 0.05)
```

#### Expression table
```{r}
cpm <- t(t(counts_il17) / colSums(counts_il17)) * 1e6
```


```{r}
logcpm <- log10(cpm + 0.01)
```

```{r}
expression_table_il17 <- cpm %>% 
  as.data.frame() %>% 
  rownames_to_column('gene') %>% 
  pivot_longer(cols = -gene,
               names_to = 'sample',
               values_to = 'cpm') %>% 
  inner_join(metadata_il17_subset) %>% 
  mutate(log10cpm = log10(cpm + 1))

expression_table_il17
```
### Compare DE genes
```{r}
de_compare <- inner_join(de_il17 %>% select(gene, CellType, log2FoldChange, padj),
                         de_il23 %>% select(gene, CellType, log2FoldChange, padj),
                         by = c('gene', 'CellType'),
                         suffix = c('_il17', '_il23'))

de_compare
```
### Genes changed in IL23 and unchanged in IL17

```{r}
genes_of_interest <- de_compare %>% 
  filter(padj_il23 < 0.05 & padj_il17 > 0.05 & log2FoldChange_il23 > 0) %>% 
  mutate(combination = paste(CellType, gene, sep = ':'))

genes_of_interest
```


```{r}
radar_genes <- il23_genes_table %>% filter(Status == 'Strict', cluster == 'Trm1') %>% pull(gene)
ray_genes <- c("CBLB", "CHN1", "CXCL13", "DAPK2", "GNLY", "GZMB", "LAG3", "LAYN", "PTPN13", "IL17A", "IL17F", "IL26", "IFNG")

genes_for_plotting <- c(genes_of_interest$gene, radar_genes, ray_genes) %>% unique()

expression_table_il23 <- pseudobulk(seuratobj = seuratobj, 
                                    genes = genes_for_plotting,
                                    cells = tildra_barcodes,
                                    group_by = c('id', 'CD')) %>% 
  left_join(metadata_il23_subset)

expression_table_il17_subset <- expression_table_il17 %>% 
  filter(gene %in% genes_for_plotting,
         CellType %in% c('Teff', 'CD8'))

expression_table_il23 %>% head()
```



```{r}
expression_table_merge <- 
  bind_rows(expression_table_il23 %>% select(gene, patient, treatment, group, CellType, cpm, log10cpm) %>% mutate(therapy = 'Tildra'),
            expression_table_il17_subset %>% select(gene, patient = SubjectId, treatment, group, CellType, cpm, log10cpm) %>% mutate(therapy = 'Secu')) %>% 
  mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')),
         combination = paste(CellType, gene, sep = ':')) 

expression_table_merge
```

#### Plot
```{r}
p <- expression_table_merge %>% 
  filter(combination %in% genes_of_interest$combination) %>% 
  
  ggplot(aes(x = therapy,
             y = log10cpm,
             fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~combination, scales = 'free_y', nrow = 6) +
  theme(legend.position = 'top') +
  scale_fill_few() +
  labs(y = 'log10 counts per million',
       x = 'Biologic Therapy')

p
```
#### Plot radar plot genes
```{r}
p <- expression_table_merge %>% 
  filter(gene %in% radar_genes) %>% 
  ggplot(aes(x = therapy,
             y = log10cpm,
             fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~combination, scales = 'free_y', nrow = 6) +
  theme(legend.position = 'top') +
  scale_fill_few() +
  labs(y = 'log10 counts per million',
       x = 'Biologic Therapy')

p
```
#### Ray genes
```{r}
p <- expression_table_merge %>% 
  filter(gene %in% ray_genes,
         CellType == 'CD8') %>% 
  ggplot(aes(x = therapy,
             y = log10cpm,
             fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~combination, scales = 'free_y', nrow = 3) +
  theme(legend.position = 'top') +
  scale_fill_few() +
  labs(y = 'log10 counts per million',
       x = 'Biologic Therapy')

p
```

```{r}
intersect(radar_genes, genes_of_interest$gene)
```


```{r}
intersect(pv50_genes, genes_of_interest$gene)
```
```{r}

```


#### Trm
```{r}
de_compare_trm <- inner_join(de_il17 %>% select(gene, CellType, log2FoldChange, padj),
                             de_trm %>% select(gene, log2FoldChange, padj),
                             by = c('gene'),
                             suffix = c('_il17', '_trm')) 

de_compare_trm
```
```{r}
genes_of_interest <- de_compare_trm %>% 
  filter(padj_trm < 0.05 & padj_il17 > 0.05 & log2FoldChange_trm > 0) %>% 
  mutate(combination = paste(CellType, gene, sep = ':'))

genes_of_interest
```


```{r}
radar_genes <- il23_genes_table %>% filter(Status == 'Strict', cluster == 'Trm1') %>% pull(gene)

genes_for_plotting <- c(genes_of_interest$gene, radar_genes) %>% unique()

expression_table_trm <- pseudobulk(seuratobj = seuratobj, 
                                    genes = genes_for_plotting,
                                    cells = trm_barcodes,
                                    group_by = c('id', 'cluster')) %>% 
  left_join(metadata_trm_subset)

expression_table_il17_subset <- expression_table_il17 %>% 
  filter(gene %in% genes_for_plotting,
         CellType %in% c('Teff', 'CD8'))

expression_table_il23 %>% head()
```



```{r}
expression_table_merge <- 
  bind_rows(expression_table_trm %>% 
              select(gene, patient, treatment, group, cpm, log10cpm) %>% 
              mutate(therapy = 'Trm',
                     CellType = 'CD8'),
            expression_table_trm %>% 
              select(gene, patient, treatment, group, cpm, log10cpm) %>% 
              mutate(therapy = 'Trm',
                     CellType = 'Teff'),
            expression_table_il17_subset %>% 
              select(gene, patient = SubjectId, treatment, group, CellType, cpm, log10cpm) %>% 
              mutate(therapy = 'Secu')) %>% 
  mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')),
         combination = paste(CellType, gene, sep = ':')) 

expression_table_merge
```

#### Plot
```{r}
p <- expression_table_merge %>% 
  filter(combination %in% genes_of_interest$combination) %>% 
  
  ggplot(aes(x = therapy,
             y = log10cpm,
             fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~combination, scales = 'free_y', nrow = 6) +
  theme(legend.position = 'top') +
  scale_fill_few() +
  labs(y = 'log10 counts per million',
       x = 'Biologic Therapy')

p
```
#### Plot radar plot genes
```{r}
p <- expression_table_merge %>% 
  filter(gene %in% radar_genes) %>% 
  ggplot(aes(x = therapy,
             y = log10cpm,
             fill = treatment)) +
  geom_boxplot() +
  facet_wrap(~combination, scales = 'free_y', nrow = 6) +
  theme(legend.position = 'top') +
  scale_fill_few() +
  labs(y = 'log10 counts per million',
       x = 'Biologic Therapy')

p
```
```{r}
```



### Export tables of interest
```{r}
de_compare %>% mutate(significant_il23 = ifelse(padj_il23 < 0.05, TRUE, FALSE),
                      significant_il17 = ifelse(padj_il17 < 0.05, TRUE, FALSE),
                      radar_gene = ifelse(gene %in% radar_genes, TRUE, FALSE),
                      pv50_gene = ifelse(gene %in% pv50_genes, TRUE, FALSE)) %>% 
  write_tsv(here(output_dir, 'deg_comparison.tsv'))
```
```{r}
de_compare_trm %>% mutate(significant_trm = ifelse(padj_trm < 0.05, TRUE, FALSE),
                          significant_il17 = ifelse(padj_il17 < 0.05, TRUE, FALSE),
                          radar_gene = ifelse(gene %in% radar_genes, TRUE, FALSE),
                          pv50_gene = ifelse(gene %in% pv50_genes, TRUE, FALSE)) %>% 
  write_tsv(here(output_dir, 'deg_comparison_trm.tsv'))
```



## Session Info
```{r}
sessionInfo()
```

### OLD
```{r}

de_il23_group_prepare <- de_pre_vs_mid_response %>% 
                               filter(cluster == 'Trm1') %>% 
                               select(gene, avg_log2FC_Trm1 = avg_log2FC, p_val_adj_Trm1 = p_val_adj)

de_il23_patient_prepare <- de_pre_vs_mid_patients %>% 
  filter(cluster == 'Trm1') %>% 
  select(gene, patient, avg_log2FC, p_val_adj) %>% 
  pivot_wider(names_from = 'patient',
              values_from = c('avg_log2FC', 'p_val_adj'))
```



### Comparison with Trms
```{r}
de_il17_prepare <- de_il17 %>% 
  mutate(log2FoldChange = -log2FoldChange) %>% 
  select(CellType,
         gene = gene,
         log2FoldChange,
         padj) %>% 
  group_by(CellType, gene) %>% 
  slice_max(abs(log2FoldChange)) %>% 
  slice_min(padj) %>% 
  ungroup() %>% 
  pivot_wider(names_from = 'CellType',
              values_from = c('log2FoldChange', 'padj'))

de_il23_prepare <- de_il23
```


```{r}
de_trm_prepare <- de_trm

de_compare_trm <- inner_join(de_il17_prepare,
                             de_il23_group_prepare) %>% 
  inner_join(de_il23_patient_prepare) %>% 

de_compare_trm %>% write_tsv(here(output_dir, 'trm_compare.tsv'))

```
```{r}

```