---
title: "DE analysis"
author: "David Wu"
---

Set working directory to project directory
```{r}
library(here)
```


### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- 'analysis/output/10_il23_profile' # analysis file output directory
data_dir <- 'data/derived/tildra' # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(SeuratWrappers)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(ggforce)
library(ggradar) # devtools::install_github("ricardo-bion/ggradar")
library(extrafont)
library(patchwork)

theme_set(theme_dwu()) # set default theme
```
### Function
```{r}
calculate_signature <- function(seuratobj, 
                                genes,
                                name = 'signature') {
  
  gene_data <- FetchData(seuratobj, genes)
  as.data.frame(rowSums(gene_data)) %>% set_names(name)
  
}
```


### Import seurat object
```{r}
seuratobj <- read_rds(here(data_dir, 'seuratobj_annotated.rds'))
visiumobj <- read_rds(here(data_dir, 'integrated_samples.rds'))
DefaultAssay(visiumobj) <- 'SCT'

visium_meta <- read_tsv(here('analysis/output/10_visium/visium_meta.tsv.gz')) %>% 
  mutate(id = ifelse(id == 'S234', 'S277', id))

seuratobj
```
### Select identity
```{r}
which_annotation <- 'global_supercluster'
seuratobj$annotation <- seuratobj[[which_annotation]]
Idents(seuratobj) <- 'annotation'

which_celltype <- ifelse(str_detect(which_annotation, 'global'), 'global_celltype', 'celltype')
seuratobj$celltype <- seuratobj[[which_celltype]]

output_dir <- here(output_dir, which_annotation)
dir.create(output_dir)
```

### Prepare metadata
```{r}
metadata <- seuratobj@meta.data %>% rownames_to_column()

patient_meta <- metadata %>% 
  select(id, patient, sample, condition, treatment, response, group) %>% 
  unique() %>% 
  as_tibble()

patient_meta
```

### Major clusters
```{r}
clusters_all <- metadata$annotation %>% unique()
clusters_t <- metadata %>% filter(str_detect(annotation, 'T')) %>% pull(annotation) %>% unique()
clusters_apc <- metadata %>% filter(celltype == 'APC') %>% pull(annotation) %>% unique()
```

```{r}
patient_display <- metadata %>% select(id, patient, condition, treatment, response, group, patient_label) %>% unique() %>% 
  filter(treatment != 'None') %>% 
  pivot_wider(names_from = treatment,
              values_from = id) %>%
  mutate(display = patient_label)

patient_display
  

```

```{r}
meta <- metadata %>% 
  select(rowname, id, annotation) %>% 
  bind_rows(visium_meta %>% select(rowname, id, annotation) %>% drop_na()) %>% 
  left_join(patient_meta) %>% 
  select(rowname, id, patient, sample, condition, treatment, response, group, annotation) %>% 
  mutate(display = paste(patient, group),
         description = factor(paste(condition, treatment) %>% str_remove(' None'),
                              levels = c('PV Pre',
                                         'PV Mid',
                                         'PV',
                                         'AD',
                                         'HC')),
         treatment = factor(treatment, levels = c('Pre', 'Mid', 'None')),
         cellgroup = case_when(
           str_detect(annotation, 'Trm') ~ 'Trm',
           annotation %in% clusters_apc ~ 'APC',
           annotation %in% clusters_t ~ 'Tcell',
           TRUE ~ annotation
         ))

meta
```




## Gene sets
IL23 responsive (genes that go down after tildra in responders)
IL17 responsive (genes that go up after IL17 treatment)
```{r}
pv50 <- readxl::read_excel('analysis/input/PV50.xlsx')
pv50_genes <- pv50$...1 %>% intersect(rownames(seuratobj))
```

### Tildra-responsive genes
Genes that change in responders but not non-responders
Group-level
```{r}
de_pre_vs_mid_response <- bind_rows(read_tsv(here('analysis/output/07_de', which_annotation, 'de_pre_vs_mid_responder.tsv.gz')) %>% mutate(response = 'Responder'),
                                    read_tsv(here('analysis/output/07_de', which_annotation, 'de_pre_vs_mid_nonresponder.tsv.gz')) %>% mutate(response = 'Non-responder'))

il23_group_response <- de_pre_vs_mid_response %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0,
         response == 'Responder') 

il23_group_response
```
```{r}
il23_nonresponsive <- de_pre_vs_mid_response %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0,
         response == 'Non-responder')

il23_nonresponsive
```
Patient-level
```{r}
de_pre_vs_mid_patients <- read_tsv(here('analysis/output/07_de', which_annotation,'de_pre_vs_mid_per_patient.tsv.gz'))

il23_patients_responsive <- de_pre_vs_mid_patients %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0) %>% 
  group_by(gene) %>% 
  add_count() %>% 
  mutate(patient = str_remove(group1, '_Pre'))

il23_patient_response <- il23_patients_responsive %>% 
  select(patient, gene, avg_log2FC) %>% 
  pivot_wider(names_from = patient,
              values_from = avg_log2FC) %>% 
  rowwise() %>% 
  mutate(n_responders = sum(!is.na(c(P1, P2, P3, P4, P5, P6))),
         n_nonresponders = sum(!is.na(c(P7, P8, P9))))

  
```

```{r}
il23_response <- il23_group_response %>% 
  left_join(il23_patient_response) %>%
  filter(response == 'Responder') %>% 
  arrange(cluster, -n_responders, -pct.diff) %>% 
  select(cluster, gene, avg_log2FC, p_val_adj, pct.1, pct.2, pct.diff, n_responders, n_nonresponders, starts_with('P'))

il23_response %>% write_tsv(here(output_dir, 'il23_response.tsv'))

il23_response
```


```{r}
il23_genes <- il23_response %>% filter(str_detect(cluster, 'Trm'), p_val_adj < 0.05, n_responders > n_nonresponders) %>% pull(gene)
il23_genes_strict <- il23_response %>% filter(str_detect(cluster, 'Trm'), p_val_adj < 0.05, n_responders > 2, n_responders > n_nonresponders, n_nonresponders < 2) %>% pull(gene) %>% unique()

il23_genes_strict
```

### Nonresponder signature
```{r}
de_responder_vs_nonresponder <- read_tsv(here('analysis/output/07_de', which_annotation, 'de_responder_vs_nonresponder_mid.tsv.gz'))
```

```{r}
nonresponder_markers <- de_responder_vs_nonresponder %>% 
  filter(avg_log2FC < 0,
         p_val_adj < 0.05) %>% 
  arrange(avg_log2FC)

nonresponder_markers
```
```{r}
nonresponder_genes <- nonresponder_markers %>% filter(str_detect(cluster, 'Trm')) %>% pull(gene)
```

### Tildra response in APCs
```{r eval=FALSE}
de_pre_vs_mid_apc <- read_tsv(here('analysis/output/07_de', which_annotation, 'de_pre_vs_mid.tsv.gz'))

apc_responders <- de_pre_vs_mid_apc %>% 
  filter(response == 'responders',
         p_val_adj < 0.05)

apc_responders
```

```{r eval=FALSE}
apc_nonresponders <- de_pre_vs_mid_apc %>% 
  filter(response == 'non-responders',
         p_val_adj < 0.05)

apc_nonresponders
```

### IL17 responsive genes from Harirchian et al. JID 2019
https://pubmed.ncbi.nlm.nih.gov/30543901/
```{r}
il17 <- bind_rows(
  readxl::read_xlsx('analysis/input/NIHMS1522377-supplement-2 Cho IL17A.xlsx', sheet = 'Table S1C', skip = 1) %>% mutate(time = 'T_1'),
  readxl::read_xlsx('analysis/input/NIHMS1522377-supplement-2 Cho IL17A.xlsx', sheet = 'Table S1D', skip = 1) %>% mutate(time = 'T_24'))
colnames(il17)[1] <- 'gene'
il17
```


```{r}
il17_responsive <- il17 %>% 
  filter(logFC > 0.4,
         FDR < 0.05) %>% 
  add_count(gene) %>% filter(n > 1)

il17_responsive
```


```{r}
il17_genes <- il17_responsive$gene %>% unique()

```


```{r}
secreted_signature <- c('IL17A', 'IL17F', 'IL26', 'CXCl13', 'GZMB', 'GNLY', 'PCSK7')
```

```{r}
il23_peripheral <- c('GNLY',
                     'HGPD',
                     'IL17A',
                     'IL17F',
                     'IL26',
                     'PTPN13',
                     'S100A4')
```

### IL23 response in keratinocytes, fibroblasts

```{r}
visiumobj <- visiumobj %>% calculate_signature(il23_genes, name = 'IL23_signature') %>% AddMetaData(object = visiumobj, metadata = .)
visiumobj <- visiumobj %>% calculate_signature(il17_genes, name = 'IL17_signature') %>% AddMetaData(object = visiumobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(il17_genes, name = 'IL17_signature') %>% AddMetaData(object = seuratobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(il23_genes, name = 'IL23_signature') %>% AddMetaData(object = seuratobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(il23_genes_strict, name = 'IL23_strict') %>% AddMetaData(object = seuratobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(il23_peripheral, name = 'IL23_peripheral') %>% AddMetaData(object = seuratobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(secreted_signature, name = 'Secreted') %>% AddMetaData(object = seuratobj, metadata = .)
```
```{r}
genes_of_interest <- c('IL23A', 'IL23R', 'IL17A', 'IL17F', 'ZFP36', 'ZFP36L2', nonresponder_genes, il17_genes, il23_genes, pv50_genes) %>% unique() 
```


### IL17 response in keratinocytes, fibroblasts, and APCs

```{r}
barcodes_visium <- visium_meta %>% 
  filter(annotation %in% c('fibroblast', 'keratinocyte')) %>% 
  pull(rowname)


```

### IL23 signature extraction , APCs, and Trms
```{r}
barcodes <- meta %>% filter(condition %in% c('PV', 'HC', 'AD'),
                            treatment %in% c('Pre', 'Mid', 'None'),
                            cellgroup %in% c('APC', 'Trm', 'Tcell')) %>% 
  pull(rowname)


```

### Extract all expression data
```{r}
data_matrix_scrna <- FetchData(seuratobj,
                         cells = barcodes,
                         vars = c(genes_of_interest, 'IL17_signature', 'IL23_signature', 'IL23_strict', 'Secreted', 'IL23_peripheral'))

data_matrix_visium <- FetchData(visiumobj,
                                cells = barcodes_visium,
                                vars = c(genes_of_interest, 'IL17_signature', 'IL23_signature', 'IL23_strict', 'Secreted'))

data_matrix <- bind_rows(data_matrix_scrna,
                         data_matrix_visium)

data_matrix %>% head()
```
```{r}
meta %>% select(rowname, id, sample, patient, condition, treatment, response, group, display, cellgroup)
```

```{r}
data_table <- 
  meta %>% select(rowname, id, sample, patient, condition, treatment, response, group, display, cellgroup) %>% 
  inner_join(data_matrix %>% rownames_to_column()) %>% 
  as_tibble()

data_table
```


```{r}
data_table_long <- data_table %>% 
  pivot_longer(cols = -c(rowname:cellgroup),
               names_to = 'gene',
               values_to = 'expression') 

data_table_long %>% head()
```
### Summarize by cluster and normalize (treatment patients only)
```{r}
data_table_long_tx_summarized <- 
  data_table_long %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  group_by(id, sample, patient, condition, display, treatment, response, group, gene, cellgroup) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(expression)) %>% 
  group_by(gene, cellgroup) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_tx_summarized
```

### Summarize by cluster and log-transforme, then normalize (treatment patients only)
```{r}
data_table_long_tx_summarized_log <- 
  data_table_long %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  group_by(id, sample, patient, condition, display, treatment, response, group, gene, cellgroup) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(log10(expression + 1))) %>% 
  group_by(gene, cellgroup) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_tx_summarized_log
```

###Summarize by cluster and normalize across all
```{r}
data_table_long_all_summarized <- 
  data_table_long %>% 
  group_by(id, sample, patient, condition, group, display, treatment, response, cellgroup, gene) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(expression)) %>% 
  group_by(gene, cellgroup) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_all_summarized

```

### IL23A stack
```{r}
display_features <- c('APC IL23A',
                      'keratinocyte IL23A',
                      'fibroblast IL23A')

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

plot_input
```

```{r}
plot_input %>% 
  ggplot(aes(x = gene,
             y = expression,
             fill = cellgroup)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~treatment + display,
             nrow = 2) +
  theme_dwu(legend.position = 'top') +
  ggthemes::scale_fill_few() 
```
```{r}
plot_input %>% 
  ggplot(aes(x = gene,
             y = binary,
             fill = cellgroup)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~treatment + display,
             nrow = 2) +
  theme_dwu(legend.position = 'top') +
  ggthemes::scale_fill_few() 
```
### Full profile
```{r}
tx_patients <- meta %>% filter(treatment != 'None') %>% pull(patient) %>% unique() %>% sort() %>% set_names(.)
tx_patients_responders <- meta %>% filter(treatment != 'None', group == 'Responder') %>% pull(patient) %>% unique() %>% sort() %>% set_names(.) 

tx_patients_nonresponders <- meta %>% filter(treatment != 'None', group == 'Non-responder') %>% pull(patient) %>% unique() %>% sort() %>% set_names(.) 


```

```{r}
display_features <- c('APC IL23A',
                      'Trm IL23R',
                      paste('Trm', il23_genes),
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm ZFP36',
                      'Trm ZFP36L2',
                      'keratinocyte IL17_signature',
                      'keratinocyte IL17A',
                      'keratinocyte IL17F') %>% 
  unique()

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

plot_input
```


```{r fig.height=8, fig.width=4}
p <- plot_input %>% 
  ggplot(aes(x = feature,
             y = binary,
             fill = gene)) +
  geom_col() +
  facet_wrap(~display + treatment, nrow = 7) +
  theme_dwu() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = '% Cells Expressed',
       x = '') 

p
```
### Radar plot
```{r fig.height=10, fig.width=10}
display_features <- c('Trm IL23_signature',
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F')

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
```


```{r fig.height=10, fig.width=10}
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```

```{r}
plot_input %>% select(sample, treatment, group, feature, expression, max, normalized) %>% 
  filter(feature == 'APC IL17A') %>% 
  mutate_if(is.numeric, round, 3)
```


```{r}
w <- 8
h <-  7
ggsave(plot = radar_responders,
       filename = 'radar_plot_responders.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar,
       filename = 'radar_plot.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)
```

### Radar IL23 strict set
```{r fig.height=10, fig.width=10}

genes_to_use <- il23_genes_strict
display_features <- c(paste('Trm', genes_to_use))

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, genes_to_use) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 1,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       filename = 'radar_plot_strict.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)

ggsave(plot = radar_responders,
       filename = 'radar_plot_responders_strict.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders_strict.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)
```

```{r}
de_pre_vs_mid_response %>% filter(response == 'Responder', str_detect(cluster, 'Trm'), p_val_adj < 0.01, avg_log2FC > 0) %>% pull(gene) %>% intersect(il23_genes)
```

### PV 50 radar
```{r fig.height=10, fig.width=10}

genes_to_use <- pv50_genes

display_features <- c(paste('Trm', genes_to_use))

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, all_of(genes_to_use)) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       device = cairo_pdf,
       filename = 'radar_plot_pv50_all.pdf',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)


```
```{r fig.height=10, fig.width=10}

genes_to_use <- intersect(pv50_genes, il23_genes)
genes_to_use <- intersect(pv50_genes, de_pre_vs_mid_response %>% filter(response == 'Responder', str_detect(cluster, 'Trm'), p_val_adj < 0.05, avg_log2FC > 0) %>% pull(gene))
#genes_to_use <- intersect(pv50_genes, il23_genes_strict)

display_features <- c(paste('Trm', genes_to_use))

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, all_of(genes_to_use)) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       device = cairo_pdf,
       filename = 'radar_plot_pv50_shared.pdf',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)


```

### Waterfall plot
```{r}

i <- 'P2'

p_waterfall <- map(tx_patients, function(i) {
  
  display_label <- paste0('Patient ', i, ': ', data_table_long_tx_summarized %>% filter(patient == i) %>% pull(group) %>% unique())
  data_table_long_tx_summarized %>% 
    filter(cellgroup == 'Trm',
           patient == i,
           gene %in% il23_genes_strict) %>% 
    ggplot(aes(x = reorder(gene, -normalized),
               y = normalized,
               color = treatment,
               group = gene)) +
    geom_point(size = 2) +
    geom_line(color = 'grey60', arrow = arrow(length = unit(0.2, "cm"), type = 'closed')) +
    theme_dwu(legend.position = 'right') +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_color_manual(values = c('orangered', 'dodgerblue4')) +
    labs(x = '',
         y = 'Average Trm Expression',
         title = display_label)
  
})

p_waterfall['P2']

  
```
```{r}
p_waterfall_responders <- p_waterfall[as.character(tx_patients_responders)] %>% wrap_plots(nrow = 2)
```

```{r}
p_waterfall_nonresponders <- p_waterfall[as.character(tx_patients_nonresponders)] %>% wrap_plots(nrow = 2)
```

### Statistics
```{r}
i <- 'P1'

il23_stats <- map(patient_meta %>% filter(treatment != 'None') %>% pull(patient) %>% unique(), function(i) {
  data_subset <- data_table_long_tx_summarized %>% 
  filter(patient == i,
         cellgroup == 'Trm',
         gene %in% il23_genes_strict) 
  
  
data_subset %>% 
  ggplot(aes(x = treatment,
             y = expression,
             color = gene,
             group = gene)) +
  geom_point() +
  geom_path() +
  theme_dwu()

group1 <- data_subset %>% filter(treatment == 'Pre') %>% pull(expression)
group2 <- data_subset %>% filter(treatment == 'Mid') %>% pull(expression)
res <- t.test(group1, group2, paired = TRUE)
  
tibble('patient' = i,
       'statistic' = res$statistic,
       'pval' = round(res$p.value, 3))

}) %>% bind_rows() 
il23_stats
```

```{r}
p <- map(patient_meta %>% filter(treatment != 'None') %>% pull(patient) %>% unique(), function(i) {
  data_subset <- data_table_long_tx_summarized %>% 
  filter(patient == i,
         cellgroup == 'Trm',
         gene %in% il23_genes_strict) 
  
  
  stat_subset <- il23_stats %>% filter(patient == i)
  
data_subset %>% 
  ggplot(aes(x = treatment,
             y = expression,
             color = gene,
             group = gene)) +
  geom_point() +
  geom_path() +
  theme_dwu() +
  labs(title = i,
       subtitle = paste0('p = ', stat_subset$pval))

}) %>% patchwork::wrap_plots()

p
```


### Select set
```{r fig.height=10, fig.width=10}
display_features <- c('Trm IL23_signature',
                      'APC IL23_signature',
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm IL26',
                      'APC IL26',
                      'Trm IL23A',
                      'APC IL23A',
                      'Trm IL23R',
                      'APC IL23R',
                      'Trm IFNG',
                      'APC IFNG')

plot_input <- data_table_long_tx_summarized %>%
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

bar_plot <- plot_input %>% 
  ggplot(aes(x = feature,
             y = expression + 0.01,
             fill = treatment)) +
  geom_col(position = 'dodge') +
  facet_wrap(~patient) 
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 4,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', response, ')'),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```


#### Log scale prior to normalization
```{r fig.height=10, fig.width=10}
display_features <- c('Trm IL23_signature',
                      'APC IL23_signature',
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm IL26',
                      'APC IL26',
                      'Trm IL23A',
                      'APC IL23A',
                      'Trm IL23R',
                      'APC IL23R',
                      'Trm IFNG',
                      'APC IFNG')

plot_input <- data_table_long_tx_summarized_log %>%
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 4,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', response, ')'),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```


```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       filename = 'radar_plot_custom.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)

ggsave(plot = radar_responders,
       filename = 'radar_plot_responders_custom.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders_custom.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)
```

### Stats
```{r}
data_table_long_all_summarized %>% 
  filter(gene == 'IL23_signature',
         cellgroup == 'Trm') %>% 
  ggplot(aes(x = condition,
             y = normalized,
             color = treatment)) +
  geom_sina() +
  theme_dwu(legend.position = 'right') +
  labs(y = 'Normalized Average Trm Expression')
```
```{r}

```
### Perfect separators of mid-response
```{r}
perfect_separators <- data_table_long_tx_summarized %>% 
  filter(gene %in% nonresponder_genes,
         treatment == 'Mid',
         cellgroup == 'Trm') %>% 
  select(group, group, gene, expression) %>% 
  group_by(group, group, gene) %>% 
  summarize(min = min(expression),
            max = max(expression)) %>% 
  pivot_wider(names_from = group,
              values_from = c(min, max)) %>% 
  filter(`min_Non-responder` > max_Responder)

perfect_separators$gene %>% unique()
```

### IL23-responsive gene expression in mid-treatment samples 
Strict
```{r}
p <- data_table_long_tx_summarized %>% 
  filter(gene %in% c(il23_genes_strict, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm') %>% 
  ggplot(aes(x = reorder(gene, expression),
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  #facet_wrap(~gene, scales = 'free_x') +
  theme_dwu(legend.position = 'top') +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  geom_jitter(alpha = 0.8, size = 2) +
  coord_flip() +
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_strict.pdf',
       path = output_dir,
       h = 14,
       w = 6)

p

```
Full
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm') %>% 
  ggplot(aes(x = reorder(gene, expression),
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_sina(alpha = 0.8, size = 2) +
  #facet_wrap(~gene, scales = 'free_x') +
  theme_dwu(legend.position = 'top') +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  coord_flip() +
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_full.pdf',
       path = output_dir,
       h = 44,
       w = 6)

p
```
### Facets
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm') %>% 
  ggplot(aes(x = group,
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_point(alpha = 0.8, size = 2, aes(color = patient)) +
  facet_wrap(~gene, scales = 'free_y', ncol = 15) +
  theme_dwu(legend.position = 'top') +
  rcartocolor::scale_color_carto_d() +
  #scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_facet_full.pdf',
       path = output_dir,
       h = 30,
       w = 17)
```

```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes_strict, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm') %>% 
  ggplot(aes(x = group,
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_point(alpha = 0.8, size = 2, aes(color = patient)) +
  facet_wrap(~gene, scales = 'free_y', ncol = 10) +
  theme_dwu(legend.position = 'top') +
  #scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  rcartocolor::scale_color_carto_d(palette = 'Prism') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_facet_strict.pdf',
       path = output_dir,
       h = 14,
       w = 12)
```




#### Secretion
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% 'Secreted',
         treatment == 'Mid',
         cellgroup == 'Trm') %>% 
  ggplot(aes(x = reorder(patient, -expression),
             y = expression,
             fill = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', color = 'black') +
  theme_dwu(legend.position = 'top') +
  #rcartocolor::scale_color_carto_d(palette = 'Prism') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4')) +
  labs(x = 'Patient',
       y = 'Trm Average Expression',
       title = 'Secreted Gene Signature')

p
```

#### Peripheral Th17 IL23
```{r}


p <- data_table_long_tx_summarized %>% 
  
  filter(gene == 'IL23_peripheral',
         treatment == 'Mid',
         cellgroup == 'Trm') %>% 
  ggplot(aes(x = reorder(patient, -expression),
             y = expression,
             fill = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', color = 'black', fun = sum) +
  theme_dwu(legend.position = 'top') +
  #rcartocolor::scale_color_carto_d(palette = 'Prism') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4')) +
  labs(x = 'Patient',
       y = 'Trm Average Expression',
       title = 'Peripheral IL23 Gene Signature')

p
```

### Statistics
```{r}

```
### T vs APC
```{r}
p <- data_table_long %>% 
  filter(treatment != 'None',
         gene %in% c('IL17A', 'IL17F'),
         group %in% c('APC', 'Trm', 'Tcell')) %>% 
  group_by(patient, treatment, group, group, gene) %>% 
  summarize(expression = mean(expression)) %>% 
  ggplot(aes(x = patient,
             y = expression,
             fill = group)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~group + treatment + gene) +
  theme_dwu(legend.position = 'top')
  
p
```


### PV, AD, HC
```{r fig.height=6, fig.width=12}
display_features <- c('APC IL23A',
                      'Trm IL23R',
                      paste('Trm', il23_genes),
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm ZFP36',
                      'Trm ZFP36L2') %>% 
  unique()

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(cellgroup, group)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

p <- plot_input %>% 
  ggplot(aes(x = feature,
             y = normalized,
             fill = condition)) +
  geom_boxplot()+
  theme_dwu(legend.position = 'top') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = 'Normalized Expression',
       x = '') +
  ggthemes::scale_fill_few()

p
```

```{r}

meta %>% 
  filter(annotation %in% clusters_apc,
         treatment != 'None') %>% 
  group_by(group, annotation, treatment) %>% 
  tally() %>% 
  pivot_wider(names_from = c(group, treatment),
              values_from = n) %>% 
  View()

```

## Session Info
```{r}
sessionInfo()
```



