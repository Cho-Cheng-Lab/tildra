---
title: "DE analysis"
author: "David Wu"
---

Set working directory to project directory
```{r}
library(here)
```


### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- here('analysis/output/10_il23_profile') # analysis file output directory
data_dir <- here('data/derived/tildra') # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(SeuratWrappers)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(ggforce)
library(ggradar) # devtools::install_github("ricardo-bion/ggradar")
library(extrafont)
library(patchwork)

theme_set(theme_dwu()) # set default theme
```
### Functions
```{r}
calculate_signature <- function(seuratobj, 
                                genes,
                                name = 'signature') {
  
  gene_data <- FetchData(seuratobj, genes)
  as.data.frame(rowSums(gene_data)) %>% set_names(name)
  
}
```

### Import data
#### scRNA-seq
```{r}
seuratobj <- read_rds(here(data_dir, 'seuratobj_annotated.rds'))
seuratobj
```
#### Visium
```{r}
visiumobj <- read_rds(here(data_dir, 'integrated_samples.rds'))
DefaultAssay(visiumobj) <- 'SCT'

visium_meta <- read_tsv(here('analysis/output/10_visium/visium_meta.tsv.gz')) %>% 
  mutate(id = ifelse(id == 'S234', 'S277', id))
```

### Use global or local identities and set as cluster/supercluster in the object
```{r}
which_identity <- 'local'
which_cluster <- paste0(which_identity, '_cluster')
which_supercluster <- paste0(which_identity, '_supercluster')

seuratobj$cluster <- seuratobj[[which_cluster]] # set cluster as main annotation
seuratobj$supercluster <- seuratobj[[which_supercluster]] # set cluster as main annotation
Idents(seuratobj) <- 'cluster'

output_dir <- here(output_dir, which_identity)
dir.create(output_dir)
```

### Prepare metadata
```{r}
metadata <- seuratobj@meta.data %>% rownames_to_column()

metadata_sample <- metadata %>% 
  select(id, patient, sample, condition, treatment, response, group, patient_label, sample_label) %>% 
  unique() %>% 
  as_tibble()

metadata_sample
```

#### Combine visium and scRNA metadata
```{r}
metadata_combined <- metadata %>% 
  bind_rows(visium_meta %>% select(rowname, id, cluster) %>% drop_na()) %>% 
  select(rowname, 
         id, 
         sample, 
         patient,
         condition, 
         treatment, 
         group, 
         cluster, 
         supercluster, 
         celltype, 
         sample_label, 
         patient_label) %>% 
  mutate(cellgroup = case_when(
    str_detect(cluster, 'Trm1') ~ 'Trm1',
    celltype == 'APC' ~ 'APC',
    str_detect(cluster, 'T') ~ 'Tcell',
    TRUE ~ cluster
  ))

metadata_combined
```

### Major clusters
```{r}
clusters_all <- metadata$cluster %>% unique()
```

## Gene sets
### PV50
```{r}
pv50 <- readxl::read_excel(here('analysis/input/PV50.xlsx'))
pv50_genes <- pv50$...1 %>% intersect(rownames(seuratobj))
```

### Tildra-responsive genes
#### Genes that change in responders but not non-responders
##### Group-level
```{r}
de_pre_vs_mid_response <- bind_rows(
  read_tsv(here('analysis/output/08_de', which_cluster, 'de_pre_vs_mid_responder.tsv.gz')) %>% 
    mutate(response = 'Responder'),
  read_tsv(here('analysis/output/08_de', which_cluster, 'de_pre_vs_mid_nonresponder.tsv.gz')) %>% 
    mutate(response = 'Non-responder'))

il23_group_response <- de_pre_vs_mid_response %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0,
         response == 'Responder') 

il23_group_response
```

##### Patient-level
```{r}
de_pre_vs_mid_patients <- read_tsv(here('analysis/output/08_de', which_cluster,'de_pre_vs_mid_per_patient.tsv.gz'))

de_patient_tally <- de_pre_vs_mid_patients %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0) %>% 
  group_by(cluster, gene, group) %>% 
  tally() %>% 
  pivot_wider(names_from = group,
              values_from = n,
              values_fill = 0)

de_patient_tally
```

```{r}
il23_response <- il23_group_response %>% 
  left_join(de_patient_tally)

il23_response
```

### Response genes per cluster
```{r}
il23_genes_all <- map(clusters_all %>% set_names(.), function(i) {
  
  il23_response %>% 
    filter(cluster == i, 
           p_val_adj < 0.05, 
           Responder > `Non-responder`) %>% 
    pull(gene)
  
})

il23_genes_strict <- map(clusters_all %>% set_names(.), function(i) {
  
  il23_response %>% 
    filter(cluster == i, 
           p_val_adj < 0.05, 
           Responder > `Non-responder`,
           Responder > 2, 
           `Non-responder` < 2) %>% 
    pull(gene) 
  
})

il23_genes_strict$Tcm
```

### IL17 responsive genes from Harirchian et al. JID 2019
https://pubmed.ncbi.nlm.nih.gov/30543901/
```{r}
il17 <- bind_rows(
  readxl::read_xlsx(here('analysis/input/NIHMS1522377-supplement-2 Cho IL17A.xlsx'), sheet = 'Table S1C', skip = 1) %>% mutate(time = 'T_1'),
  readxl::read_xlsx(here('analysis/input/NIHMS1522377-supplement-2 Cho IL17A.xlsx'), sheet = 'Table S1D', skip = 1) %>% mutate(time = 'T_24'))
colnames(il17)[1] <- 'gene'
il17
```


```{r}
il17_responsive <- il17 %>% 
  filter(logFC > 0.4,
         FDR < 0.05) %>% 
  add_count(gene) %>% filter(n > 1)

il17_responsive
```


```{r}
il17_genes <- il17_responsive$gene %>% unique()

```

#### Other signatures of interest
```{r}
secreted_signature <- c('IL17A', 'IL17F', 'IL26', 'CXCl13', 'GZMB', 'GNLY', 'PCSK7')

il23_peripheral <- c('GNLY',
                     'HGPD',
                     'IL17A',
                     'IL17F',
                     'IL26',
                     'PTPN13',
                     'S100A4')
```

### Extract all expression data
```{r}
extract_expression <- function(seuratobj,
                               cells = NULL,
                               genes,
                               normalize = TRUE,
                               log = FALSE,
                               assay = 'RNA',
                               slot = 'counts') {
  
  data_subset <- FetchData(object = seuratobj, 
                           cells = cells,
                           vars = genes,
                           assay = assay,
                           slot = slot) %>% 
    rownames_to_column() %>% 
    pivot_longer(cols = -rowname,
                 names_to = 'gene',
                 values_to = 'counts')
  
  total_count <- colSums(GetAssayData(seuratobj, 
                                        slot = slot, 
                                        assay = assay))
  
  if(!is.null(cells)) {
    total_count <- total_count[cells]
  }
  
  data_subset <- data_subset %>% 
    left_join(data.frame('total' = total_count) %>% rownames_to_column(), by = 'rowname')
  
  if(normalize) {
   data_subset <- data_subset %>% 
      mutate(cpm = 1e6 * counts / total) 
  }
  
  data_subset
  
}

pseudobulk <- function(seuratobj,
                       genes,
                       cells = NULL,
                       group_by = 'ident',
                       pseudocount = 1,
                       rounding = 3,
                       assay = 'RNA',
                       slot = 'count') {
  
  metadata_groups <- FetchData(seuratobj, vars = group_by, cells = cells) %>% rownames_to_column()
  
  expression <- extract_expression(seuratobj,
                                   genes = genes,
                                   cells = cells,
                                   normalize = FALSE,
                                   log = FALSE,
                                   assay = assay,
                                   slot = slot) %>% 
    left_join(metadata_groups, by = 'rowname')
  
  totals <- expression %>% 
    select(rowname, total, all_of(group_by)) %>% 
    unique() %>% 
    group_by(across(all_of(group_by))) %>% 
    summarize(total = sum(total))
  
  merged <- expression %>% 
    group_by(across(all_of(c('gene', group_by)))) %>% 
    summarize(counts = sum(counts)) %>% 
    ungroup() %>% 
    left_join(totals) %>% 
    mutate(cpm = counts/total * 1e6,
           log10cpm = log10(cpm + pseudocount))
  
  merged %>% mutate(across(contains('cpm'), round, rounding))
  
}

plot_radar <- function(df,
                       group_by = NULL,
                       features = NULL,
                       colors = NULL,
                       title = '',
                       legend.position = 'top') {
  
  if(is.null(group_by)) {
    
    group_by <- colnames(df)[1]
    
  }
    
  if(is.null(features)) {
    
    features <- colnames(df) %>% setdiff(group_by)
    
  }
  
  radar_input <- df %>% 
    select(all_of(c(group_by, features))) %>% 
    mutate(across(all_of(features), scales::rescale_max))
  
  radar_input[[group_by]] <- droplevels(radar_input[[group_by]])
  
  radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = colors,
            plot.title = title,
            legend.position = legend.position) +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
}
```

```{r}
tildra_barcodes <- metadata %>% filter(treatment %in% c('Pre', 'Mid')) %>% pull(rowname)

pseudo <- pseudobulk(seuratobj,
                     cells = tildra_barcodes,
                     genes = il23_genes_all %>% unlist() %>% unique(),
                     group_by = c('cluster', 'id')) %>% 
  left_join(metadata_sample %>% select(id, patient, treatment, group, sample_label, patient_label))

pseudo 
```

### Radar plot
```{r fig.height=10, fig.width=10}
plot_radar_patient <- function(pseudo,
                               cluster,
                               patient,
                               genes,
                               normalize = TRUE,
                               scale = c('within', 'across'),
                               colors = c('dodgerblue4', 'orangered'),
                               title = 'patient_label') {
  
  plot_title <- pseudo %>% filter(patient == {{patient}}) %>% pull({{title}}) %>% unique()
  
  plot_input <- pseudo %>% 
    filter(cluster %in% {{cluster}}, 
           gene %in% {{genes}}) %>% 
    select(patient,
           feature = gene,
           treatment,
           normalized = cpm)
  
  if(scale == 'across') {
    
    plot_input <- plot_input %>% 
      group_by(feature) %>% 
      mutate(feature_max = max(normalized),
             normalized = normalized/feature_max) %>% 
      filter(patient == {{patient}})
    
  } else if(scale == 'within') {
    
    plot_input <- plot_input %>% 
      filter(patient == {{patient}}) %>% 
      group_by(feature) %>% 
      mutate(feature_max = max(normalized),
             normalized = normalized/feature_max)
  }
  
  
  radar_input <- plot_input %>% 
    mutate(treatment = droplevels(treatment)) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized)
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = colors,
            legend.position = 'top', 
            font.radar = 'Arial') +
    theme(text = element_text(family = 'Arial'),
          plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) +
    ggtitle(plot_title)
  
  p_radar
  
}
```


```{r}
plot_radar_patient(pseudo = pseudo,
                   cluster = 'Trm1',
                   patient = 'P2',
                   genes = il23_genes_all$Trm1)
```

```{r fig.height=10, fig.width=10}
which_scale <- 'within'

map(c('within', 'across'), function(which_scale) {
  
  map(pseudo$cluster %>% unique() %>% sort() %>% as.character(), function(which_cluster) {
  
  if(length(il23_genes_all[[which_cluster]]) > 1) {
    
    p <- map(pseudo$patient %>% unique() %>% sort() %>% as.character(), function(which_patient) {
      
      print2(paste(which_patient, which_cluster))
      
       if((pseudo %>% filter(patient == which_patient,
                           cluster == which_cluster,
                           gene %in% il23_genes_strict[[which_cluster]]) %>% 
         nrow() > 0)) {
      plot_radar_patient(pseudo = pseudo,
                         cluster = which_cluster,
                         patient = which_patient,
                         genes = il23_genes_all[[which_cluster]],
                         scale = which_scale)
       } else {
         ggplot()
       }
    }) %>% wrap_plots() 
    
    print2('Saving')
    ggsave(plot = p,
           h = 10,
           w = 10,
           path = here(output_dir, 'radar_all'),
           filename = paste0(which_scale, '_', which_cluster, '.png'))
    
  }
    
    if(length(il23_genes_strict[[which_cluster]]) > 1) {
      
      print2(paste(which_patient, which_cluster))
      
      p <- map(pseudo$patient %>% unique() %>% sort(), function(which_patient) {
        
        if((pseudo %>% filter(patient == which_patient,
                              cluster == which_cluster,
                              gene %in% il23_genes_strict[[which_cluster]]) %>% 
            nrow() > 0)) {
          
          plot_radar_patient(pseudo = pseudo,
                             cluster = which_cluster,
                             patient = which_patient,
                             genes = il23_genes_strict[[which_cluster]],
                             scale = which_scale)
        } else {
          ggplot()
        }
        
        
      }) %>% wrap_plots()
      
      ggsave(plot = p,
             h = 10,
             w = 10,
             path = here(output_dir, 'radar_strict'),
             filename = paste0(which_scale, '_', which_cluster, '.png'))
    }
  })
})

```




```{r}
 
      
    }
```

```{r fig.height=10, fig.width=10}
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```



```{r}
mtcars_radar <- mtcars %>% 
  as_tibble(rownames = "group") %>% 
  mutate_at(vars(-group), scales::rescale) %>% 
  tail(4) %>% 
  select(1:10)

mtcars_radar
```

```{r}
mtcars_radar <- mtcars %>% 
  as_tibble(rownames = "group") %>% 
  #mutate_at(vars(-group), scales::rescale) %>% 
  mutate(across(where(is.numeric), scales::rescale)) %>% 
  tail(4) %>% 
  select(1:10)

mtcars_radar
```

```{r}
df <- pseudo %>% 
  filter(cluster == 'Trm1', patient == 'P5') %>% 
  select(gene, treatment, cpm) %>% 
  pivot_wider(names_from = 'gene', values_from = 'cpm') 

df
plot_radar(df = df, group_by = 'treatment')
```


```{r}
extract_signature <- function(seuratobj,
                              cells = NULL,
                              genes,
                              name = 'signature',
                              normalize = TRUE,
                              log = FALSE,
                              assay = 'RNA',
                              slot = 'counts') {
  
  seuratobj <- seuratobj %>% add_signature(genes = genes, name = name)
  
}

add_signature <- function(seuratobj, 
                          genes,
                          name = 'signature') {
  
  seuratobj <- seuratobj %>% PercentageFeatureSet(features = genes, col.name = name)
  seuratobj[[name]] <- seuratobj[[name]] * seuratobj[['nCount_RNA']]/100
  
  seuratobj
}
```


```{r}
data_matrix_scrna <- FetchData(seuratobj,
                         cells = barcodes,
                         vars = c(genes_of_interest, 'IL17_signature', 'IL23_signature', 'IL23_strict', 'Secreted', 'IL23_peripheral'))

data_matrix_visium <- FetchData(visiumobj,
                                cells = barcodes_visium,
                                vars = c(genes_of_interest, 'IL17_signature', 'IL23_signature', 'IL23_strict', 'Secreted'))

data_matrix <- bind_rows(data_matrix_scrna,
                         data_matrix_visium)

data_matrix %>% head()
```
```{r}
metadata_combined %>% select(rowname, id, sample, patient, condition, treatment, response, group, patient_display, cellgroup)
```

```{r}
data_table <- 
  metadata_combined %>% select(rowname, id, sample, patient, condition, treatment, response, group, patient_display, cellgroup) %>% 
  inner_join(data_matrix %>% rownames_to_column()) %>% 
  as_tibble()

data_table
```


```{r}
data_table_long <- data_table %>% 
  pivot_longer(cols = -c(rowname:cellgroup),
               names_to = 'gene',
               values_to = 'expression') 

data_table_long %>% head()
```
### Summarize by cluster and normalize (treatment patients only)
```{r}
data_table_long_tx_summarized <- 
  data_table_long %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  group_by(id, sample, patient, condition, patient_display, treatment, response, group, gene, cellgroup) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(expression)) %>% 
  group_by(gene, cellgroup) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_tx_summarized
```

### Summarize by cluster and log-transforme, then normalize (treatment patients only)
```{r}
data_table_long_tx_summarized_log <- 
  data_table_long %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  group_by(id, sample, patient, condition, patient_display, treatment, response, group, gene, cellgroup) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(log10(expression + 1))) %>% 
  group_by(gene, cellgroup) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_tx_summarized_log
```
#### Normalize within patient
```{r}
data_table_long_tx_summarized_patient <- 
  data_table_long %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  group_by(id, sample, patient, condition, patient_display, treatment, response, group, gene, cellgroup) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(expression)) %>% 
  group_by(gene, cellgroup, patient) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_tx_summarized_patient
```

###Summarize by cluster and normalize across all
```{r}
data_table_long_all_summarized <- 
  data_table_long %>% 
  group_by(id, sample, patient, condition, group, patient_display, treatment, response, cellgroup, gene) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(expression)) %>% 
  group_by(gene, cellgroup) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_all_summarized

```

### IL23A stack
```{r}
display_features <- c('APC IL23A',
                      'keratinocyte IL23A',
                      'fibroblast IL23A')

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

plot_input
```

```{r}
plot_input %>% 
  ggplot(aes(x = gene,
             y = expression,
             fill = cellgroup)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~treatment + patient_display,
             nrow = 2) +
  theme_dwu(legend.position = 'top') +
  ggthemes::scale_fill_few() 
```
```{r}
plot_input %>% 
  ggplot(aes(x = gene,
             y = binary,
             fill = cellgroup)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~treatment + patient_display,
             nrow = 2) +
  theme_dwu(legend.position = 'top') +
  ggthemes::scale_fill_few() 
```
### Full profile
```{r}
tx_patients <- metadata_combined %>% filter(treatment != 'None') %>% pull(patient) %>% unique() %>% sort() %>% set_names(.)
tx_patients_responders <- metadata_combined %>% filter(treatment != 'None', group == 'Responder') %>% pull(patient) %>% unique() %>% sort() %>% set_names(.) 

tx_patients_nonresponders <- metadata_combined %>% filter(treatment != 'None', group == 'Non-responder') %>% pull(patient) %>% unique() %>% sort() %>% set_names(.) 


```

```{r}
display_features <- c('APC IL23A',
                      'Trm1 IL23R',
                      paste('Trm1', il23_genes_all),
                      'Trm1 IL17A',
                      'Trm1 IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm1 ZFP36',
                      'Trm1 ZFP36L2',
                      'keratinocyte IL17_signature',
                      'keratinocyte IL17A',
                      'keratinocyte IL17F') %>% 
  unique()

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

plot_input
```


```{r fig.height=8, fig.width=4}
p <- plot_input %>% 
  ggplot(aes(x = feature,
             y = binary,
             fill = gene)) +
  geom_col() +
  facet_wrap(~patient_display + treatment, nrow = 7) +
  theme_dwu() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = '% Cells Expressed',
       x = '') 

p
```
### Radar plot
```{r fig.height=10, fig.width=10}
display_features <- c('Trm1 IL23_signature',
                      'Trm1 IL17A',
                      'Trm1 IL17F',
                      'APC IL17A',
                      'APC IL17F')

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
```


```{r fig.height=10, fig.width=10}
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```

```{r}
plot_input %>% select(sample, treatment, group, feature, expression, max, normalized) %>% 
  filter(feature == 'APC IL17A') %>% 
  mutate_if(is.numeric, round, 3)
```


```{r}
w <- 8
h <-  7
ggsave(plot = radar_responders,
       filename = 'radar_plot_responders.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar,
       filename = 'radar_plot.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)
```

### Radar IL23 strict set
```{r fig.height=10, fig.width=10}

genes_to_use <- il23_genes_strict
display_features <- c(paste('Trm1', genes_to_use))

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, genes_to_use) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 1,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       filename = 'radar_plot_strict.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)

ggsave(plot = radar_responders,
       filename = 'radar_plot_responders_strict.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders_strict.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)
```

```{r}
de_pre_vs_mid_response %>% filter(response == 'Responder', str_detect(cluster, 'Trm1'), p_val_adj < 0.01, avg_log2FC > 0) %>% pull(gene) %>% intersect(il23_genes_all)
```

### PV 50 radar
```{r fig.height=10, fig.width=10}

genes_to_use <- pv50_genes

display_features <- c(paste('Trm1', genes_to_use))

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, all_of(genes_to_use)) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       device = cairo_pdf,
       filename = 'radar_plot_pv50_all.pdf',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)


```
### pv50 and IL23 response
```{r fig.height=10, fig.width=10}

genes_to_use <- intersect(pv50_genes, il23_genes_all)
genes_to_use <- intersect(pv50_genes, de_pre_vs_mid_response %>% filter(response == 'Responder', str_detect(cluster, 'Trm1'), p_val_adj < 0.05, avg_log2FC > 0) %>% pull(gene))
# genes_to_use <- intersect(pv50_genes, il23_genes_strict)

display_features <- c(paste('Trm1', genes_to_use))

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, all_of(genes_to_use)) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       device = cairo_pdf,
       filename = 'radar_plot_pv50_shared.pdf',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)


```

### Normalize per patient
### PV 50 radar
```{r fig.height=10, fig.width=10}

genes_to_use <- pv50_genes

display_features <- c(paste('Trm1', genes_to_use))

plot_input <- data_table_long_tx_summarized_patient %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, all_of(genes_to_use)) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       device = cairo_pdf,
       filename = 'radar_plot_pv50_all_per_patient.pdf',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)


```
### pv50 and IL23 response
```{r fig.height=10, fig.width=10}

genes_to_use <- intersect(pv50_genes, il23_genes_all)
genes_to_use <- intersect(pv50_genes, de_pre_vs_mid_response %>% filter(response == 'Responder', str_detect(cluster, 'Trm1'), p_val_adj < 0.05, avg_log2FC > 0) %>% pull(gene))
# genes_to_use <- intersect(pv50_genes, il23_genes_strict)

display_features <- c(paste('Trm1', genes_to_use))

plot_input <- data_table_long_tx_summarized_patient %>% 
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, all_of(genes_to_use)) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  skin_ids <- plot_input %>% filter(patient == which_patient) %>% pull(id) %>% unique()
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', skin_ids[1], ', ', skin_ids[2], '): ', response),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})

radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       device = cairo_pdf,
       filename = 'radar_plot_pv50_shared_per_patient.pdf',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)


```

### Waterfall plot
```{r}

i <- 'P2'

p_waterfall <- map(tx_patients, function(i) {
  
  display_label <- paste0('Patient ', i, ': ', data_table_long_tx_summarized %>% filter(patient == i) %>% pull(group) %>% unique())
  data_table_long_tx_summarized %>% 
    filter(cellgroup == 'Trm1',
           patient == i,
           gene %in% il23_genes_strict) %>% 
    ggplot(aes(x = reorder(gene, -normalized),
               y = normalized,
               color = treatment,
               group = gene)) +
    geom_point(size = 2) +
    geom_line(color = 'grey60', arrow = arrow(length = unit(0.2, "cm"), type = 'closed')) +
    theme_dwu(legend.position = 'right') +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_color_manual(values = c('orangered', 'dodgerblue4')) +
    labs(x = '',
         y = 'Average Trm1 Expression',
         title = display_label)
  
})

p_waterfall['P2']

  
```
```{r}
p_waterfall_responders <- p_waterfall[as.character(tx_patients_responders)] %>% wrap_plots(nrow = 2)
```

```{r}
p_waterfall_nonresponders <- p_waterfall[as.character(tx_patients_nonresponders)] %>% wrap_plots(nrow = 2)
```

### Statistics
```{r}
i <- 'P1'

il23_stats <- map(metadata_sample %>% filter(treatment != 'None') %>% pull(patient) %>% unique(), function(i) {
  data_subset <- data_table_long_tx_summarized %>% 
  filter(patient == i,
         cellgroup == 'Trm1',
         gene %in% il23_genes_strict) 
  
  
data_subset %>% 
  ggplot(aes(x = treatment,
             y = expression,
             color = gene,
             group = gene)) +
  geom_point() +
  geom_path() +
  theme_dwu()

group1 <- data_subset %>% filter(treatment == 'Pre') %>% pull(expression)
group2 <- data_subset %>% filter(treatment == 'Mid') %>% pull(expression)
res <- t.test(group1, group2, paired = TRUE)
  
tibble('patient' = i,
       'statistic' = res$statistic,
       'pval' = round(res$p.value, 3))

}) %>% bind_rows() 
il23_stats
```

```{r}
p <- map(metadata_sample %>% filter(treatment != 'None') %>% pull(patient) %>% unique(), function(i) {
  data_subset <- data_table_long_tx_summarized %>% 
  filter(patient == i,
         cellgroup == 'Trm1',
         gene %in% il23_genes_strict) 
  
  
  stat_subset <- il23_stats %>% filter(patient == i)
  
data_subset %>% 
  ggplot(aes(x = treatment,
             y = expression,
             color = gene,
             group = gene)) +
  geom_point() +
  geom_path() +
  theme_dwu() +
  labs(title = i,
       subtitle = paste0('p = ', stat_subset$pval))

}) %>% patchwork::wrap_plots()

p
```


### Select set
```{r fig.height=10, fig.width=10}
display_features <- c('Trm1 IL23_signature',
                      'APC IL23_signature',
                      'Trm1 IL17A',
                      'Trm1 IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm1 IL26',
                      'APC IL26',
                      'Trm1 IL23A',
                      'APC IL23A',
                      'Trm1 IL23R',
                      'APC IL23R',
                      'Trm1 IFNG',
                      'APC IFNG')

plot_input <- data_table_long_tx_summarized %>%
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

bar_plot <- plot_input %>% 
  ggplot(aes(x = feature,
             y = expression + 0.01,
             fill = treatment)) +
  geom_col(position = 'dodge') +
  facet_wrap(~patient) 
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 4,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', response, ')'),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```


#### Log scale prior to normalization
```{r fig.height=10, fig.width=10}
display_features <- c('Trm1 IL23_signature',
                      'APC IL23_signature',
                      'Trm1 IL17A',
                      'Trm1 IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm1 IL26',
                      'APC IL26',
                      'Trm1 IL23A',
                      'APC IL23A',
                      'Trm1 IL23R',
                      'APC IL23R',
                      'Trm1 IFNG',
                      'APC IFNG')

plot_input <- data_table_long_tx_summarized_log %>%
  filter(treatment %in% c('Pre', 'Mid')) %>% 
  mutate(feature = paste(cellgroup, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Mid')))
  
  
  response <- plot_input %>% filter(patient == which_patient) %>% pull(group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 4,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', response, ')'),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots(ncol = 3)
radar_responders <- radar_plots[1:6] %>% patchwork::wrap_plots(ncol = 3)
radar_nonresponders <- radar_plots[7:9] %>% patchwork::wrap_plots(ncol = 3)

radar
```


```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       filename = 'radar_plot_custom.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)

ggsave(plot = radar_responders,
       filename = 'radar_plot_responders_custom.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders_custom.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)
```

### Stats
```{r}
data_table_long_all_summarized %>% 
  filter(gene == 'IL23_signature',
         cellgroup == 'Trm1') %>% 
  ggplot(aes(x = condition,
             y = normalized,
             color = treatment)) +
  geom_sina() +
  theme_dwu(legend.position = 'right') +
  labs(y = 'Normalized Average Trm1 Expression')
```
```{r}

```
### Perfect separators of mid-response
```{r}
perfect_separators <- data_table_long_tx_summarized %>% 
  filter(gene %in% nonresponder_genes,
         treatment == 'Mid',
         cellgroup == 'Trm1') %>% 
  select(group, group, gene, expression) %>% 
  group_by(group, group, gene) %>% 
  summarize(min = min(expression),
            max = max(expression)) %>% 
  pivot_wider(names_from = group,
              values_from = c(min, max)) %>% 
  filter(`min_Non-responder` > max_Responder)

perfect_separators$gene %>% unique()
```

### IL23-responsive gene expression in mid-treatment samples 
Strict
```{r}
p <- data_table_long_tx_summarized %>% 
  filter(gene %in% c(il23_genes_strict, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm1') %>% 
  ggplot(aes(x = reorder(gene, expression),
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  #facet_wrap(~gene, scales = 'free_x') +
  theme_dwu(legend.position = 'top') +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  geom_jitter(alpha = 0.8, size = 2) +
  coord_flip() +
  labs(x = '',
       y = 'Trm1 Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_strict.pdf',
       path = output_dir,
       h = 14,
       w = 6)

p

```
Full
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes_all, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm1') %>% 
  ggplot(aes(x = reorder(gene, expression),
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_sina(alpha = 0.8, size = 2) +
  #facet_wrap(~gene, scales = 'free_x') +
  theme_dwu(legend.position = 'top') +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  coord_flip() +
  labs(x = '',
       y = 'Trm1 Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_full.pdf',
       path = output_dir,
       h = 44,
       w = 6)

p
```
### Facets
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes_all, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm1') %>% 
  ggplot(aes(x = group,
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_point(alpha = 0.8, size = 2, aes(color = patient)) +
  facet_wrap(~gene, scales = 'free_y', ncol = 15) +
  theme_dwu(legend.position = 'top') +
  rcartocolor::scale_color_carto_d() +
  #scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = '',
       y = 'Trm1 Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_facet_full.pdf',
       path = output_dir,
       h = 30,
       w = 17)
```

```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes_strict, 'IL17A', 'IL17F'),
         treatment == 'Mid',
         cellgroup == 'Trm1') %>% 
  ggplot(aes(x = group,
             y = expression,
             color = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_point(alpha = 0.8, size = 2, aes(color = patient)) +
  facet_wrap(~gene, scales = 'free_y', ncol = 10) +
  theme_dwu(legend.position = 'top') +
  #scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  rcartocolor::scale_color_carto_d(palette = 'Prism') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = '',
       y = 'Trm1 Average Expression')

ggsave(plot = p,
       filename = 'bar_mid_separators_facet_strict.pdf',
       path = output_dir,
       h = 14,
       w = 12)
```




#### Secretion
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% 'Secreted',
         treatment == 'Mid',
         cellgroup == 'Trm1') %>% 
  ggplot(aes(x = reorder(patient, -expression),
             y = expression,
             fill = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', color = 'black') +
  theme_dwu(legend.position = 'top') +
  #rcartocolor::scale_color_carto_d(palette = 'Prism') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4')) +
  labs(x = 'Patient',
       y = 'Trm1 Average Expression',
       title = 'Secreted Gene Signature')

p
```

#### Peripheral Th17 IL23
```{r}


p <- data_table_long_tx_summarized %>% 
  
  filter(gene == 'IL23_peripheral',
         treatment == 'Mid',
         cellgroup == 'Trm1') %>% 
  ggplot(aes(x = reorder(patient, -expression),
             y = expression,
             fill = group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', color = 'black', fun = sum) +
  theme_dwu(legend.position = 'top') +
  #rcartocolor::scale_color_carto_d(palette = 'Prism') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4')) +
  labs(x = 'Patient',
       y = 'Trm1 Average Expression',
       title = 'Peripheral IL23 Gene Signature')

p
```

### Statistics
```{r}

```
### T vs APC
```{r}
p <- data_table_long %>% 
  filter(treatment != 'None',
         gene %in% c('IL17A', 'IL17F'),
         group %in% c('APC', 'Trm1', 'Tcell')) %>% 
  group_by(patient, treatment, group, group, gene) %>% 
  summarize(expression = mean(expression)) %>% 
  ggplot(aes(x = patient,
             y = expression,
             fill = group)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~group + treatment + gene) +
  theme_dwu(legend.position = 'top')
  
p
```


### PV, AD, HC
```{r fig.height=6, fig.width=12}
display_features <- c('APC IL23A',
                      'Trm1 IL23R',
                      paste('Trm1', il23_genes_all),
                      'Trm1 IL17A',
                      'Trm1 IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm1 ZFP36',
                      'Trm1 ZFP36L2') %>% 
  unique()

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(cellgroup, group)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

p <- plot_input %>% 
  ggplot(aes(x = feature,
             y = normalized,
             fill = condition)) +
  geom_boxplot()+
  theme_dwu(legend.position = 'top') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = 'Normalized Expression',
       x = '') +
  ggthemes::scale_fill_few()

p
```

```{r}

metadata_combined %>% 
  filter(cluster %in% clusters_apc,
         treatment != 'None') %>% 
  group_by(group, cluster, treatment) %>% 
  tally() %>% 
  pivot_wider(names_from = c(group, treatment),
              values_from = n) %>% 
  View()

```

## Session Info
```{r}
sessionInfo()
```



