---
title: "DE analysis"
author: "David Wu"
---

Set working directory to project directory
```{r setup}
require(knitr)
opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- 'analysis/output/10_il23_profile' # analysis file output directory
data_dir <- 'data/derived/seurat' # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(SeuratWrappers)
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(ggforce)
library(ggradar) # devtools::install_github("ricardo-bion/ggradar")
library(extrafont)
```
### Function
```{r}
calculate_signature <- function(seuratobj, 
                                genes,
                                name = 'signature') {
  
  gene_data <- FetchData(seuratobj, genes)
  as.data.frame(rowSums(gene_data)) %>% set_names(name)
  
}
```


### Import seurat object
```{r}
seuratobj <- read_rds(file.path(data_dir, 'seuratobj_annotated.rds'))
visiumobj <- read_rds(file.path(data_dir, 'integrated_samples.rds'))
DefaultAssay(visiumobj) <- 'SCT'

seurat_meta <- seuratobj@meta.data %>% rownames_to_column()
visium_meta <- read_tsv('analysis/output/10_visium/visium_meta.tsv.gz') %>% 
  mutate(id = ifelse(id == 'skin234', 'skin277', id))

seuratobj
```
```{r}
patient_meta <- seurat_meta %>% 
  separate(sample, into = c('patient', NA), sep = '-', remove = FALSE) %>% 
  mutate(response_group = ifelse(response == 'full', 'Responder', 'Nonresponder')) %>% 
  select(id, patient, sample, condition, treatment, response, response_group) %>% 
  unique() %>% 
  as_tibble()

patient_meta
```
### Major clusters
```{r}
clusters_all <- seurat_meta$merged_label %>% unique()
clusters_t <- clusters_all %>% str_subset('T')
clusters_apc <- clusters_all %>% setdiff(clusters_t)
```

```{r}
meta <- seurat_meta %>% 
  select(rowname, id, merged_label) %>% 
  bind_rows(visium_meta %>% select(rowname, id, merged_label) %>% drop_na()) %>% 
  left_join(patient_meta) %>% 
  select(rowname, id, patient, sample, condition, treatment, response, response_group, merged_label) %>% 
  mutate(display = paste(patient, response_group),
         description = factor(paste(condition, treatment) %>% str_remove(' None'),
                              levels = c('PV Pre',
                                         'PV Post',
                                         'PV',
                                         'AD',
                                         'HC')),
         treatment = factor(treatment, levels = c('Pre', 'Post', 'None')),
         group = case_when(
           merged_label == 'Trm_merge' ~ 'Trm',
           merged_label %in% clusters_all ~ 'APC',
           TRUE ~ merged_label
         ))

meta
```




## Gene sets
IL23 responsive (genes that go down after tildra in responders)
IL17 responsive (genes that go up after IL17 treatment)
```{r}
pv50 <- readxl::read_excel('analysis/input/PV50.xlsx')
#intersect(pv50$...1)
```

### Tildra-responsive genes
Genes that change in responders but not non-responders
Group-level
```{r}
de_pre_vs_post_response <- read_tsv('analysis/output/07_de/de_pre_vs_post_response.tsv.gz')

il23_group_response <- de_pre_vs_post_response %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0) %>% 
  group_by(gene) %>% 
  add_count() %>% 
  filter(response == 'responders', n == 1) 

il23_group_response
```
```{r}
il23_nonresponsive <- de_pre_vs_post_response %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0) %>% 
  group_by(gene) %>% 
  add_count() %>% 
  filter(response != 'responders') 

il23_nonresponsive
```
Patient-level
```{r}
de_pre_vs_post_patients <- read_tsv('analysis/output/07_de/de_pre_vs_post_patients.tsv.gz')
il23_patients_responsive <- de_pre_vs_post_patients %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0) %>% 
  group_by(gene) %>% 
  add_count() 

il23_patient_response <- il23_patients_responsive %>% 
  select(patient, gene, avg_log2FC) %>% 
  pivot_wider(names_from = patient,
              values_from = avg_log2FC) %>% 
  rowwise() %>% 
  mutate(n_responders = sum(!is.na(c(S2, S3, S4, S7))),
         n_nonresponders = sum(!is.na(c(S1, S5, S6))))
  
```

```{r}
il23_response <- il23_group_response %>% 
  left_join(il23_patient_response) %>%
  filter(response == 'responders') %>% 
  arrange(-n_responders, -pct.diff) %>% 
  select(gene, avg_log2FC, p_val_adj, pct.1, pct.2, pct.diff, n_responders, n_nonresponders, starts_with('S'))

il23_response %>% write_tsv(file.path(output_dir, 'il23_response.tsv'))
```


```{r}
il23_genes <- il23_response %>% filter(p_val_adj < 0.05, !str_detect(gene, 'mm10')) %>% pull(gene)
il23_genes_strict <- il23_response %>% filter(p_val_adj < 0.05, n_responders > 1, !str_detect(gene, 'mm10')) %>% pull(gene)
```

### Nonresponder signature
```{r}
de_responders_vs_nonresponders <- read_tsv('analysis/output/07_de/de_responders_vs_nonresponders.tsv.gz')
```

```{r}
nonresponder_markers <- de_responders_vs_nonresponders %>% 
  filter(treatment == 'Post',
         avg_log2FC < 0,
         p_val_adj < 0.05) %>% 
  arrange(avg_log2FC)

nonresponder_markers
```
```{r}
nonresponder_genes <- nonresponder_markers$gene
```

### IL17 responsive genes from Harirchian et al. JID 2019
https://pubmed.ncbi.nlm.nih.gov/30543901/
```{r}
il17 <- bind_rows(
  readxl::read_xlsx('analysis/input/NIHMS1522377-supplement-2 Cho IL17A.xlsx', sheet = 'Table S1C', skip = 1) %>% mutate(time = 'T_1'),
  readxl::read_xlsx('analysis/input/NIHMS1522377-supplement-2 Cho IL17A.xlsx', sheet = 'Table S1D', skip = 1) %>% mutate(time = 'T_24'))
colnames(il17)[1] <- 'gene'
il17
```


```{r}
il17_responsive <- il17 %>% 
  filter(logFC > 0.4,
         FDR < 0.05) %>% 
  add_count(gene) %>% filter(n > 1)

il17_responsive
```


```{r}
il17_genes <- il17_responsive$gene %>% unique()

```


```{r}
secreted_signature <- c('IL17A', 'IL17F', 'IL26', 'CXCl13', 'GZMB', 'GNLY', 'PCSK7')
```


### IL23 response in keratinocytes, fibroblasts

```{r}
visiumobj <- visiumobj %>% calculate_signature(il23_genes, name = 'IL23_signature') %>% AddMetaData(object = visiumobj, metadata = .)
visiumobj <- visiumobj %>% calculate_signature(il17_genes, name = 'IL17_signature') %>% AddMetaData(object = visiumobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(il17_genes, name = 'IL17_signature') %>% AddMetaData(object = seuratobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(il23_genes, name = 'IL23_signature') %>% AddMetaData(object = seuratobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(il23_genes_strict, name = 'IL23_strict') %>% AddMetaData(object = seuratobj, metadata = .)
seuratobj <- seuratobj %>% calculate_signature(secreted_signature, name = 'Secreted') %>% AddMetaData(object = seuratobj, metadata = .)
```
```{r}
genes_of_interest <- c('IL23A', 'IL23R', 'IL17A', 'IL17F', 'ZFP36', 'ZFP36L2', nonresponder_genes, il17_genes, il23_genes) %>% unique() 
```


### IL17 response in keratinocytes, fibroblasts, and APCs

```{r}
barcodes_visium <- visium_meta %>% 
  filter(merged_label %in% c('fibroblast', 'keratinocyte')) %>% 
  pull(rowname)


```

### IL23 signature extraction , APCs, and Trms
```{r}
barcodes <- meta %>% filter(condition %in% c('PV', 'HC', 'AD'),
                            treatment %in% c('Pre', 'Post', 'None'),
                            group %in% c('APC', 'Trm')) %>% 
  pull(rowname)


```

### Extract all expression data
```{r}
data_matrix_scrna <- FetchData(seuratobj,
                         cells = barcodes,
                         vars = c(genes_of_interest, 'IL17_signature', 'IL23_signature', 'IL23_strict', 'Secreted'))

data_matrix_visium <- FetchData(visiumobj,
                                cells = barcodes_visium,
                                vars = c(genes_of_interest, 'IL17_signature', 'IL23_signature', 'IL23_strict', 'Secreted'))

data_matrix <- bind_rows(data_matrix_scrna,
                         data_matrix_visium)

data_matrix %>% head()
```

```{r}
data_table <- 
  meta %>% select(rowname, id, sample, patient, condition, treatment, response, response_group, display, group) %>% 
  inner_join(data_matrix %>% rownames_to_column()) %>% 
  as_tibble()

data_table
```


```{r}
data_table_long <- data_table %>% 
  pivot_longer(cols = -c(rowname:group),
               names_to = 'gene',
               values_to = 'expression') 

data_table_long %>% head()
```
### Summarize by cluster and normalize (treatment patients only)
```{r}
data_table_long_tx_summarized <- 
  data_table_long %>% 
  filter(treatment %in% c('Pre', 'Post')) %>% 
  group_by(id, sample, patient, condition, group, display, treatment, response, response_group, gene) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(expression)) %>% 
  group_by(gene, group) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_tx_summarized
```

### Summarize by cluster and normalize across all
```{r}
data_table_long_all_summarized <- 
  data_table_long %>% 
  group_by(id, sample, patient, condition, group, display, treatment, response, response_group, gene) %>% 
  summarize(binary = mean(expression > 0),
            expression = mean(expression)) %>% 
  group_by(gene, group) %>% 
  mutate(max = max(expression),
         normalized = expression/max) 

data_table_long_all_summarized

```

### IL23A stack
```{r}
display_features <- c('APC IL23A',
                      'keratinocyte IL23A',
                      'fibroblast IL23A')

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(group, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

plot_input
```

```{r}
plot_input %>% 
  ggplot(aes(x = gene,
             y = expression,
             fill = group)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~treatment + display,
             nrow = 2) +
  theme_dwu(legend.position = 'top') +
  ggthemes::scale_fill_few() 
```
```{r}
plot_input %>% 
  ggplot(aes(x = gene,
             y = binary,
             fill = group)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~treatment + display,
             nrow = 2) +
  theme_dwu(legend.position = 'top') +
  ggthemes::scale_fill_few() 
```
### Full profile
```{r}
display_features <- c('APC IL23A',
                      'Trm IL23R',
                      paste('Trm', il23_genes),
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm ZFP36',
                      'Trm ZFP36L2',
                      'keratinocyte IL17_signature',
                      'keratinocyte IL17A',
                      'keratinocyte IL17F') %>% 
  unique()

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(group, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

plot_input
```


```{r fig.height=8, fig.width=4}
p <- plot_input %>% 
  ggplot(aes(x = feature,
             y = binary,
             fill = gene)) +
  geom_col() +
  facet_wrap(~display + treatment, nrow = 7) +
  theme_dwu() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = '% Cells Expressed',
       x = '') 

p
```
### Radar plot
```{r fig.height=10, fig.width=10}
display_features <- c('Trm IL23_signature',
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F')

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Post')) %>% 
  mutate(feature = paste(group, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Post')))
  
  
  response <- plot_input %>% filter(patient == which_patient) %>% pull(response_group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', response, ')'),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots()
radar_responders <- radar_plots[c(2, 3, 4, 7)] %>% patchwork::wrap_plots(ncol = 2)
radar_nonresponders <- radar_plots[c(1, 5, 6)] %>% patchwork::wrap_plots(ncol = 2)

radar_responders
```


```{r fig.height=10, fig.width=10}
radar_nonresponders
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       filename = 'radar_plot.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)

ggsave(plot = radar_responders,
       filename = 'radar_plot_responders.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)
```
### Radar IL23 strict set
```{r}

genes_to_use <- il23_genes_strict
display_features <- c(paste('Trm', genes_to_use))

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Post')) %>% 
  mutate(feature = paste(group, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, gene, normalized) %>% 
    pivot_wider(names_from = gene,
                values_from = normalized) %>% 
    select(treatment, genes_to_use) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Post')))
  
  
  response <- plot_input %>% filter(patient == which_patient) %>% pull(response_group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 1,
            group.point.size = 1,
            axis.label.offset = 1.1,
            group.line.width = 0.5,
            #grid.line.width = 0,
            gridline.max.linetype = 'solid',
            gridline.mid.linetype = 'solid',
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', response, ')'),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots()
radar_responders <- radar_plots[c(2, 3, 4, 7)] %>% patchwork::wrap_plots(ncol = 2)
radar_nonresponders <- radar_plots[c(1, 5, 6)] %>% patchwork::wrap_plots(ncol = 2)

radar_responders
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       filename = 'radar_plot_strict.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)

ggsave(plot = radar_responders,
       filename = 'radar_plot_responders_strict.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders_strict.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)
```

```{r fig.height=10, fig.width=10}
display_features <- c('Trm IL23_signature',
                      'APC IL23_signature',
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm IL26',
                      'APC IL26',
                      'Trm IL23A',
                      'APC IL23A',
                      'Trm IL23R',
                      'APC IL23R',
                      'Trm IFNG',
                      'APC IFNG')

plot_input <- data_table_long_tx_summarized %>% 
  filter(treatment %in% c('Pre', 'Post')) %>% 
  mutate(feature = paste(group, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))
  
radar_plots <- map(plot_input$patient %>% unique %>% sort, function(i) {
  which_patient <- i
  
  radar_input <- plot_input %>% 
    ungroup() %>% 
    filter(patient == which_patient) %>% 
    select(treatment, feature, normalized) %>% 
    pivot_wider(names_from = feature,
                values_from = normalized) %>% 
    select(treatment, display_features) %>% 
    mutate(treatment = factor(treatment, levels = c('Pre', 'Post')))
  
  
  response <- plot_input %>% filter(patient == which_patient) %>% pull(response_group) %>% unique()
  
  p_radar <- radar_input %>% 
    ggradar(legend.text.size = 8,
            grid.label.size = 0,
            axis.label.size = 2,
            group.point.size = 2,
            axis.label.offset = 1.1,
            group.line.width = 1,
            group.colours = c('dodgerblue4', 'orangered'),
            plot.title = paste0('Patient ', i, ' (', response, ')'),
            legend.position = 'top') +
    theme(plot.title = element_text(size = 9, hjust = 0.5),
          plot.background = element_rect(color = 'black'),
          #legend.box.background = element_rect(color = 'blue'),
          legend.key.height = unit(1, 'mm'),
          legend.spacing = unit(0, 'mm')) 
  
  p_radar
})
radar <- radar_plots %>% patchwork::wrap_plots()
radar_responders <- radar_plots[c(2, 3, 4, 7)] %>% patchwork::wrap_plots(ncol = 2)
radar_nonresponders <- radar_plots[c(1, 5, 6)] %>% patchwork::wrap_plots(ncol = 2)

radar_responders
```


```{r fig.height=10, fig.width=10}
radar_nonresponders
```
```{r}
w <- 8
h <-  7
ggsave(plot = radar,
       filename = 'radar_plot_custom.png',
       path = output_dir,
       height = 10,
       width = 10,
       dpi = 600)

ggsave(plot = radar_responders,
       filename = 'radar_plot_responders_custom.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)

ggsave(plot = radar_nonresponders,
       filename = 'radar_plot_nonresponders_custom.png',
       path = output_dir,
       height = h,
       width = w,
       dpi = 600)
```

### Stats
```{r}
data_table_long_all_summarized %>% 
  filter(gene == 'IL23_signature',
         group == 'Trm') %>% 
  ggplot(aes(x = condition,
             y = normalized,
             color = treatment)) +
  geom_sina() +
  theme_dwu(legend.position = 'right') +
  labs(y = 'Normalized Average Trm Expression')
```
```{r}

```
### Perfect separators of post-response
```{r}
perfect_separators <- data_table_long_tx_summarized %>% 
  filter(gene %in% nonresponder_genes,
         treatment == 'Post',
         group == 'Trm') %>% 
  select(group, response_group, gene, expression) %>% 
  group_by(response_group, group, gene) %>% 
  summarize(min = min(expression),
            max = max(expression)) %>% 
  pivot_wider(names_from = response_group,
              values_from = c(min, max)) %>% 
  filter(min_Nonresponder > max_Responder)

perfect_separators$gene %>% unique()
```

### IL23-responsive gene expression in post-treatment samples 
Strict
```{r}
p <- data_table_long_tx_summarized %>% 
  filter(gene %in% c(il23_genes_strict, 'IL17A', 'IL17F'),
         treatment == 'Post',
         group == 'Trm') %>% 
  ggplot(aes(x = reorder(gene, expression),
             y = expression,
             color = response_group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  #facet_wrap(~gene, scales = 'free_x') +
  theme_dwu(legend.position = 'top') +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  geom_jitter(alpha = 0.8, size = 2) +
  coord_flip() +
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_post_separators_strict.pdf',
       path = output_dir,
       h = 14,
       w = 6)

p

```
Full
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes, 'IL17A', 'IL17F'),
         treatment == 'Post',
         group == 'Trm') %>% 
  ggplot(aes(x = reorder(gene, expression),
             y = expression,
             color = response_group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_sina(alpha = 0.8, size = 2) +
  #facet_wrap(~gene, scales = 'free_x') +
  theme_dwu(legend.position = 'top') +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  coord_flip() +
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_post_separators_full.pdf',
       path = output_dir,
       h = 44,
       w = 6)

p
```
### Facets
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes, 'IL17A', 'IL17F'),
         treatment == 'Post',
         group == 'Trm') %>% 
  ggplot(aes(x = response_group,
             y = expression,
             color = response_group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_point(alpha = 0.8, size = 2, aes(color = patient)) +
  facet_wrap(~gene, scales = 'free_y', ncol = 15) +
  theme_dwu(legend.position = 'top') +
  rcartocolor::scale_color_carto_d() +
  #scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_post_separators_facet_full.pdf',
       path = output_dir,
       h = 30,
       w = 17)
```

```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% c(il23_genes_strict, 'IL17A', 'IL17F'),
         treatment == 'Post',
         group == 'Trm') %>% 
  ggplot(aes(x = response_group,
             y = expression,
             color = response_group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', fill = 'grey90') +
  geom_point(alpha = 0.8, size = 2, aes(color = patient)) +
  facet_wrap(~gene, scales = 'free_y', ncol = 10) +
  theme_dwu(legend.position = 'top') +
  #scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  rcartocolor::scale_color_carto_d(palette = 'Prism') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(x = '',
       y = 'Trm Average Expression')

ggsave(plot = p,
       filename = 'bar_post_separators_facet_strict.pdf',
       path = output_dir,
       h = 14,
       w = 12)
```




#### Secretion
```{r}
p <- data_table_long_tx_summarized %>% 
  
  filter(gene %in% 'Secreted',
         treatment == 'Post',
         group == 'Trm') %>% 
  ggplot(aes(x = reorder(patient, -expression),
             y = expression,
             fill = response_group)) +
  #geom_boxplot(outlier.color = NA) +
  geom_bar(stat = 'summary', position = 'dodge', color = 'black') +
  theme_dwu(legend.position = 'top') +
  #rcartocolor::scale_color_carto_d(palette = 'Prism') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4')) +
  labs(x = 'Patient',
       y = 'Trm Average Expression',
       title = 'Secreted Gene Signature')

p
```
### Statistics
```{r}

```


### PV, AD, HC
```{r fig.height=6, fig.width=12}
display_features <- c('APC IL23A',
                      'Trm IL23R',
                      paste('Trm', il23_genes),
                      'Trm IL17A',
                      'Trm IL17F',
                      'APC IL17A',
                      'APC IL17F',
                      'Trm ZFP36',
                      'Trm ZFP36L2') %>% 
  unique()

plot_input <- data_table_long_tx_summarized %>% 
  mutate(feature = paste(group, gene)) %>% 
  filter(feature %in% display_features) %>% 
  mutate(feature = factor(feature, levels = display_features))

p <- plot_input %>% 
  ggplot(aes(x = feature,
             y = normalized,
             fill = condition)) +
  geom_boxplot()+
  theme_dwu(legend.position = 'top') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = 'Normalized Expression',
       x = '') +
  ggthemes::scale_fill_few()

p
```


## Session Info
```{r}
sessionInfo()
```



