---
title: "Secukinumab"
author: "David Wu"
---

Set working directory to project directory
```{r setup}
library(here)
```

### Optionally convert this Rmd to R script 
```{r eval=FALSE, message=FALSE}
current_file <- rstudioapi::getActiveDocumentContext()$path
output_file <- stringr::str_replace(current_file, '.Rmd', '.R')
knitr::purl(current_file, output = output_file)
file.edit(output_file)
```

### Directories
```{r, message=FALSE}
output_dir <- 'analysis/output/secukinumab' # analysis file output directory
data_dir <- 'data/derived/tildra' # data file output directory

dir.create(output_dir, showWarnings = FALSE)
dir.create(data_dir, showWarnings = FALSE)
```

### Loading the libraries
```{r, message=FALSE}
library(Seurat) 
library(tidyverse)
library(ggExtra)
library(ggthemes)
library(ggforce)
#library(SeuratWrappers) # devtools::install_github('satijalab/seurat-wrappers')
library(wutilities) # devtools::install_github('symbiologist/wutilities')
library(tictoc)
library(rcartocolor)
library(ggrepel)
library(rtracklayer)
library(plyranges)
theme_set(theme_dwu()) # set default theme

```

### Functions
```{r}
extract_expression <- function(seuratobj,
                               cells = NULL,
                               genes,
                               normalize = TRUE,
                               log = FALSE,
                               assay = 'RNA',
                               slot = 'counts') {
  
  data_subset <- FetchData(object = seuratobj, 
                           cells = cells,
                           vars = genes,
                           assay = assay,
                           slot = slot) %>% 
    rownames_to_column() %>% 
    pivot_longer(cols = -rowname,
                 names_to = 'gene',
                 values_to = 'counts')
  
  total_count <- colSums(GetAssayData(seuratobj, 
                                        slot = slot, 
                                        assay = assay))
  
  if(!is.null(cells)) {
    total_count <- total_count[cells]
  }
  
  data_subset <- data_subset %>% 
    left_join(data.frame('total' = total_count) %>% rownames_to_column(), by = 'rowname')
  
  if(normalize) {
   data_subset <- data_subset %>% 
      mutate(cpm = 1e6 * counts / total) 
  }
  
  data_subset
  
}

pseudobulk <- function(seuratobj,
                       genes,
                       cells = NULL,
                       group_by = 'ident',
                       pseudocount = 1,
                       rounding = 3,
                       assay = 'RNA',
                       slot = 'count') {
  
  metadata_groups <- FetchData(seuratobj, vars = group_by, cells = cells) %>% rownames_to_column()
  
  expression <- extract_expression(seuratobj,
                                   genes = genes,
                                   cells = cells,
                                   normalize = FALSE,
                                   log = FALSE,
                                   assay = assay,
                                   slot = slot) %>% 
    left_join(metadata_groups, by = 'rowname')
  
  totals <- expression %>% 
    select(rowname, total, all_of(group_by)) %>% 
    unique() %>% 
    group_by(across(all_of(group_by))) %>% 
    summarize(total = sum(total))
  
  merged <- expression %>% 
    group_by(across(all_of(c('gene', group_by)))) %>% 
    summarize(counts = sum(counts)) %>% 
    ungroup() %>% 
    left_join(totals) %>% 
    mutate(cpm = counts/total * 1e6,
           log10cpm = log10(cpm + pseudocount))
  
  merged %>% mutate(across(contains('cpm'), round, rounding))
  
}
```

### Data from Liu et al. https://www.jidinnovations.org/article/S2667-0267(21)00096-5/fulltext#secsectitle0065
GEO link: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE171012
```{r}
secu <- read_tsv(here('analysis/input/GSE171012_CountData_SecukinumabPsoRnaSeq_20210324.tsv.gz'))

secu
```

```{r}
load(here('data/external/20180706_Novartis062518_FilteringAndQC/RObj-CountAndAnnoTables_Novartis062518_20190624.rdata'))
```

```{r}
anno.n062518
```

```{r}
anno.n062518.final
```

### Gene signature
```{r}
ray_genes <- c("IL17F", "GNLY", "LRRN3", "MGAT4A", "CHN1", "CTSH", "PTPN13", "GZMB", "ADGRG1", "SOX4", "GABPB1-AS1", "SNX9", "CD7", "CPM", "CTLA4", "ODF2L", "CBLB", "LAYN", "TNFAIP3", "ARHGEF12", "H1FX", "HIST1H1E", "YPEL2", "GBP5", "DAPK2", "RAP1B", "CXCL13", "FYN")
```

## Data processing
```{r}
annotation <- import(here('data/external/liu_secukinumab/gencode.v25.annotation.gtf.gz'))
ens2symbol <- annotation@elementMetadata %>% as_tibble() %>% filter(type == 'gene') %>% select(gene_id, gene_name) %>% unique()
```

```{r}
counts <- counttable.n062518
metadata <- anno.n062518 %>% rownames_to_column('sample') %>% 
  mutate(Response = case_when(
    str_detect(PatientOutcome.Week52,'PASI75|PASI100') ~ 'Responder',
    str_detect(PatientOutcome.Week52,'PASI50|limited') ~ 'Non-responder',
  ))

```
```{r}
metadata %>% 
  select(SubjectId, WeekGroup, Week, CellType, Status) %>% 
  summarize_all(n_distinct)
```

### Subjects with PSO at Week 0 and 12
```{r}
metadata_subset <- metadata %>% 
  filter(QC_Passed,
         Week %in% c(0, 12),
         Status == 'PSO') %>% 
  select(sample, SubjectId, Week, CellType, PASI, PASI.Reduction.Week0_Week52, PatientOutcome.Week52, Response) %>% 
  group_by(SubjectId) %>% 
  add_count() %>% 
  arrange(SubjectId, Week, CellType)

metadata_subset
```

### Normalize
```{r}
tpm <- t(t(counts) / colSums(counts)) * 1e6
```


```{r}
logtpm <- log10(tpm + 0.01)
```

```{r}
gene_id_subset <- ens2symbol %>% filter(gene_name %in% ray_genes)
```

```{r}
gene_subset <- tpm[gene_id_subset$gene_id, ] %>% as.data.frame() %>% rownames_to_column('gene_id') %>% inner_join(gene_id_subset) %>% select(gene_id, gene_name, everything())
gene_subset
```

```{r}
expression_table_long <- gene_subset %>% 
  pivot_longer(cols = -starts_with('gene'),
               names_to = 'sample',
               values_to = 'expression') %>% 
  inner_join(metadata_subset) %>% 
  mutate(Treatment = factor(ifelse(Week == 0, 'Pre', 'Mid'), levels = c('Pre', 'Mid'))) %>% 
  select(-sample, -n) %>% 
  arrange(SubjectId)

expression_table_long
```
```{r}
expression_table_wide <- 
  expression_table_long %>% 
  select(SubjectId, CellType, gene_name, Treatment, expression, PatientOutcome.Week52, Response) %>% 
  pivot_wider(names_from = Treatment,
              values_from = expression) %>% 
  drop_na() %>% 
  arrange(SubjectId)
  
expression_table_wide
```

```{r}
plot_dir <- file.path(output_dir, 'waterfall')
dir.create(output_dir, showWarnings = FALSE)

waterfall_plots <- map(expression_table_long$SubjectId %>% unique(), function(i) {
  
  table_subset <- expression_table_long %>% 
    filter(SubjectId == i)
  response <- table_subset$Response %>% unique()
  pasi_week0 <- table_subset %>% filter(Treatment == 'Pre') %>% pull(PASI) %>% unique()
  pasi_week12 <- table_subset %>% filter(Treatment == 'Mid') %>% pull(PASI) %>% unique()
    
  p <- table_subset %>%  
   ggplot(aes(x = reorder(gene_name, -expression),
             y = expression,
             color = Treatment,
             group = gene_name)) +
  geom_point(size = 3) +
  geom_line(color = 'grey50', arrow = arrow(length = unit(0.2, "cm"), type = 'closed')) +
  theme_dwu(legend.position = 'top') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  #geom_point(size = 2, data = summarized_table %>% filter(treatment == 'Healthy'), inherit.aes = FALSE, aes(x = reorder(gene, -mean), y = mean)) +
  facet_wrap(~CellType, scales = 'free_y', nrow = 2) +
  labs(
    title = paste0('Patient ', i, ': ', response),
    subtitle = paste0('PASI week 0 = ', pasi_week0, ', week 12 = ', pasi_week12),
    x = '',
    y = 'log10 TPM expression')
  
  ggsave(plot = p,
         filename = paste0(response, '_', i, '.png'),
         path = plot_dir,
         h = 8,
         w = 10,
         dpi = 150)
  
  p

})
  
```

### Grouped analysis
```{r}
celltypes <- expression_table_long$CellType %>% unique() %>% sort()


boxplots <- map(celltypes, function(i) {

  expression_table_long %>% 
    filter(CellType == i) %>% 
    mutate(Response = factor(Response, levels = c('Responder', 'Non-responder'))) %>% 
  ggplot(aes(x = Response,
             y = expression,
             fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  facet_wrap(~gene_name, nrow = 2, scales = 'free_y') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4')) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  theme(legend.position = 'top') +
  labs(title = i,
       x = '',
       y = 'Transcripts per million') 
})

boxplots

  
```



### Tildra data
```{r}
seuratobj <- read_rds(here(data_dir, 'seuratobj_annotated.rds'))
```

### Use global or local identities and set as cluster/supercluster in the object
```{r}
which_identity <- 'global'
which_cluster <- paste0(which_identity, '_cluster')
which_supercluster <- paste0(which_identity, '_supercluster')

seuratobj$cluster <- seuratobj[[which_cluster]] # set cluster as main annotation
seuratobj$supercluster <- seuratobj[[which_supercluster]] # set cluster as main annotation
Idents(seuratobj) <- 'cluster'

output_dir <- here(output_dir, which_identity)
dir.create(output_dir)
```

### Analysis
```{r}
metadata <- seuratobj@meta.data %>% rownames_to_column() 
de_combined_cluster <- read_tsv(here('analysis/output/08_de/', which_cluster, 'de_combined.tsv.gz'))
de_combined_supercluster <- read_tsv(here('analysis/output/08_de/', which_supercluster, 'de_combined.tsv.gz'))
de_pre_vs_mid_response <- bind_rows(
  read_tsv(here('analysis/output/08_de', which_cluster, 'de_pre_vs_mid_responder.tsv.gz')) %>% 
    mutate(response = 'Responder'),
  read_tsv(here('analysis/output/08_de', which_cluster, 'de_pre_vs_mid_nonresponder.tsv.gz')) %>% 
    mutate(response = 'Non-responder'))

il23_group_response <- de_pre_vs_mid_response %>% 
  filter(p_val_adj < 0.05,
         avg_log2FC > 0,
         response == 'Responder') 

il23_group_response
```
### Genes that respond in Tildra treatment but NOT IL17 treatment
#### IL17 de
```{r}
metadata_subset
```

```{r}
library(DESeq2)

il17_de <- map(c('Teff', 'CD8'), function(i) {
  
  sample_subset <- metadata_subset %>% 
    filter(Week %in% c(0, 12),
           CellType == i)

  deseq <- DESeqDataSetFromMatrix(countData = counts[, sample_subset$sample],
                                colData = sample_subset %>% column_to_rownames('sample'), 
                                design = ~Week)
  
  deseq$time <- relevel(deseq$Week, ref = '0')
  
  tic()
  deseq <- DESeq(deseq)
  toc()
  
  deseq_res <- results(deseq, tidy = TRUE) %>% as_tibble() %>% left_join(ens2symbol, by = c('row' = 'gene_id')) %>% 
    mutate(across(is.numeric, round, 3), 
           celltype = i) %>% 
    select(celltype, gene_name, gene_id = row, baseMean, log2FoldChange, pvalue, padj) 
  
})

```

```{r}
il17_de
```

```{r}
il17_persistent <- il17_de %>% filter(padj > 0.05) %>% group_by(celltype) %>% slice_max(padj, n = 1000)
```

```{r}
il23_responsive <- il23_group_response %>% filter(cluster == 'Trm1')
```

```{r}
persistent_gene_signature <- il23_responsive %>% pull(gene) %>% intersect(il17_persistent %>% pull(gene_name))

persistent_gene_signature_ensembl <- ens2symbol %>% 
  filter(gene_name %in% persistent_gene_signature) %>% 
  pull(gene_id)

persistent_gene_signature


```
### Box plot
Equivalent cell clusters in main object
```{r}
# Tregs
tildra_treg <- seuratobj@meta.data %>% filter(str_detect(supercluster,'Treg')) %>% rownames()
tildra_treg %>% length()
```


```{r}
# CD8 equivalent: cells with high CD8 RNA or protein
cd_data <- FetchData(seuratobj, 
                     vars = c('CD4', 'CD8A', 'CD8B', 'ADT.CD4', 'ADT.CD8', 'supercluster', 'celltype', 'treatment')) %>% 
  rownames_to_column() %>% 
  mutate(ADT = case_when(
    ADT.CD4 == 'Positive' & ADT.CD8 == 'Positive' ~ 'Double-positive',
    ADT.CD4 == 'Positive' ~ 'CD4',
    ADT.CD8 == 'Positive' ~ 'CD8',
    TRUE ~ 'Double-negative'
  ))
```

## overall cd8
```{r}
p <- cd_data %>% 
  ggplot(aes(x = CD8A,
             y = CD8B,
             color = ADT)) +
  geom_point(alpha = 0.1,
             size = 0.5) +
  facet_wrap(~ADT)

p
```
#### CD4
```{r}
p <- cd_data %>% 
  ggplot(aes(x = CD4,
             y = CD8A,
             color = ADT)) +
  geom_point(alpha = 0.1,
             size = 0.5) +
  facet_wrap(~ADT)

p
```
### Treg vs other T cells
```{r}
p <- cd_data %>% 
  filter(celltype == 'Lymphocyte',
         str_detect(supercluster, 'T')) %>% 
  ggplot(aes(x = CD8A,
             y = CD8B,
             color = ADT)) +
  geom_point(alpha = 0.1,
             size = 0.5) +
  facet_wrap(~supercluster)

p
```
#### Classify CD4/8 status based on protein then RNA
```{r}
cd_status <- cd_data %>% 
  mutate(CD = case_when(
    ADT == 'Double-positive' ~ 'Unknown',
    ADT == 'CD4' ~ 'CD4',
    ADT == 'CD8' ~ 'CD8',
    CD4 > 0.1 & (CD8A < 0.1 & CD8B < 0.1) ~ 'CD4',
    (CD8A > 0.1 | CD8B > 0.1) & CD4 < 0.1 ~ 'CD8',
    TRUE ~ 'Unknown'
  ))

cd_status$CD %>% table()
```

```{r}
tildra_cd4 <- cd_status %>% filter(CD == 'CD4', !str_detect(supercluster, 'Treg'), treatment %in% c('Pre', 'Mid'))
tildra_cd8 <- cd_status %>% filter(CD == 'CD8', !str_detect(supercluster, 'Treg'), treatment %in% c('Pre', 'Mid'))

tildra_barcodes <- c(tildra_cd4$rowname, tildra_cd8$rowname)
```

```{r}
add_cd <- seuratobj@meta.data %>% rownames_to_column() %>% left_join(cd_status %>% select(rowname, CD))
seuratobj$CD <- add_cd$CD
pseudo <- pseudobulk(seuratobj,
                     cells = tildra_barcodes,
                     genes = persistent_gene_signature,
                     group_by = c('id', 'CD')) %>% 
  left_join(metadata %>% select(id, patient, treatment, group, sample_label, patient_label) %>% unique()) 

pseudo 
```

```{r}
gene_subset <- tpm[persistent_gene_signature_ensembl, ] %>% as.data.frame() %>% rownames_to_column('gene_id') %>% inner_join(ens2symbol %>% select(gene_id, gene_name)) %>% select(gene_id, gene_name, everything())
gene_subset
```

```{r}
expression_table_long <- gene_subset %>% 
  pivot_longer(cols = -starts_with('gene'),
               names_to = 'sample',
               values_to = 'expression') %>% 
  inner_join(metadata_subset) %>% 
  mutate(Treatment = factor(ifelse(Week == 0, 'Pre', 'Mid'), levels = c('Pre', 'Mid'))) %>% 
  select(-sample, -n) %>% 
  arrange(SubjectId)

expression_table_long
```
```{r}
expression_table_wide <- 
  expression_table_long %>% 
  select(SubjectId, CellType, gene_name, Treatment, expression, PatientOutcome.Week52, Response) %>% 
  pivot_wider(names_from = Treatment,
              values_from = expression) %>% 
  drop_na() %>% 
  arrange(SubjectId)
  
expression_table_wide
```
### Visualize
```{r}
p_23 <- pseudo %>% 
  filter(cluster == 'Trm1') %>% 
  ggplot(aes(x = treatment,
             y = cpm)) +
  geom_boxplot() +
  facet_wrap(~gene, scales = 'free_y')



p_23
```
```{r}
p_17 <- expression_table_long %>% 
  ggplot(aes(x = Week,
             y = expression)) +
  geom_boxplot() +
  facet_wrap(~gene_name, scales = 'free_y')

p_17
  
```




## OLD
### Extract expression
```{r}
genes_to_extract <- ray_genes %>% unique()

metadata_subset <- meta %>% 
  mutate(treatment = ifelse(treatment == 'None', 'Healthy', treatment),
         treatment = factor(treatment, levels = c('Pre', 'Mid', 'Healthy')))

patient_matrix <- map(metadata_subset$id %>% unique() %>% set_names(.), function(i) {
  
  patient_cells <- metadata_subset %>% filter(id == i) %>% pull(rowname)
  patient_counts <- rowSums(seuratobj@assays$RNA@counts[,patient_cells])
  
  
  patient_counts
}) %>% do.call(cbind, .)
```


```{r}
tpm <- t(t(patient_matrix) / colSums(patient_matrix)) * 1e6
```

###
```{r}
gene_subset <- tpm[genes_to_extract, ] %>% as.data.frame() %>% rownames_to_column('gene_name')
gene_subset
```

```{r}
expression_table_long <- gene_subset %>% 
  pivot_longer(cols = -starts_with('gene'),
               names_to = 'id',
               values_to = 'expression') %>% 
  inner_join(metadata_subset %>% select(id, patient, treatment, response_group) %>% unique()) 
  
  
expression_table_long
```
```{r}
expression_table_wide <- 
  expression_table_long %>% 
  select(SubjectId, CellType, gene_name, Treatment, expression, PatientOutcome.Week52, Response) %>% 
  pivot_wider(names_from = Treatment,
              values_from = expression) %>% 
  drop_na() 
  
expression_table_wide
```

```{r}
plot_dir <- file.path(output_dir, 'waterfall')
dir.create(output_dir, showWarnings = FALSE)

waterfall_plots <- map(expression_table_long$SubjectId %>% unique(), function(i) {
  
  table_subset <- expression_table_long %>% 
    filter(SubjectId == i)
  response <- table_subset$Response %>% unique()
  pasi_week0 <- table_subset %>% filter(Treatment == 'Pre') %>% pull(PASI) %>% unique()
  pasi_week12 <- table_subset %>% filter(Treatment == 'Mid') %>% pull(PASI) %>% unique()
    
  p <- table_subset %>%  
   ggplot(aes(x = reorder(gene_name, -expression),
             y = expression,
             color = Treatment,
             group = gene_name)) +
  geom_point(size = 3) +
  geom_line(color = 'grey50', arrow = arrow(length = unit(0.2, "cm"), type = 'closed')) +
  theme_dwu(legend.position = 'top') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  scale_color_manual(values = c('orangered', 'dodgerblue4')) +
  #geom_point(size = 2, data = summarized_table %>% filter(treatment == 'Healthy'), inherit.aes = FALSE, aes(x = reorder(gene, -mean), y = mean)) +
  facet_wrap(~CellType, scales = 'free_y', nrow = 2) +
  labs(
    title = paste0('Patient ', i, ': ', response),
    subtitle = paste0('PASI week 0 = ', pasi_week0, ', week 12 = ', pasi_week12),
    x = '',
    y = 'log10 TPM expression')
  
  ggsave(plot = p,
         filename = paste0(response, '_', i, '.png'),
         path = plot_dir,
         h = 8,
         w = 10,
         dpi = 150)
  
  p

})
  
```

### Grouped analysis
```{r}





  p <- expression_table_long %>% 
    filter(treatment != 'Healthy') %>% 
    mutate(response_group = factor(response_group, levels = c('Responder', 'Non-responder'))) %>% 
  ggplot(aes(x = response_group,
             y = expression,
             fill = treatment)) +
  geom_boxplot(alpha = 0.5) +
  facet_wrap(~gene_name, nrow = 2, scales = 'free_y') +
  scale_fill_manual(values = c('orangered', 'dodgerblue4', 'grey50')) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5)) +
  theme(legend.position = 'top') +
    labs(x = '',
         y = 'Transcripts per million',
         title = 'tildra')
  
  p




  
```

## Session Info
```{r}
sessionInfo()
```



